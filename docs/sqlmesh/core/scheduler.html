<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.3.0"/>
    <title>sqlmesh.core.scheduler API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../core.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;sqlmesh.core</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#Scheduler">Scheduler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Scheduler.__init__">Scheduler</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.batches">batches</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.evaluate">evaluate</a>
                        </li>
                        <li>
                                <a class="function" href="#Scheduler.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#compute_interval_params">compute_interval_params</a>
            </li>
            <li>
                    <a class="function" href="#start_date">start_date</a>
            </li>
            <li>
                    <a class="function" href="#earliest_start_date">earliest_start_date</a>
            </li>
    </ul>


            <footer>Copyright Tobiko Data Inc. 2022</footer>

        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/TobikoData/sqlmesh/core/scheduler.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../../sqlmesh.html">sqlmesh</a><wbr>.<a href="./../core.html">core</a><wbr>.scheduler    </h1>

                
                        <input id="mod-scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-scheduler-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.console</span> <span class="kn">import</span> <span class="n">Console</span><span class="p">,</span> <span class="n">get_console</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.snapshot</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>    <span class="n">Snapshot</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>    <span class="n">SnapshotEvaluator</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>    <span class="n">SnapshotId</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>    <span class="n">SnapshotIdLike</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="p">)</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.state_sync</span> <span class="kn">import</span> <span class="n">StateSync</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils</span> <span class="kn">import</span> <span class="n">format_exception</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.concurrency</span> <span class="kn">import</span> <span class="n">concurrent_apply_to_dag</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.dag</span> <span class="kn">import</span> <span class="n">DAG</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.date</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>    <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="n">now</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>    <span class="n">to_datetime</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>    <span class="n">validate_date_range</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>    <span class="n">yesterday</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="n">Interval</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="n">Batch</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Interval</span><span class="p">]</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="n">SnapshotToBatches</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">,</span> <span class="n">Batch</span><span class="p">]</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="n">SchedulingUnit</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">,</span> <span class="n">Interval</span><span class="p">]</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">:</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Schedules and manages the evaluation of snapshots.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    The scheduler evaluates multiple snapshots with date intervals in the correct</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    topological order. It consults the state sync to understand what intervals for each</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">    snapshot needs to be backfilled.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">    The scheduler comes equipped with a simple ThreadPoolExecutor based evaluation engine.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">    Args:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        snapshots: A collection of snapshots.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        snapshot_evaluator: The snapshot evaluator to execute queries.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        state_sync: The state sync to pull saved snapshots.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        max_workers: The maximum number of parallel queries to run.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        console: The rich instance used for printing scheduling information.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="n">snapshot_evaluator</span><span class="p">:</span> <span class="n">SnapshotEvaluator</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">StateSync</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="p">):</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">}</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span> <span class="o">=</span> <span class="n">_resolve_one_snapshot_per_version</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">snapshot_evaluator</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span> <span class="n">Console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="k">def</span> <span class="nf">batches</span><span class="p">(</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of snapshot batches to evaluate.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        Args:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_params</span><span class="p">(</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="n">snapshot</span><span class="p">:</span> <span class="n">Snapshot</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a snapshot and add the processed interval to the state sync.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">            snapshot: Snapshot to evaluate.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">            start: The start datetime to render.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">            end: The end datetime to render.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">            kwargs: Additional kwargs to pass to the renderer.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">p_sid</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span><span class="p">},</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">snapshot</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="p">}</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>            <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">add_interval</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">update_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Concurrently runs all snapshots in topological order.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        Args:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        Returns:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">            True if the execution was successful and False otherwise.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">now</span><span class="p">()</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">sorted</span><span class="p">():</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="k">if</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                <span class="k">continue</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>            <span class="n">intervals</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">start_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">))</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">def</span> <span class="nf">evaluate_node</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SchedulingUnit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="k">assert</span> <span class="n">latest</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            <span class="n">snapshot</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">concurrent_context</span><span class="p">():</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="n">errors</span><span class="p">,</span> <span class="n">skipped_intervals</span> <span class="o">=</span> <span class="n">concurrent_apply_to_dag</span><span class="p">(</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>                <span class="n">dag</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>                <span class="n">evaluate_node</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">,</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>                <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">stop_snapshot_progress</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="ow">not</span> <span class="n">errors</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            <span class="n">sid</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="n">formatted_exception</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">format_exception</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">or</span> <span class="n">error</span><span class="p">))</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILED processing snapshot </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">formatted_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">skipped_snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skipped_intervals</span><span class="p">}</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="k">for</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">skipped_snapshots</span><span class="p">:</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SKIPPED snapshot </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="k">return</span> <span class="ow">not</span> <span class="n">errors</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="nf">_interval_params</span><span class="p">(</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the optimal date interval paramaters based on what needs processing and maximal batch size.</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        For each model name, find all dependencies and look for a stored snapshot from the metastore. If a snapshot is found,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">        calculate the missing intervals that need to be processed given the passed in start and end intervals.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        If a snapshot&#39;s model specifies a batch size, consecutive intervals are merged into batches of a size that is less than</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">        or equal to the configured one. If no batch size is specified, then it uses the intervals that correspond to the model&#39;s cron expression.</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">        For example, if a model is supposed to run daily and has 70 days to backfill with a batch size set to 30, there would be 2 jobs</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">        with 30 days and 1 job with 10.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        Args:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">            snapshots: The list of snapshots.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">            start: Start of the interval.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">            end: End of the interval.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        Returns:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a><span class="sd">            A list of tuples containing all snapshots needing to be run with their associated interval params.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="n">all_snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="c1"># When in development mode only consider intervals of the current forward-only snapshot and ignore</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>        <span class="c1"># intervals of all snapshots with the same version that came before it.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="n">same_version_snapshots</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snapshots</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_forward_only</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_paused</span><span class="p">]</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">is_dev</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>            <span class="k">else</span> <span class="n">snapshots</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="n">stored_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_snapshots_with_same_version</span><span class="p">(</span><span class="n">same_version_snapshots</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="n">all_snapshots</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stored_snapshots</span><span class="p">})</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="n">compute_interval_params</span><span class="p">(</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">all_snapshots</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span> <span class="ow">or</span> <span class="n">earliest_start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">),</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span> <span class="ow">or</span> <span class="n">now</span><span class="p">(),</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span> <span class="ow">or</span> <span class="n">now</span><span class="p">(),</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>    <span class="k">def</span> <span class="nf">_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">SnapshotToBatches</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DAG</span><span class="p">[</span><span class="n">SchedulingUnit</span><span class="p">]:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds a DAG of snapshot intervals to be evaluated.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">        Args:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            batches: The batches of snapshots and intervals to evaluate.</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">            A DAG of snapshot intervals to be evaluated.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">intervals_per_snapshot_version</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version_get_or_generate</span><span class="p">()):</span> <span class="n">intervals</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="p">}</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>        <span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">[</span><span class="n">SchedulingUnit</span><span class="p">]()</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                <span class="k">continue</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="n">upstream_dependencies</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">],</span> <span class="n">interval</span><span class="p">)</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                <span class="k">for</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                <span class="k">if</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals_per_snapshot_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    <span class="p">(</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span><span class="o">.</span><span class="n">version_get_or_generate</span><span class="p">(),</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                    <span class="p">),</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                    <span class="p">[],</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="p">]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">interval</span><span class="p">),</span> <span class="n">upstream_dependencies</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">is_incremental_by_unique_key_kind</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                    <span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                        <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">interval</span><span class="p">),</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                        <span class="p">[(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">_interval</span><span class="p">)</span> <span class="k">for</span> <span class="n">_interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[:</span><span class="n">i</span><span class="p">]],</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                    <span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">return</span> <span class="n">dag</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="k">def</span> <span class="nf">compute_interval_params</span><span class="p">(</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="n">target</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SnapshotIdLike</span><span class="p">],</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">SnapshotId</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">],</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>    <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>    <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the optimal date interval paramaters based on what needs processing and maximal batch size.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">    For each model name, find all dependencies and look for a stored snapshot from the metastore. If a snapshot is found,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">    calculate the missing intervals that need to be processed given the passed in start and end intervals.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">    If a snapshot&#39;s model specifies a batch size, consecutive intervals are merged into batches of a size that is less than</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">    or equal to the configured one. If no batch size is specified, then it uses the intervals that correspond to the model&#39;s cron expression.</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">    For example, if a model is supposed to run daily and has 70 days to backfill with a batch size set to 30, there would be 2 jobs</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">    with 30 days and 1 job with 10.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">    Args:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a><span class="sd">        target: A set of target snapshots for which intervals should be computed.</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        snapshots: A catalog of all available snapshots (including the target ones).</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        start: Start of the interval.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        end: End of the interval.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a><span class="sd">    Returns:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a><span class="sd">        A dict containing all snapshots needing to be run with their associated interval params.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="n">snapshots_to_batches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">Snapshot</span><span class="o">.</span><span class="n">merge_snapshots</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="n">model_start_dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_date</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="n">snapshots_to_batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="p">(</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">missing_intervals</span><span class="p">(</span><span class="n">model_start_dt</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="p">]</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>    <span class="k">return</span> <span class="n">_batched_intervals</span><span class="p">(</span><span class="n">snapshots_to_batches</span><span class="p">)</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a><span class="k">def</span> <span class="nf">start_date</span><span class="p">(</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="n">snapshot</span><span class="p">:</span> <span class="n">Snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">SnapshotId</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]</span> <span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the effective/inferred start date for a snapshot.</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="sd">    Not all snapshots define a start date. In those cases, the model&#39;s start date</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a><span class="sd">    can be inferred from its parent&#39;s start date.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">    Args:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        snapshot: snapshot to infer start date.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        snapshots: a catalog of available snapshots.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">    Returns:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="sd">        Start datetime object.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="k">return</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">}</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="n">earliest</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>            <span class="k">continue</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="n">parent</span><span class="p">],</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">earliest</span><span class="p">:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>            <span class="n">earliest</span> <span class="o">=</span> <span class="n">start_dt</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="k">elif</span> <span class="n">start_dt</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>            <span class="n">earliest</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">earliest</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="k">return</span> <span class="n">earliest</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="k">def</span> <span class="nf">earliest_start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the earliest start date from a collection of snapshots.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">    Args:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        snapshots: Snapshots to find earliest start date.</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">    Returns:</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">        The earliest start date or yesterday if none is found.&quot;&quot;&quot;</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="n">snapshots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">if</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_date</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">)</span> <span class="ow">or</span> <span class="n">yesterday</span><span class="p">()</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>    <span class="k">return</span> <span class="n">yesterday</span><span class="p">()</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a><span class="k">def</span> <span class="nf">_batched_intervals</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">SnapshotToBatches</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>    <span class="n">batches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>    <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">batch_size</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="n">batches_for_snapshot</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">next_batch</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">batch_size</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_batch</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                <span class="n">next_batch</span> <span class="ow">and</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">next_batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>                <span class="n">batches_for_snapshot</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">next_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>                <span class="n">next_batch</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>            <span class="n">next_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="k">if</span> <span class="n">next_batch</span><span class="p">:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="n">batches_for_snapshot</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">next_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_batch</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span> <span class="o">=</span> <span class="n">batches_for_snapshot</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="k">return</span> <span class="n">batches</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="k">def</span> <span class="nf">_resolve_one_snapshot_per_version</span><span class="p">(</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Snapshot</span><span class="p">]:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>    <span class="n">snapshot_per_version</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">Snapshot</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version_get_or_generate</span><span class="p">())</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshot_per_version</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">snapshot_per_version</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="n">prev_snapshot</span> <span class="o">=</span> <span class="n">snapshot_per_version</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">unpaused_ts</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="ow">not</span> <span class="n">prev_snapshot</span><span class="o">.</span><span class="n">unpaused_ts</span> <span class="ow">or</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">created_ts</span> <span class="o">&gt;</span> <span class="n">prev_snapshot</span><span class="o">.</span><span class="n">created_ts</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="p">):</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>                <span class="n">snapshot_per_version</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="k">return</span> <span class="n">snapshot_per_version</span>
</span></pre></div>


            </section>
                <section id="Scheduler">
                            <input id="Scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Scheduler</span>:

                <label class="view-source-button" for="Scheduler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler-34"><a href="#Scheduler-34"><span class="linenos"> 34</span></a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">:</span>
</span><span id="Scheduler-35"><a href="#Scheduler-35"><span class="linenos"> 35</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Schedules and manages the evaluation of snapshots.</span>
</span><span id="Scheduler-36"><a href="#Scheduler-36"><span class="linenos"> 36</span></a>
</span><span id="Scheduler-37"><a href="#Scheduler-37"><span class="linenos"> 37</span></a><span class="sd">    The scheduler evaluates multiple snapshots with date intervals in the correct</span>
</span><span id="Scheduler-38"><a href="#Scheduler-38"><span class="linenos"> 38</span></a><span class="sd">    topological order. It consults the state sync to understand what intervals for each</span>
</span><span id="Scheduler-39"><a href="#Scheduler-39"><span class="linenos"> 39</span></a><span class="sd">    snapshot needs to be backfilled.</span>
</span><span id="Scheduler-40"><a href="#Scheduler-40"><span class="linenos"> 40</span></a>
</span><span id="Scheduler-41"><a href="#Scheduler-41"><span class="linenos"> 41</span></a><span class="sd">    The scheduler comes equipped with a simple ThreadPoolExecutor based evaluation engine.</span>
</span><span id="Scheduler-42"><a href="#Scheduler-42"><span class="linenos"> 42</span></a>
</span><span id="Scheduler-43"><a href="#Scheduler-43"><span class="linenos"> 43</span></a><span class="sd">    Args:</span>
</span><span id="Scheduler-44"><a href="#Scheduler-44"><span class="linenos"> 44</span></a><span class="sd">        snapshots: A collection of snapshots.</span>
</span><span id="Scheduler-45"><a href="#Scheduler-45"><span class="linenos"> 45</span></a><span class="sd">        snapshot_evaluator: The snapshot evaluator to execute queries.</span>
</span><span id="Scheduler-46"><a href="#Scheduler-46"><span class="linenos"> 46</span></a><span class="sd">        state_sync: The state sync to pull saved snapshots.</span>
</span><span id="Scheduler-47"><a href="#Scheduler-47"><span class="linenos"> 47</span></a><span class="sd">        max_workers: The maximum number of parallel queries to run.</span>
</span><span id="Scheduler-48"><a href="#Scheduler-48"><span class="linenos"> 48</span></a><span class="sd">        console: The rich instance used for printing scheduling information.</span>
</span><span id="Scheduler-49"><a href="#Scheduler-49"><span class="linenos"> 49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Scheduler-50"><a href="#Scheduler-50"><span class="linenos"> 50</span></a>
</span><span id="Scheduler-51"><a href="#Scheduler-51"><span class="linenos"> 51</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scheduler-52"><a href="#Scheduler-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-53"><a href="#Scheduler-53"><span class="linenos"> 53</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="Scheduler-54"><a href="#Scheduler-54"><span class="linenos"> 54</span></a>        <span class="n">snapshot_evaluator</span><span class="p">:</span> <span class="n">SnapshotEvaluator</span><span class="p">,</span>
</span><span id="Scheduler-55"><a href="#Scheduler-55"><span class="linenos"> 55</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">StateSync</span><span class="p">,</span>
</span><span id="Scheduler-56"><a href="#Scheduler-56"><span class="linenos"> 56</span></a>        <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Scheduler-57"><a href="#Scheduler-57"><span class="linenos"> 57</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-58"><a href="#Scheduler-58"><span class="linenos"> 58</span></a>    <span class="p">):</span>
</span><span id="Scheduler-59"><a href="#Scheduler-59"><span class="linenos"> 59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">}</span>
</span><span id="Scheduler-60"><a href="#Scheduler-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span> <span class="o">=</span> <span class="n">_resolve_one_snapshot_per_version</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span>
</span><span id="Scheduler-61"><a href="#Scheduler-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">snapshot_evaluator</span>
</span><span id="Scheduler-62"><a href="#Scheduler-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="Scheduler-63"><a href="#Scheduler-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
</span><span id="Scheduler-64"><a href="#Scheduler-64"><span class="linenos"> 64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span> <span class="n">Console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span><span id="Scheduler-65"><a href="#Scheduler-65"><span class="linenos"> 65</span></a>
</span><span id="Scheduler-66"><a href="#Scheduler-66"><span class="linenos"> 66</span></a>    <span class="k">def</span> <span class="nf">batches</span><span class="p">(</span>
</span><span id="Scheduler-67"><a href="#Scheduler-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-68"><a href="#Scheduler-68"><span class="linenos"> 68</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-69"><a href="#Scheduler-69"><span class="linenos"> 69</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-70"><a href="#Scheduler-70"><span class="linenos"> 70</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-71"><a href="#Scheduler-71"><span class="linenos"> 71</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler-72"><a href="#Scheduler-72"><span class="linenos"> 72</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="Scheduler-73"><a href="#Scheduler-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of snapshot batches to evaluate.</span>
</span><span id="Scheduler-74"><a href="#Scheduler-74"><span class="linenos"> 74</span></a>
</span><span id="Scheduler-75"><a href="#Scheduler-75"><span class="linenos"> 75</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-76"><a href="#Scheduler-76"><span class="linenos"> 76</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="Scheduler-77"><a href="#Scheduler-77"><span class="linenos"> 77</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="Scheduler-78"><a href="#Scheduler-78"><span class="linenos"> 78</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler-79"><a href="#Scheduler-79"><span class="linenos"> 79</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler-80"><a href="#Scheduler-80"><span class="linenos"> 80</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler-81"><a href="#Scheduler-81"><span class="linenos"> 81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-82"><a href="#Scheduler-82"><span class="linenos"> 82</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler-83"><a href="#Scheduler-83"><span class="linenos"> 83</span></a>
</span><span id="Scheduler-84"><a href="#Scheduler-84"><span class="linenos"> 84</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_params</span><span class="p">(</span>
</span><span id="Scheduler-85"><a href="#Scheduler-85"><span class="linenos"> 85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span><span id="Scheduler-86"><a href="#Scheduler-86"><span class="linenos"> 86</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler-87"><a href="#Scheduler-87"><span class="linenos"> 87</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler-88"><a href="#Scheduler-88"><span class="linenos"> 88</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler-89"><a href="#Scheduler-89"><span class="linenos"> 89</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler-90"><a href="#Scheduler-90"><span class="linenos"> 90</span></a>        <span class="p">)</span>
</span><span id="Scheduler-91"><a href="#Scheduler-91"><span class="linenos"> 91</span></a>
</span><span id="Scheduler-92"><a href="#Scheduler-92"><span class="linenos"> 92</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Scheduler-93"><a href="#Scheduler-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-94"><a href="#Scheduler-94"><span class="linenos"> 94</span></a>        <span class="n">snapshot</span><span class="p">:</span> <span class="n">Snapshot</span><span class="p">,</span>
</span><span id="Scheduler-95"><a href="#Scheduler-95"><span class="linenos"> 95</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler-96"><a href="#Scheduler-96"><span class="linenos"> 96</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler-97"><a href="#Scheduler-97"><span class="linenos"> 97</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler-98"><a href="#Scheduler-98"><span class="linenos"> 98</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler-99"><a href="#Scheduler-99"><span class="linenos"> 99</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Scheduler-100"><a href="#Scheduler-100"><span class="linenos">100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-101"><a href="#Scheduler-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a snapshot and add the processed interval to the state sync.</span>
</span><span id="Scheduler-102"><a href="#Scheduler-102"><span class="linenos">102</span></a>
</span><span id="Scheduler-103"><a href="#Scheduler-103"><span class="linenos">103</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-104"><a href="#Scheduler-104"><span class="linenos">104</span></a><span class="sd">            snapshot: Snapshot to evaluate.</span>
</span><span id="Scheduler-105"><a href="#Scheduler-105"><span class="linenos">105</span></a><span class="sd">            start: The start datetime to render.</span>
</span><span id="Scheduler-106"><a href="#Scheduler-106"><span class="linenos">106</span></a><span class="sd">            end: The end datetime to render.</span>
</span><span id="Scheduler-107"><a href="#Scheduler-107"><span class="linenos">107</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler-108"><a href="#Scheduler-108"><span class="linenos">108</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler-109"><a href="#Scheduler-109"><span class="linenos">109</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler-110"><a href="#Scheduler-110"><span class="linenos">110</span></a><span class="sd">            kwargs: Additional kwargs to pass to the renderer.</span>
</span><span id="Scheduler-111"><a href="#Scheduler-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-112"><a href="#Scheduler-112"><span class="linenos">112</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler-113"><a href="#Scheduler-113"><span class="linenos">113</span></a>
</span><span id="Scheduler-114"><a href="#Scheduler-114"><span class="linenos">114</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scheduler-115"><a href="#Scheduler-115"><span class="linenos">115</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">p_sid</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span><span class="p">},</span>
</span><span id="Scheduler-116"><a href="#Scheduler-116"><span class="linenos">116</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler-117"><a href="#Scheduler-117"><span class="linenos">117</span></a>        <span class="p">}</span>
</span><span id="Scheduler-118"><a href="#Scheduler-118"><span class="linenos">118</span></a>
</span><span id="Scheduler-119"><a href="#Scheduler-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Scheduler-120"><a href="#Scheduler-120"><span class="linenos">120</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler-121"><a href="#Scheduler-121"><span class="linenos">121</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler-122"><a href="#Scheduler-122"><span class="linenos">122</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler-123"><a href="#Scheduler-123"><span class="linenos">123</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler-124"><a href="#Scheduler-124"><span class="linenos">124</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Scheduler-125"><a href="#Scheduler-125"><span class="linenos">125</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler-126"><a href="#Scheduler-126"><span class="linenos">126</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Scheduler-127"><a href="#Scheduler-127"><span class="linenos">127</span></a>        <span class="p">)</span>
</span><span id="Scheduler-128"><a href="#Scheduler-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="Scheduler-129"><a href="#Scheduler-129"><span class="linenos">129</span></a>            <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler-130"><a href="#Scheduler-130"><span class="linenos">130</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler-131"><a href="#Scheduler-131"><span class="linenos">131</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler-132"><a href="#Scheduler-132"><span class="linenos">132</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler-133"><a href="#Scheduler-133"><span class="linenos">133</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Scheduler-134"><a href="#Scheduler-134"><span class="linenos">134</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler-135"><a href="#Scheduler-135"><span class="linenos">135</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Scheduler-136"><a href="#Scheduler-136"><span class="linenos">136</span></a>        <span class="p">)</span>
</span><span id="Scheduler-137"><a href="#Scheduler-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">add_interval</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler-138"><a href="#Scheduler-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">update_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Scheduler-139"><a href="#Scheduler-139"><span class="linenos">139</span></a>
</span><span id="Scheduler-140"><a href="#Scheduler-140"><span class="linenos">140</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="Scheduler-141"><a href="#Scheduler-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-142"><a href="#Scheduler-142"><span class="linenos">142</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-143"><a href="#Scheduler-143"><span class="linenos">143</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-144"><a href="#Scheduler-144"><span class="linenos">144</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-145"><a href="#Scheduler-145"><span class="linenos">145</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler-146"><a href="#Scheduler-146"><span class="linenos">146</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Scheduler-147"><a href="#Scheduler-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Concurrently runs all snapshots in topological order.</span>
</span><span id="Scheduler-148"><a href="#Scheduler-148"><span class="linenos">148</span></a>
</span><span id="Scheduler-149"><a href="#Scheduler-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-150"><a href="#Scheduler-150"><span class="linenos">150</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="Scheduler-151"><a href="#Scheduler-151"><span class="linenos">151</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="Scheduler-152"><a href="#Scheduler-152"><span class="linenos">152</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler-153"><a href="#Scheduler-153"><span class="linenos">153</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler-154"><a href="#Scheduler-154"><span class="linenos">154</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler-155"><a href="#Scheduler-155"><span class="linenos">155</span></a>
</span><span id="Scheduler-156"><a href="#Scheduler-156"><span class="linenos">156</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-157"><a href="#Scheduler-157"><span class="linenos">157</span></a><span class="sd">            True if the execution was successful and False otherwise.</span>
</span><span id="Scheduler-158"><a href="#Scheduler-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-159"><a href="#Scheduler-159"><span class="linenos">159</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler-160"><a href="#Scheduler-160"><span class="linenos">160</span></a>
</span><span id="Scheduler-161"><a href="#Scheduler-161"><span class="linenos">161</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">now</span><span class="p">()</span>
</span><span id="Scheduler-162"><a href="#Scheduler-162"><span class="linenos">162</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler-163"><a href="#Scheduler-163"><span class="linenos">163</span></a>        <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
</span><span id="Scheduler-164"><a href="#Scheduler-164"><span class="linenos">164</span></a>
</span><span id="Scheduler-165"><a href="#Scheduler-165"><span class="linenos">165</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Scheduler-166"><a href="#Scheduler-166"><span class="linenos">166</span></a>        <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">sorted</span><span class="p">():</span>
</span><span id="Scheduler-167"><a href="#Scheduler-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="Scheduler-168"><a href="#Scheduler-168"><span class="linenos">168</span></a>                <span class="k">continue</span>
</span><span id="Scheduler-169"><a href="#Scheduler-169"><span class="linenos">169</span></a>            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</span><span id="Scheduler-170"><a href="#Scheduler-170"><span class="linenos">170</span></a>            <span class="n">intervals</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span>
</span><span id="Scheduler-171"><a href="#Scheduler-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">start_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">))</span>
</span><span id="Scheduler-172"><a href="#Scheduler-172"><span class="linenos">172</span></a>
</span><span id="Scheduler-173"><a href="#Scheduler-173"><span class="linenos">173</span></a>        <span class="k">def</span> <span class="nf">evaluate_node</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SchedulingUnit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler-174"><a href="#Scheduler-174"><span class="linenos">174</span></a>            <span class="k">assert</span> <span class="n">latest</span>
</span><span id="Scheduler-175"><a href="#Scheduler-175"><span class="linenos">175</span></a>            <span class="n">snapshot</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="Scheduler-176"><a href="#Scheduler-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler-177"><a href="#Scheduler-177"><span class="linenos">177</span></a>
</span><span id="Scheduler-178"><a href="#Scheduler-178"><span class="linenos">178</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">concurrent_context</span><span class="p">():</span>
</span><span id="Scheduler-179"><a href="#Scheduler-179"><span class="linenos">179</span></a>            <span class="n">errors</span><span class="p">,</span> <span class="n">skipped_intervals</span> <span class="o">=</span> <span class="n">concurrent_apply_to_dag</span><span class="p">(</span>
</span><span id="Scheduler-180"><a href="#Scheduler-180"><span class="linenos">180</span></a>                <span class="n">dag</span><span class="p">,</span>
</span><span id="Scheduler-181"><a href="#Scheduler-181"><span class="linenos">181</span></a>                <span class="n">evaluate_node</span><span class="p">,</span>
</span><span id="Scheduler-182"><a href="#Scheduler-182"><span class="linenos">182</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">,</span>
</span><span id="Scheduler-183"><a href="#Scheduler-183"><span class="linenos">183</span></a>                <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler-184"><a href="#Scheduler-184"><span class="linenos">184</span></a>            <span class="p">)</span>
</span><span id="Scheduler-185"><a href="#Scheduler-185"><span class="linenos">185</span></a>
</span><span id="Scheduler-186"><a href="#Scheduler-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">stop_snapshot_progress</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="ow">not</span> <span class="n">errors</span><span class="p">)</span>
</span><span id="Scheduler-187"><a href="#Scheduler-187"><span class="linenos">187</span></a>
</span><span id="Scheduler-188"><a href="#Scheduler-188"><span class="linenos">188</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="Scheduler-189"><a href="#Scheduler-189"><span class="linenos">189</span></a>            <span class="n">sid</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Scheduler-190"><a href="#Scheduler-190"><span class="linenos">190</span></a>            <span class="n">formatted_exception</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">format_exception</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">or</span> <span class="n">error</span><span class="p">))</span>
</span><span id="Scheduler-191"><a href="#Scheduler-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILED processing snapshot </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">formatted_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Scheduler-192"><a href="#Scheduler-192"><span class="linenos">192</span></a>
</span><span id="Scheduler-193"><a href="#Scheduler-193"><span class="linenos">193</span></a>        <span class="n">skipped_snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skipped_intervals</span><span class="p">}</span>
</span><span id="Scheduler-194"><a href="#Scheduler-194"><span class="linenos">194</span></a>        <span class="k">for</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">skipped_snapshots</span><span class="p">:</span>
</span><span id="Scheduler-195"><a href="#Scheduler-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SKIPPED snapshot </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Scheduler-196"><a href="#Scheduler-196"><span class="linenos">196</span></a>
</span><span id="Scheduler-197"><a href="#Scheduler-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="ow">not</span> <span class="n">errors</span>
</span><span id="Scheduler-198"><a href="#Scheduler-198"><span class="linenos">198</span></a>
</span><span id="Scheduler-199"><a href="#Scheduler-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">_interval_params</span><span class="p">(</span>
</span><span id="Scheduler-200"><a href="#Scheduler-200"><span class="linenos">200</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler-201"><a href="#Scheduler-201"><span class="linenos">201</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="Scheduler-202"><a href="#Scheduler-202"><span class="linenos">202</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-203"><a href="#Scheduler-203"><span class="linenos">203</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-204"><a href="#Scheduler-204"><span class="linenos">204</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler-205"><a href="#Scheduler-205"><span class="linenos">205</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler-206"><a href="#Scheduler-206"><span class="linenos">206</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="Scheduler-207"><a href="#Scheduler-207"><span class="linenos">207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the optimal date interval paramaters based on what needs processing and maximal batch size.</span>
</span><span id="Scheduler-208"><a href="#Scheduler-208"><span class="linenos">208</span></a>
</span><span id="Scheduler-209"><a href="#Scheduler-209"><span class="linenos">209</span></a><span class="sd">        For each model name, find all dependencies and look for a stored snapshot from the metastore. If a snapshot is found,</span>
</span><span id="Scheduler-210"><a href="#Scheduler-210"><span class="linenos">210</span></a><span class="sd">        calculate the missing intervals that need to be processed given the passed in start and end intervals.</span>
</span><span id="Scheduler-211"><a href="#Scheduler-211"><span class="linenos">211</span></a>
</span><span id="Scheduler-212"><a href="#Scheduler-212"><span class="linenos">212</span></a><span class="sd">        If a snapshot&#39;s model specifies a batch size, consecutive intervals are merged into batches of a size that is less than</span>
</span><span id="Scheduler-213"><a href="#Scheduler-213"><span class="linenos">213</span></a><span class="sd">        or equal to the configured one. If no batch size is specified, then it uses the intervals that correspond to the model&#39;s cron expression.</span>
</span><span id="Scheduler-214"><a href="#Scheduler-214"><span class="linenos">214</span></a><span class="sd">        For example, if a model is supposed to run daily and has 70 days to backfill with a batch size set to 30, there would be 2 jobs</span>
</span><span id="Scheduler-215"><a href="#Scheduler-215"><span class="linenos">215</span></a><span class="sd">        with 30 days and 1 job with 10.</span>
</span><span id="Scheduler-216"><a href="#Scheduler-216"><span class="linenos">216</span></a>
</span><span id="Scheduler-217"><a href="#Scheduler-217"><span class="linenos">217</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-218"><a href="#Scheduler-218"><span class="linenos">218</span></a><span class="sd">            snapshots: The list of snapshots.</span>
</span><span id="Scheduler-219"><a href="#Scheduler-219"><span class="linenos">219</span></a><span class="sd">            start: Start of the interval.</span>
</span><span id="Scheduler-220"><a href="#Scheduler-220"><span class="linenos">220</span></a><span class="sd">            end: End of the interval.</span>
</span><span id="Scheduler-221"><a href="#Scheduler-221"><span class="linenos">221</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler-222"><a href="#Scheduler-222"><span class="linenos">222</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode.</span>
</span><span id="Scheduler-223"><a href="#Scheduler-223"><span class="linenos">223</span></a>
</span><span id="Scheduler-224"><a href="#Scheduler-224"><span class="linenos">224</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-225"><a href="#Scheduler-225"><span class="linenos">225</span></a><span class="sd">            A list of tuples containing all snapshots needing to be run with their associated interval params.</span>
</span><span id="Scheduler-226"><a href="#Scheduler-226"><span class="linenos">226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-227"><a href="#Scheduler-227"><span class="linenos">227</span></a>        <span class="n">all_snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
</span><span id="Scheduler-228"><a href="#Scheduler-228"><span class="linenos">228</span></a>
</span><span id="Scheduler-229"><a href="#Scheduler-229"><span class="linenos">229</span></a>        <span class="c1"># When in development mode only consider intervals of the current forward-only snapshot and ignore</span>
</span><span id="Scheduler-230"><a href="#Scheduler-230"><span class="linenos">230</span></a>        <span class="c1"># intervals of all snapshots with the same version that came before it.</span>
</span><span id="Scheduler-231"><a href="#Scheduler-231"><span class="linenos">231</span></a>        <span class="n">same_version_snapshots</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Scheduler-232"><a href="#Scheduler-232"><span class="linenos">232</span></a>            <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snapshots</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_forward_only</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">is_paused</span><span class="p">]</span>
</span><span id="Scheduler-233"><a href="#Scheduler-233"><span class="linenos">233</span></a>            <span class="k">if</span> <span class="n">is_dev</span>
</span><span id="Scheduler-234"><a href="#Scheduler-234"><span class="linenos">234</span></a>            <span class="k">else</span> <span class="n">snapshots</span>
</span><span id="Scheduler-235"><a href="#Scheduler-235"><span class="linenos">235</span></a>        <span class="p">)</span>
</span><span id="Scheduler-236"><a href="#Scheduler-236"><span class="linenos">236</span></a>        <span class="n">stored_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_snapshots_with_same_version</span><span class="p">(</span><span class="n">same_version_snapshots</span><span class="p">)</span>
</span><span id="Scheduler-237"><a href="#Scheduler-237"><span class="linenos">237</span></a>        <span class="n">all_snapshots</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stored_snapshots</span><span class="p">})</span>
</span><span id="Scheduler-238"><a href="#Scheduler-238"><span class="linenos">238</span></a>
</span><span id="Scheduler-239"><a href="#Scheduler-239"><span class="linenos">239</span></a>        <span class="k">return</span> <span class="n">compute_interval_params</span><span class="p">(</span>
</span><span id="Scheduler-240"><a href="#Scheduler-240"><span class="linenos">240</span></a>            <span class="n">snapshots</span><span class="p">,</span>
</span><span id="Scheduler-241"><a href="#Scheduler-241"><span class="linenos">241</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">all_snapshots</span><span class="p">,</span>
</span><span id="Scheduler-242"><a href="#Scheduler-242"><span class="linenos">242</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span> <span class="ow">or</span> <span class="n">earliest_start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">),</span>
</span><span id="Scheduler-243"><a href="#Scheduler-243"><span class="linenos">243</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span> <span class="ow">or</span> <span class="n">now</span><span class="p">(),</span>
</span><span id="Scheduler-244"><a href="#Scheduler-244"><span class="linenos">244</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span> <span class="ow">or</span> <span class="n">now</span><span class="p">(),</span>
</span><span id="Scheduler-245"><a href="#Scheduler-245"><span class="linenos">245</span></a>        <span class="p">)</span>
</span><span id="Scheduler-246"><a href="#Scheduler-246"><span class="linenos">246</span></a>
</span><span id="Scheduler-247"><a href="#Scheduler-247"><span class="linenos">247</span></a>    <span class="k">def</span> <span class="nf">_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">SnapshotToBatches</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DAG</span><span class="p">[</span><span class="n">SchedulingUnit</span><span class="p">]:</span>
</span><span id="Scheduler-248"><a href="#Scheduler-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds a DAG of snapshot intervals to be evaluated.</span>
</span><span id="Scheduler-249"><a href="#Scheduler-249"><span class="linenos">249</span></a>
</span><span id="Scheduler-250"><a href="#Scheduler-250"><span class="linenos">250</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler-251"><a href="#Scheduler-251"><span class="linenos">251</span></a><span class="sd">            batches: The batches of snapshots and intervals to evaluate.</span>
</span><span id="Scheduler-252"><a href="#Scheduler-252"><span class="linenos">252</span></a>
</span><span id="Scheduler-253"><a href="#Scheduler-253"><span class="linenos">253</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler-254"><a href="#Scheduler-254"><span class="linenos">254</span></a><span class="sd">            A DAG of snapshot intervals to be evaluated.</span>
</span><span id="Scheduler-255"><a href="#Scheduler-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler-256"><a href="#Scheduler-256"><span class="linenos">256</span></a>
</span><span id="Scheduler-257"><a href="#Scheduler-257"><span class="linenos">257</span></a>        <span class="n">intervals_per_snapshot_version</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scheduler-258"><a href="#Scheduler-258"><span class="linenos">258</span></a>            <span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version_get_or_generate</span><span class="p">()):</span> <span class="n">intervals</span>
</span><span id="Scheduler-259"><a href="#Scheduler-259"><span class="linenos">259</span></a>            <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Scheduler-260"><a href="#Scheduler-260"><span class="linenos">260</span></a>        <span class="p">}</span>
</span><span id="Scheduler-261"><a href="#Scheduler-261"><span class="linenos">261</span></a>
</span><span id="Scheduler-262"><a href="#Scheduler-262"><span class="linenos">262</span></a>        <span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">[</span><span class="n">SchedulingUnit</span><span class="p">]()</span>
</span><span id="Scheduler-263"><a href="#Scheduler-263"><span class="linenos">263</span></a>        <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">batches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Scheduler-264"><a href="#Scheduler-264"><span class="linenos">264</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">intervals</span><span class="p">:</span>
</span><span id="Scheduler-265"><a href="#Scheduler-265"><span class="linenos">265</span></a>                <span class="k">continue</span>
</span><span id="Scheduler-266"><a href="#Scheduler-266"><span class="linenos">266</span></a>            <span class="n">upstream_dependencies</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Scheduler-267"><a href="#Scheduler-267"><span class="linenos">267</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">],</span> <span class="n">interval</span><span class="p">)</span>
</span><span id="Scheduler-268"><a href="#Scheduler-268"><span class="linenos">268</span></a>                <span class="k">for</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span>
</span><span id="Scheduler-269"><a href="#Scheduler-269"><span class="linenos">269</span></a>                <span class="k">if</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span>
</span><span id="Scheduler-270"><a href="#Scheduler-270"><span class="linenos">270</span></a>                <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals_per_snapshot_version</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="Scheduler-271"><a href="#Scheduler-271"><span class="linenos">271</span></a>                    <span class="p">(</span>
</span><span id="Scheduler-272"><a href="#Scheduler-272"><span class="linenos">272</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Scheduler-273"><a href="#Scheduler-273"><span class="linenos">273</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span><span class="o">.</span><span class="n">version_get_or_generate</span><span class="p">(),</span>
</span><span id="Scheduler-274"><a href="#Scheduler-274"><span class="linenos">274</span></a>                    <span class="p">),</span>
</span><span id="Scheduler-275"><a href="#Scheduler-275"><span class="linenos">275</span></a>                    <span class="p">[],</span>
</span><span id="Scheduler-276"><a href="#Scheduler-276"><span class="linenos">276</span></a>                <span class="p">)</span>
</span><span id="Scheduler-277"><a href="#Scheduler-277"><span class="linenos">277</span></a>            <span class="p">]</span>
</span><span id="Scheduler-278"><a href="#Scheduler-278"><span class="linenos">278</span></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
</span><span id="Scheduler-279"><a href="#Scheduler-279"><span class="linenos">279</span></a>                <span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">interval</span><span class="p">),</span> <span class="n">upstream_dependencies</span><span class="p">)</span>
</span><span id="Scheduler-280"><a href="#Scheduler-280"><span class="linenos">280</span></a>                <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">is_incremental_by_unique_key_kind</span><span class="p">:</span>
</span><span id="Scheduler-281"><a href="#Scheduler-281"><span class="linenos">281</span></a>                    <span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="Scheduler-282"><a href="#Scheduler-282"><span class="linenos">282</span></a>                        <span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">interval</span><span class="p">),</span>
</span><span id="Scheduler-283"><a href="#Scheduler-283"><span class="linenos">283</span></a>                        <span class="p">[(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">_interval</span><span class="p">)</span> <span class="k">for</span> <span class="n">_interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[:</span><span class="n">i</span><span class="p">]],</span>
</span><span id="Scheduler-284"><a href="#Scheduler-284"><span class="linenos">284</span></a>                    <span class="p">)</span>
</span><span id="Scheduler-285"><a href="#Scheduler-285"><span class="linenos">285</span></a>
</span><span id="Scheduler-286"><a href="#Scheduler-286"><span class="linenos">286</span></a>        <span class="k">return</span> <span class="n">dag</span>
</span></pre></div>


            <div class="docstring"><p>Schedules and manages the evaluation of snapshots.</p>

<p>The scheduler evaluates multiple snapshots with date intervals in the correct
topological order. It consults the state sync to understand what intervals for each
snapshot needs to be backfilled.</p>

<p>The scheduler comes equipped with a simple ThreadPoolExecutor based evaluation engine.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>snapshots:</strong>  A collection of snapshots.</li>
<li><strong>snapshot_evaluator:</strong>  The snapshot evaluator to execute queries.</li>
<li><strong>state_sync:</strong>  The state sync to pull saved snapshots.</li>
<li><strong>max_workers:</strong>  The maximum number of parallel queries to run.</li>
<li><strong>console:</strong>  The rich instance used for printing scheduling information.</li>
</ul>
</div>


                            <div id="Scheduler.__init__" class="classattr">
                                        <input id="Scheduler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Scheduler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">snapshots</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">snapshot_evaluator</span><span class="p">:</span> <span class="n"><a href="snapshot/evaluator.html#SnapshotEvaluator">sqlmesh.core.snapshot.evaluator.SnapshotEvaluator</a></span>,</span><span class="param">	<span class="n">state_sync</span><span class="p">:</span> <span class="n"><a href="state_sync/base.html#StateSync">sqlmesh.core.state_sync.base.StateSync</a></span>,</span><span class="param">	<span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">console</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="console.html#Console">sqlmesh.core.console.Console</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Scheduler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.__init__-51"><a href="#Scheduler.__init__-51"><span class="linenos">51</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Scheduler.__init__-52"><a href="#Scheduler.__init__-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler.__init__-53"><a href="#Scheduler.__init__-53"><span class="linenos">53</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">],</span>
</span><span id="Scheduler.__init__-54"><a href="#Scheduler.__init__-54"><span class="linenos">54</span></a>        <span class="n">snapshot_evaluator</span><span class="p">:</span> <span class="n">SnapshotEvaluator</span><span class="p">,</span>
</span><span id="Scheduler.__init__-55"><a href="#Scheduler.__init__-55"><span class="linenos">55</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">StateSync</span><span class="p">,</span>
</span><span id="Scheduler.__init__-56"><a href="#Scheduler.__init__-56"><span class="linenos">56</span></a>        <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Scheduler.__init__-57"><a href="#Scheduler.__init__-57"><span class="linenos">57</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.__init__-58"><a href="#Scheduler.__init__-58"><span class="linenos">58</span></a>    <span class="p">):</span>
</span><span id="Scheduler.__init__-59"><a href="#Scheduler.__init__-59"><span class="linenos">59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">}</span>
</span><span id="Scheduler.__init__-60"><a href="#Scheduler.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span> <span class="o">=</span> <span class="n">_resolve_one_snapshot_per_version</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span>
</span><span id="Scheduler.__init__-61"><a href="#Scheduler.__init__-61"><span class="linenos">61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">snapshot_evaluator</span>
</span><span id="Scheduler.__init__-62"><a href="#Scheduler.__init__-62"><span class="linenos">62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="Scheduler.__init__-63"><a href="#Scheduler.__init__-63"><span class="linenos">63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
</span><span id="Scheduler.__init__-64"><a href="#Scheduler.__init__-64"><span class="linenos">64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">:</span> <span class="n">Console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Scheduler.batches" class="classattr">
                                        <input id="Scheduler.batches-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">batches</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="Scheduler.batches-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.batches"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.batches-66"><a href="#Scheduler.batches-66"><span class="linenos">66</span></a>    <span class="k">def</span> <span class="nf">batches</span><span class="p">(</span>
</span><span id="Scheduler.batches-67"><a href="#Scheduler.batches-67"><span class="linenos">67</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler.batches-68"><a href="#Scheduler.batches-68"><span class="linenos">68</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.batches-69"><a href="#Scheduler.batches-69"><span class="linenos">69</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.batches-70"><a href="#Scheduler.batches-70"><span class="linenos">70</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.batches-71"><a href="#Scheduler.batches-71"><span class="linenos">71</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler.batches-72"><a href="#Scheduler.batches-72"><span class="linenos">72</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="Scheduler.batches-73"><a href="#Scheduler.batches-73"><span class="linenos">73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of snapshot batches to evaluate.</span>
</span><span id="Scheduler.batches-74"><a href="#Scheduler.batches-74"><span class="linenos">74</span></a>
</span><span id="Scheduler.batches-75"><a href="#Scheduler.batches-75"><span class="linenos">75</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.batches-76"><a href="#Scheduler.batches-76"><span class="linenos">76</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="Scheduler.batches-77"><a href="#Scheduler.batches-77"><span class="linenos">77</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="Scheduler.batches-78"><a href="#Scheduler.batches-78"><span class="linenos">78</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler.batches-79"><a href="#Scheduler.batches-79"><span class="linenos">79</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler.batches-80"><a href="#Scheduler.batches-80"><span class="linenos">80</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler.batches-81"><a href="#Scheduler.batches-81"><span class="linenos">81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.batches-82"><a href="#Scheduler.batches-82"><span class="linenos">82</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler.batches-83"><a href="#Scheduler.batches-83"><span class="linenos">83</span></a>
</span><span id="Scheduler.batches-84"><a href="#Scheduler.batches-84"><span class="linenos">84</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interval_params</span><span class="p">(</span>
</span><span id="Scheduler.batches-85"><a href="#Scheduler.batches-85"><span class="linenos">85</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_per_version</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
</span><span id="Scheduler.batches-86"><a href="#Scheduler.batches-86"><span class="linenos">86</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler.batches-87"><a href="#Scheduler.batches-87"><span class="linenos">87</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler.batches-88"><a href="#Scheduler.batches-88"><span class="linenos">88</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler.batches-89"><a href="#Scheduler.batches-89"><span class="linenos">89</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler.batches-90"><a href="#Scheduler.batches-90"><span class="linenos">90</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns a list of snapshot batches to evaluate.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>start:</strong>  The start of the run. Defaults to the min model start date.</li>
<li><strong>end:</strong>  The end of the run. Defaults to now.</li>
<li><strong>latest:</strong>  The latest datetime to use for non-incremental queries.</li>
<li><strong>is_dev:</strong>  Indicates whether the evaluation happens in the development mode and temporary
tables / table clones should be used where applicable.</li>
</ul>
</div>


                            </div>
                            <div id="Scheduler.evaluate" class="classattr">
                                        <input id="Scheduler.evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">snapshot</span><span class="p">:</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Scheduler.evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.evaluate-92"><a href="#Scheduler.evaluate-92"><span class="linenos"> 92</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Scheduler.evaluate-93"><a href="#Scheduler.evaluate-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-94"><a href="#Scheduler.evaluate-94"><span class="linenos"> 94</span></a>        <span class="n">snapshot</span><span class="p">:</span> <span class="n">Snapshot</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-95"><a href="#Scheduler.evaluate-95"><span class="linenos"> 95</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-96"><a href="#Scheduler.evaluate-96"><span class="linenos"> 96</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-97"><a href="#Scheduler.evaluate-97"><span class="linenos"> 97</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-98"><a href="#Scheduler.evaluate-98"><span class="linenos"> 98</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-99"><a href="#Scheduler.evaluate-99"><span class="linenos"> 99</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-100"><a href="#Scheduler.evaluate-100"><span class="linenos">100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.evaluate-101"><a href="#Scheduler.evaluate-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a snapshot and add the processed interval to the state sync.</span>
</span><span id="Scheduler.evaluate-102"><a href="#Scheduler.evaluate-102"><span class="linenos">102</span></a>
</span><span id="Scheduler.evaluate-103"><a href="#Scheduler.evaluate-103"><span class="linenos">103</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.evaluate-104"><a href="#Scheduler.evaluate-104"><span class="linenos">104</span></a><span class="sd">            snapshot: Snapshot to evaluate.</span>
</span><span id="Scheduler.evaluate-105"><a href="#Scheduler.evaluate-105"><span class="linenos">105</span></a><span class="sd">            start: The start datetime to render.</span>
</span><span id="Scheduler.evaluate-106"><a href="#Scheduler.evaluate-106"><span class="linenos">106</span></a><span class="sd">            end: The end datetime to render.</span>
</span><span id="Scheduler.evaluate-107"><a href="#Scheduler.evaluate-107"><span class="linenos">107</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler.evaluate-108"><a href="#Scheduler.evaluate-108"><span class="linenos">108</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler.evaluate-109"><a href="#Scheduler.evaluate-109"><span class="linenos">109</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler.evaluate-110"><a href="#Scheduler.evaluate-110"><span class="linenos">110</span></a><span class="sd">            kwargs: Additional kwargs to pass to the renderer.</span>
</span><span id="Scheduler.evaluate-111"><a href="#Scheduler.evaluate-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.evaluate-112"><a href="#Scheduler.evaluate-112"><span class="linenos">112</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler.evaluate-113"><a href="#Scheduler.evaluate-113"><span class="linenos">113</span></a>
</span><span id="Scheduler.evaluate-114"><a href="#Scheduler.evaluate-114"><span class="linenos">114</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Scheduler.evaluate-115"><a href="#Scheduler.evaluate-115"><span class="linenos">115</span></a>            <span class="o">**</span><span class="p">{</span><span class="n">p_sid</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">p_sid</span><span class="p">]</span> <span class="k">for</span> <span class="n">p_sid</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span><span class="p">},</span>
</span><span id="Scheduler.evaluate-116"><a href="#Scheduler.evaluate-116"><span class="linenos">116</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-117"><a href="#Scheduler.evaluate-117"><span class="linenos">117</span></a>        <span class="p">}</span>
</span><span id="Scheduler.evaluate-118"><a href="#Scheduler.evaluate-118"><span class="linenos">118</span></a>
</span><span id="Scheduler.evaluate-119"><a href="#Scheduler.evaluate-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Scheduler.evaluate-120"><a href="#Scheduler.evaluate-120"><span class="linenos">120</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-121"><a href="#Scheduler.evaluate-121"><span class="linenos">121</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-122"><a href="#Scheduler.evaluate-122"><span class="linenos">122</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-123"><a href="#Scheduler.evaluate-123"><span class="linenos">123</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-124"><a href="#Scheduler.evaluate-124"><span class="linenos">124</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-125"><a href="#Scheduler.evaluate-125"><span class="linenos">125</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-126"><a href="#Scheduler.evaluate-126"><span class="linenos">126</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-127"><a href="#Scheduler.evaluate-127"><span class="linenos">127</span></a>        <span class="p">)</span>
</span><span id="Scheduler.evaluate-128"><a href="#Scheduler.evaluate-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="Scheduler.evaluate-129"><a href="#Scheduler.evaluate-129"><span class="linenos">129</span></a>            <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-130"><a href="#Scheduler.evaluate-130"><span class="linenos">130</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-131"><a href="#Scheduler.evaluate-131"><span class="linenos">131</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-132"><a href="#Scheduler.evaluate-132"><span class="linenos">132</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-133"><a href="#Scheduler.evaluate-133"><span class="linenos">133</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-134"><a href="#Scheduler.evaluate-134"><span class="linenos">134</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-135"><a href="#Scheduler.evaluate-135"><span class="linenos">135</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Scheduler.evaluate-136"><a href="#Scheduler.evaluate-136"><span class="linenos">136</span></a>        <span class="p">)</span>
</span><span id="Scheduler.evaluate-137"><a href="#Scheduler.evaluate-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">add_interval</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler.evaluate-138"><a href="#Scheduler.evaluate-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">update_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate a snapshot and add the processed interval to the state sync.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>snapshot:</strong>  Snapshot to evaluate.</li>
<li><strong>start:</strong>  The start datetime to render.</li>
<li><strong>end:</strong>  The end datetime to render.</li>
<li><strong>latest:</strong>  The latest datetime to use for non-incremental queries.</li>
<li><strong>is_dev:</strong>  Indicates whether the evaluation happens in the development mode and temporary
tables / table clones should be used where applicable.</li>
<li><strong>kwargs:</strong>  Additional kwargs to pass to the renderer.</li>
</ul>
</div>


                            </div>
                            <div id="Scheduler.run" class="classattr">
                                        <input id="Scheduler.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Scheduler.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Scheduler.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Scheduler.run-140"><a href="#Scheduler.run-140"><span class="linenos">140</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="Scheduler.run-141"><a href="#Scheduler.run-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Scheduler.run-142"><a href="#Scheduler.run-142"><span class="linenos">142</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.run-143"><a href="#Scheduler.run-143"><span class="linenos">143</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.run-144"><a href="#Scheduler.run-144"><span class="linenos">144</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Scheduler.run-145"><a href="#Scheduler.run-145"><span class="linenos">145</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler.run-146"><a href="#Scheduler.run-146"><span class="linenos">146</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Scheduler.run-147"><a href="#Scheduler.run-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Concurrently runs all snapshots in topological order.</span>
</span><span id="Scheduler.run-148"><a href="#Scheduler.run-148"><span class="linenos">148</span></a>
</span><span id="Scheduler.run-149"><a href="#Scheduler.run-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="Scheduler.run-150"><a href="#Scheduler.run-150"><span class="linenos">150</span></a><span class="sd">            start: The start of the run. Defaults to the min model start date.</span>
</span><span id="Scheduler.run-151"><a href="#Scheduler.run-151"><span class="linenos">151</span></a><span class="sd">            end: The end of the run. Defaults to now.</span>
</span><span id="Scheduler.run-152"><a href="#Scheduler.run-152"><span class="linenos">152</span></a><span class="sd">            latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="Scheduler.run-153"><a href="#Scheduler.run-153"><span class="linenos">153</span></a><span class="sd">            is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="Scheduler.run-154"><a href="#Scheduler.run-154"><span class="linenos">154</span></a><span class="sd">                tables / table clones should be used where applicable.</span>
</span><span id="Scheduler.run-155"><a href="#Scheduler.run-155"><span class="linenos">155</span></a>
</span><span id="Scheduler.run-156"><a href="#Scheduler.run-156"><span class="linenos">156</span></a><span class="sd">        Returns:</span>
</span><span id="Scheduler.run-157"><a href="#Scheduler.run-157"><span class="linenos">157</span></a><span class="sd">            True if the execution was successful and False otherwise.</span>
</span><span id="Scheduler.run-158"><a href="#Scheduler.run-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Scheduler.run-159"><a href="#Scheduler.run-159"><span class="linenos">159</span></a>        <span class="n">validate_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="Scheduler.run-160"><a href="#Scheduler.run-160"><span class="linenos">160</span></a>
</span><span id="Scheduler.run-161"><a href="#Scheduler.run-161"><span class="linenos">161</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">now</span><span class="p">()</span>
</span><span id="Scheduler.run-162"><a href="#Scheduler.run-162"><span class="linenos">162</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler.run-163"><a href="#Scheduler.run-163"><span class="linenos">163</span></a>        <span class="n">dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dag</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
</span><span id="Scheduler.run-164"><a href="#Scheduler.run-164"><span class="linenos">164</span></a>
</span><span id="Scheduler.run-165"><a href="#Scheduler.run-165"><span class="linenos">165</span></a>        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Scheduler.run-166"><a href="#Scheduler.run-166"><span class="linenos">166</span></a>        <span class="k">for</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">sorted</span><span class="p">():</span>
</span><span id="Scheduler.run-167"><a href="#Scheduler.run-167"><span class="linenos">167</span></a>            <span class="k">if</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
</span><span id="Scheduler.run-168"><a href="#Scheduler.run-168"><span class="linenos">168</span></a>                <span class="k">continue</span>
</span><span id="Scheduler.run-169"><a href="#Scheduler.run-169"><span class="linenos">169</span></a>            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</span><span id="Scheduler.run-170"><a href="#Scheduler.run-170"><span class="linenos">170</span></a>            <span class="n">intervals</span> <span class="o">=</span> <span class="n">batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span>
</span><span id="Scheduler.run-171"><a href="#Scheduler.run-171"><span class="linenos">171</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">start_snapshot_progress</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">))</span>
</span><span id="Scheduler.run-172"><a href="#Scheduler.run-172"><span class="linenos">172</span></a>
</span><span id="Scheduler.run-173"><a href="#Scheduler.run-173"><span class="linenos">173</span></a>        <span class="k">def</span> <span class="nf">evaluate_node</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SchedulingUnit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Scheduler.run-174"><a href="#Scheduler.run-174"><span class="linenos">174</span></a>            <span class="k">assert</span> <span class="n">latest</span>
</span><span id="Scheduler.run-175"><a href="#Scheduler.run-175"><span class="linenos">175</span></a>            <span class="n">snapshot</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="Scheduler.run-176"><a href="#Scheduler.run-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">,</span> <span class="n">is_dev</span><span class="o">=</span><span class="n">is_dev</span><span class="p">)</span>
</span><span id="Scheduler.run-177"><a href="#Scheduler.run-177"><span class="linenos">177</span></a>
</span><span id="Scheduler.run-178"><a href="#Scheduler.run-178"><span class="linenos">178</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">concurrent_context</span><span class="p">():</span>
</span><span id="Scheduler.run-179"><a href="#Scheduler.run-179"><span class="linenos">179</span></a>            <span class="n">errors</span><span class="p">,</span> <span class="n">skipped_intervals</span> <span class="o">=</span> <span class="n">concurrent_apply_to_dag</span><span class="p">(</span>
</span><span id="Scheduler.run-180"><a href="#Scheduler.run-180"><span class="linenos">180</span></a>                <span class="n">dag</span><span class="p">,</span>
</span><span id="Scheduler.run-181"><a href="#Scheduler.run-181"><span class="linenos">181</span></a>                <span class="n">evaluate_node</span><span class="p">,</span>
</span><span id="Scheduler.run-182"><a href="#Scheduler.run-182"><span class="linenos">182</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">,</span>
</span><span id="Scheduler.run-183"><a href="#Scheduler.run-183"><span class="linenos">183</span></a>                <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Scheduler.run-184"><a href="#Scheduler.run-184"><span class="linenos">184</span></a>            <span class="p">)</span>
</span><span id="Scheduler.run-185"><a href="#Scheduler.run-185"><span class="linenos">185</span></a>
</span><span id="Scheduler.run-186"><a href="#Scheduler.run-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">stop_snapshot_progress</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="ow">not</span> <span class="n">errors</span><span class="p">)</span>
</span><span id="Scheduler.run-187"><a href="#Scheduler.run-187"><span class="linenos">187</span></a>
</span><span id="Scheduler.run-188"><a href="#Scheduler.run-188"><span class="linenos">188</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="Scheduler.run-189"><a href="#Scheduler.run-189"><span class="linenos">189</span></a>            <span class="n">sid</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Scheduler.run-190"><a href="#Scheduler.run-190"><span class="linenos">190</span></a>            <span class="n">formatted_exception</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">format_exception</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">or</span> <span class="n">error</span><span class="p">))</span>
</span><span id="Scheduler.run-191"><a href="#Scheduler.run-191"><span class="linenos">191</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FAILED processing snapshot </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">formatted_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Scheduler.run-192"><a href="#Scheduler.run-192"><span class="linenos">192</span></a>
</span><span id="Scheduler.run-193"><a href="#Scheduler.run-193"><span class="linenos">193</span></a>        <span class="n">skipped_snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skipped_intervals</span><span class="p">}</span>
</span><span id="Scheduler.run-194"><a href="#Scheduler.run-194"><span class="linenos">194</span></a>        <span class="k">for</span> <span class="n">skipped</span> <span class="ow">in</span> <span class="n">skipped_snapshots</span><span class="p">:</span>
</span><span id="Scheduler.run-195"><a href="#Scheduler.run-195"><span class="linenos">195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SKIPPED snapshot </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Scheduler.run-196"><a href="#Scheduler.run-196"><span class="linenos">196</span></a>
</span><span id="Scheduler.run-197"><a href="#Scheduler.run-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="ow">not</span> <span class="n">errors</span>
</span></pre></div>


            <div class="docstring"><p>Concurrently runs all snapshots in topological order.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>start:</strong>  The start of the run. Defaults to the min model start date.</li>
<li><strong>end:</strong>  The end of the run. Defaults to now.</li>
<li><strong>latest:</strong>  The latest datetime to use for non-incremental queries.</li>
<li><strong>is_dev:</strong>  Indicates whether the evaluation happens in the development mode and temporary
tables / table clones should be used where applicable.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>True if the execution was successful and False otherwise.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="compute_interval_params">
                            <input id="compute_interval_params-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_interval_params</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#SnapshotId">sqlmesh.core.snapshot.definition.SnapshotId</a></span><span class="p">,</span> <span class="n"><a href="snapshot/definition.html#SnapshotTableInfo">sqlmesh.core.snapshot.definition.SnapshotTableInfo</a></span><span class="p">,</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]]</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">snapshots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#SnapshotId">sqlmesh.core.snapshot.definition.SnapshotId</a></span><span class="p">,</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="compute_interval_params-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_interval_params"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_interval_params-289"><a href="#compute_interval_params-289"><span class="linenos">289</span></a><span class="k">def</span> <span class="nf">compute_interval_params</span><span class="p">(</span>
</span><span id="compute_interval_params-290"><a href="#compute_interval_params-290"><span class="linenos">290</span></a>    <span class="n">target</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">SnapshotIdLike</span><span class="p">],</span>
</span><span id="compute_interval_params-291"><a href="#compute_interval_params-291"><span class="linenos">291</span></a>    <span class="o">*</span><span class="p">,</span>
</span><span id="compute_interval_params-292"><a href="#compute_interval_params-292"><span class="linenos">292</span></a>    <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">SnapshotId</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">],</span>
</span><span id="compute_interval_params-293"><a href="#compute_interval_params-293"><span class="linenos">293</span></a>    <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="compute_interval_params-294"><a href="#compute_interval_params-294"><span class="linenos">294</span></a>    <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="compute_interval_params-295"><a href="#compute_interval_params-295"><span class="linenos">295</span></a>    <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="compute_interval_params-296"><a href="#compute_interval_params-296"><span class="linenos">296</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SnapshotToBatches</span><span class="p">:</span>
</span><span id="compute_interval_params-297"><a href="#compute_interval_params-297"><span class="linenos">297</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the optimal date interval paramaters based on what needs processing and maximal batch size.</span>
</span><span id="compute_interval_params-298"><a href="#compute_interval_params-298"><span class="linenos">298</span></a>
</span><span id="compute_interval_params-299"><a href="#compute_interval_params-299"><span class="linenos">299</span></a><span class="sd">    For each model name, find all dependencies and look for a stored snapshot from the metastore. If a snapshot is found,</span>
</span><span id="compute_interval_params-300"><a href="#compute_interval_params-300"><span class="linenos">300</span></a><span class="sd">    calculate the missing intervals that need to be processed given the passed in start and end intervals.</span>
</span><span id="compute_interval_params-301"><a href="#compute_interval_params-301"><span class="linenos">301</span></a>
</span><span id="compute_interval_params-302"><a href="#compute_interval_params-302"><span class="linenos">302</span></a><span class="sd">    If a snapshot&#39;s model specifies a batch size, consecutive intervals are merged into batches of a size that is less than</span>
</span><span id="compute_interval_params-303"><a href="#compute_interval_params-303"><span class="linenos">303</span></a><span class="sd">    or equal to the configured one. If no batch size is specified, then it uses the intervals that correspond to the model&#39;s cron expression.</span>
</span><span id="compute_interval_params-304"><a href="#compute_interval_params-304"><span class="linenos">304</span></a><span class="sd">    For example, if a model is supposed to run daily and has 70 days to backfill with a batch size set to 30, there would be 2 jobs</span>
</span><span id="compute_interval_params-305"><a href="#compute_interval_params-305"><span class="linenos">305</span></a><span class="sd">    with 30 days and 1 job with 10.</span>
</span><span id="compute_interval_params-306"><a href="#compute_interval_params-306"><span class="linenos">306</span></a>
</span><span id="compute_interval_params-307"><a href="#compute_interval_params-307"><span class="linenos">307</span></a><span class="sd">    Args:</span>
</span><span id="compute_interval_params-308"><a href="#compute_interval_params-308"><span class="linenos">308</span></a><span class="sd">        target: A set of target snapshots for which intervals should be computed.</span>
</span><span id="compute_interval_params-309"><a href="#compute_interval_params-309"><span class="linenos">309</span></a><span class="sd">        snapshots: A catalog of all available snapshots (including the target ones).</span>
</span><span id="compute_interval_params-310"><a href="#compute_interval_params-310"><span class="linenos">310</span></a><span class="sd">        start: Start of the interval.</span>
</span><span id="compute_interval_params-311"><a href="#compute_interval_params-311"><span class="linenos">311</span></a><span class="sd">        end: End of the interval.</span>
</span><span id="compute_interval_params-312"><a href="#compute_interval_params-312"><span class="linenos">312</span></a><span class="sd">        latest: The latest datetime to use for non-incremental queries.</span>
</span><span id="compute_interval_params-313"><a href="#compute_interval_params-313"><span class="linenos">313</span></a>
</span><span id="compute_interval_params-314"><a href="#compute_interval_params-314"><span class="linenos">314</span></a><span class="sd">    Returns:</span>
</span><span id="compute_interval_params-315"><a href="#compute_interval_params-315"><span class="linenos">315</span></a><span class="sd">        A dict containing all snapshots needing to be run with their associated interval params.</span>
</span><span id="compute_interval_params-316"><a href="#compute_interval_params-316"><span class="linenos">316</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_interval_params-317"><a href="#compute_interval_params-317"><span class="linenos">317</span></a>    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
</span><span id="compute_interval_params-318"><a href="#compute_interval_params-318"><span class="linenos">318</span></a>
</span><span id="compute_interval_params-319"><a href="#compute_interval_params-319"><span class="linenos">319</span></a>    <span class="n">snapshots_to_batches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="compute_interval_params-320"><a href="#compute_interval_params-320"><span class="linenos">320</span></a>
</span><span id="compute_interval_params-321"><a href="#compute_interval_params-321"><span class="linenos">321</span></a>    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">Snapshot</span><span class="o">.</span><span class="n">merge_snapshots</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">):</span>
</span><span id="compute_interval_params-322"><a href="#compute_interval_params-322"><span class="linenos">322</span></a>        <span class="n">model_start_dt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_date</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">)</span>
</span><span id="compute_interval_params-323"><a href="#compute_interval_params-323"><span class="linenos">323</span></a>        <span class="n">snapshots_to_batches</span><span class="p">[</span><span class="n">snapshot</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="compute_interval_params-324"><a href="#compute_interval_params-324"><span class="linenos">324</span></a>            <span class="p">(</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="compute_interval_params-325"><a href="#compute_interval_params-325"><span class="linenos">325</span></a>            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">missing_intervals</span><span class="p">(</span><span class="n">model_start_dt</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">)</span>
</span><span id="compute_interval_params-326"><a href="#compute_interval_params-326"><span class="linenos">326</span></a>        <span class="p">]</span>
</span><span id="compute_interval_params-327"><a href="#compute_interval_params-327"><span class="linenos">327</span></a>
</span><span id="compute_interval_params-328"><a href="#compute_interval_params-328"><span class="linenos">328</span></a>    <span class="k">return</span> <span class="n">_batched_intervals</span><span class="p">(</span><span class="n">snapshots_to_batches</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find the optimal date interval paramaters based on what needs processing and maximal batch size.</p>

<p>For each model name, find all dependencies and look for a stored snapshot from the metastore. If a snapshot is found,
calculate the missing intervals that need to be processed given the passed in start and end intervals.</p>

<p>If a snapshot's model specifies a batch size, consecutive intervals are merged into batches of a size that is less than
or equal to the configured one. If no batch size is specified, then it uses the intervals that correspond to the model's cron expression.
For example, if a model is supposed to run daily and has 70 days to backfill with a batch size set to 30, there would be 2 jobs
with 30 days and 1 job with 10.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>target:</strong>  A set of target snapshots for which intervals should be computed.</li>
<li><strong>snapshots:</strong>  A catalog of all available snapshots (including the target ones).</li>
<li><strong>start:</strong>  Start of the interval.</li>
<li><strong>end:</strong>  End of the interval.</li>
<li><strong>latest:</strong>  The latest datetime to use for non-incremental queries.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>A dict containing all snapshots needing to be run with their associated interval params.</p>
</blockquote>
</div>


                </section>
                <section id="start_date">
                            <input id="start_date-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_date</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">snapshot</span><span class="p">:</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span>,</span><span class="param">	<span class="n">snapshots</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#SnapshotId">sqlmesh.core.snapshot.definition.SnapshotId</a></span><span class="p">,</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="start_date-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#start_date"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="start_date-331"><a href="#start_date-331"><span class="linenos">331</span></a><span class="k">def</span> <span class="nf">start_date</span><span class="p">(</span>
</span><span id="start_date-332"><a href="#start_date-332"><span class="linenos">332</span></a>    <span class="n">snapshot</span><span class="p">:</span> <span class="n">Snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">SnapshotId</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]</span> <span class="o">|</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]</span>
</span><span id="start_date-333"><a href="#start_date-333"><span class="linenos">333</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
</span><span id="start_date-334"><a href="#start_date-334"><span class="linenos">334</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the effective/inferred start date for a snapshot.</span>
</span><span id="start_date-335"><a href="#start_date-335"><span class="linenos">335</span></a>
</span><span id="start_date-336"><a href="#start_date-336"><span class="linenos">336</span></a><span class="sd">    Not all snapshots define a start date. In those cases, the model&#39;s start date</span>
</span><span id="start_date-337"><a href="#start_date-337"><span class="linenos">337</span></a><span class="sd">    can be inferred from its parent&#39;s start date.</span>
</span><span id="start_date-338"><a href="#start_date-338"><span class="linenos">338</span></a>
</span><span id="start_date-339"><a href="#start_date-339"><span class="linenos">339</span></a><span class="sd">    Args:</span>
</span><span id="start_date-340"><a href="#start_date-340"><span class="linenos">340</span></a><span class="sd">        snapshot: snapshot to infer start date.</span>
</span><span id="start_date-341"><a href="#start_date-341"><span class="linenos">341</span></a><span class="sd">        snapshots: a catalog of available snapshots.</span>
</span><span id="start_date-342"><a href="#start_date-342"><span class="linenos">342</span></a>
</span><span id="start_date-343"><a href="#start_date-343"><span class="linenos">343</span></a><span class="sd">    Returns:</span>
</span><span id="start_date-344"><a href="#start_date-344"><span class="linenos">344</span></a><span class="sd">        Start datetime object.</span>
</span><span id="start_date-345"><a href="#start_date-345"><span class="linenos">345</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="start_date-346"><a href="#start_date-346"><span class="linenos">346</span></a>    <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
</span><span id="start_date-347"><a href="#start_date-347"><span class="linenos">347</span></a>        <span class="k">return</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
</span><span id="start_date-348"><a href="#start_date-348"><span class="linenos">348</span></a>
</span><span id="start_date-349"><a href="#start_date-349"><span class="linenos">349</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="start_date-350"><a href="#start_date-350"><span class="linenos">350</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">}</span>
</span><span id="start_date-351"><a href="#start_date-351"><span class="linenos">351</span></a>
</span><span id="start_date-352"><a href="#start_date-352"><span class="linenos">352</span></a>    <span class="n">earliest</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="start_date-353"><a href="#start_date-353"><span class="linenos">353</span></a>
</span><span id="start_date-354"><a href="#start_date-354"><span class="linenos">354</span></a>    <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
</span><span id="start_date-355"><a href="#start_date-355"><span class="linenos">355</span></a>        <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="start_date-356"><a href="#start_date-356"><span class="linenos">356</span></a>            <span class="k">continue</span>
</span><span id="start_date-357"><a href="#start_date-357"><span class="linenos">357</span></a>
</span><span id="start_date-358"><a href="#start_date-358"><span class="linenos">358</span></a>        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="n">parent</span><span class="p">],</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="start_date-359"><a href="#start_date-359"><span class="linenos">359</span></a>
</span><span id="start_date-360"><a href="#start_date-360"><span class="linenos">360</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">earliest</span><span class="p">:</span>
</span><span id="start_date-361"><a href="#start_date-361"><span class="linenos">361</span></a>            <span class="n">earliest</span> <span class="o">=</span> <span class="n">start_dt</span>
</span><span id="start_date-362"><a href="#start_date-362"><span class="linenos">362</span></a>        <span class="k">elif</span> <span class="n">start_dt</span><span class="p">:</span>
</span><span id="start_date-363"><a href="#start_date-363"><span class="linenos">363</span></a>            <span class="n">earliest</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">earliest</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">)</span>
</span><span id="start_date-364"><a href="#start_date-364"><span class="linenos">364</span></a>
</span><span id="start_date-365"><a href="#start_date-365"><span class="linenos">365</span></a>    <span class="k">return</span> <span class="n">earliest</span>
</span></pre></div>


            <div class="docstring"><p>Get the effective/inferred start date for a snapshot.</p>

<p>Not all snapshots define a start date. In those cases, the model's start date
can be inferred from its parent's start date.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>snapshot:</strong>  snapshot to infer start date.</li>
<li><strong>snapshots:</strong>  a catalog of available snapshots.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Start datetime object.</p>
</blockquote>
</div>


                </section>
                <section id="earliest_start_date">
                            <input id="earliest_start_date-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">earliest_start_date</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">snapshots</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>:</span></span>

                <label class="view-source-button" for="earliest_start_date-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#earliest_start_date"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="earliest_start_date-368"><a href="#earliest_start_date-368"><span class="linenos">368</span></a><span class="k">def</span> <span class="nf">earliest_start_date</span><span class="p">(</span><span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="earliest_start_date-369"><a href="#earliest_start_date-369"><span class="linenos">369</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the earliest start date from a collection of snapshots.</span>
</span><span id="earliest_start_date-370"><a href="#earliest_start_date-370"><span class="linenos">370</span></a>
</span><span id="earliest_start_date-371"><a href="#earliest_start_date-371"><span class="linenos">371</span></a><span class="sd">    Args:</span>
</span><span id="earliest_start_date-372"><a href="#earliest_start_date-372"><span class="linenos">372</span></a><span class="sd">        snapshots: Snapshots to find earliest start date.</span>
</span><span id="earliest_start_date-373"><a href="#earliest_start_date-373"><span class="linenos">373</span></a><span class="sd">    Returns:</span>
</span><span id="earliest_start_date-374"><a href="#earliest_start_date-374"><span class="linenos">374</span></a><span class="sd">        The earliest start date or yesterday if none is found.&quot;&quot;&quot;</span>
</span><span id="earliest_start_date-375"><a href="#earliest_start_date-375"><span class="linenos">375</span></a>    <span class="n">snapshots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span>
</span><span id="earliest_start_date-376"><a href="#earliest_start_date-376"><span class="linenos">376</span></a>    <span class="k">if</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="earliest_start_date-377"><a href="#earliest_start_date-377"><span class="linenos">377</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_date</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">snapshots</span><span class="p">)</span> <span class="ow">or</span> <span class="n">yesterday</span><span class="p">()</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="earliest_start_date-378"><a href="#earliest_start_date-378"><span class="linenos">378</span></a>    <span class="k">return</span> <span class="n">yesterday</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get the earliest start date from a collection of snapshots.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>snapshots:</strong>  Snapshots to find earliest start date.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The earliest start date or yesterday if none is found.</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>