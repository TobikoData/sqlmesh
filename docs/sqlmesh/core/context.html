<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.3.0"/>
    <title>sqlmesh.core.context API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../core.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;sqlmesh.core</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

        <h2>Contents</h2>
        <ul>
  <li><a href="#context">Context</a></li>
  <li><a href="#examples">Examples:</a></li>
</ul>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#BaseContext">BaseContext</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#BaseContext.engine_adapter">engine_adapter</a>
                        </li>
                        <li>
                                <a class="variable" href="#BaseContext.spark">spark</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseContext.table">table</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseContext.fetchdf">fetchdf</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseContext.fetch_pyspark_df">fetch_pyspark_df</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ExecutionContext">ExecutionContext</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ExecutionContext.__init__">ExecutionContext</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExecutionContext.engine_adapter">engine_adapter</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Context">Context</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Context.__init__">Context</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.engine_adapter">engine_adapter</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.upsert_model">upsert_model</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.scheduler">scheduler</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.sqlmesh_path">sqlmesh_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.models_directory_path">models_directory_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.macro_directory_path">macro_directory_path</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.hook_directory_path">hook_directory_path</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.refresh">refresh</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.load">load</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.get_model">get_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.models">models</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.macros">macros</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.hooks">hooks</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.snapshots">snapshots</a>
                        </li>
                        <li>
                                <a class="variable" href="#Context.local_snapshots">local_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.render">render</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.evaluate">evaluate</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.format">format</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.plan">plan</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.apply">apply</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.diff">diff</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.get_dag">get_dag</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.render_dag">render_dag</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.test">test</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.audit">audit</a>
                        </li>
                        <li>
                                <a class="function" href="#Context.close">close</a>
                        </li>
                </ul>

            </li>
    </ul>


            <footer>Copyright Tobiko Data Inc. 2022</footer>

        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/TobikoData/sqlmesh/core/context.py">Edit on GitHub</a>
                
                        <div class="docstring"><h1 id="context">Context</h1>

<p>A SQLMesh context encapsulates a SQLMesh environment. When you create a new context, it will discover and
load your project's models, macros, and audits. Afterwards, you can use the context to create and apply
plans, visualize your model's lineage, run your audits and model tests, and perform various other tasks.
For more information regarding what a context can do, see <code><a href="#Context">sqlmesh.core.context.Context</a></code>.</p>

<h1 id="examples">Examples:</h1>

<p>Creating and applying a plan against the staging environment.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="">sqlmesh.core.context</a></span> <span class="kn">import</span> <span class="n">Context</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="s2">&quot;local_config&quot;</span><span class="p">)</span>
<span class="n">plan</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="s2">&quot;staging&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</code></pre>
</div>

<p>Running audits on your data.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="">sqlmesh.core.context</a></span> <span class="kn">import</span> <span class="n">Context</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="s2">&quot;local_config&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span><span class="s2">&quot;yesterday&quot;</span><span class="p">,</span> <span class="s2">&quot;now&quot;</span><span class="p">)</span>
</code></pre>
</div>

<p>Running tests on your models.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span> <span class="nn"><a href="">sqlmesh.core.context</a></span> <span class="kn">import</span> <span class="n">Context</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;example&quot;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">run_tests</span><span class="p">()</span>
</code></pre>
</div>
</div>

                        <input id="mod-context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-context-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd"># Context</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">A SQLMesh context encapsulates a SQLMesh environment. When you create a new context, it will discover and</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">load your project&#39;s models, macros, and audits. Afterwards, you can use the context to create and apply</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">plans, visualize your model&#39;s lineage, run your audits and model tests, and perform various other tasks.</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">For more information regarding what a context can do, see `sqlmesh.core.context.Context`.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd"># Examples:</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">Creating and applying a plan against the staging environment.</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">```python</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">from sqlmesh.core.context import Context</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">context = Context(path=&quot;example&quot;, config=&quot;local_config&quot;)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">plan = context.plan(&quot;staging&quot;)</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">context.apply(plan)</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">```</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">Running audits on your data.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">```python</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">from sqlmesh.core.context import Context</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">context = Context(path=&quot;example&quot;, config=&quot;local_config&quot;)</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">context.audit(&quot;yesterday&quot;, &quot;now&quot;)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">```</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">Running tests on your models.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">```python</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">from sqlmesh.core.context import Context</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">context = Context(path=&quot;example&quot;)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">context.run_tests()</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">```</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="kn">import</span> <span class="nn">abc</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="kn">import</span> <span class="nn">contextlib</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="kn">import</span> <span class="nn">unittest.result</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">MappingProxyType</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="kn">from</span> <span class="nn">sqlglot</span> <span class="kn">import</span> <span class="n">exp</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">c</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core._typing</span> <span class="kn">import</span> <span class="n">NotificationTarget</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.audit</span> <span class="kn">import</span> <span class="n">Audit</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.config</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">load_config_from_paths</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.console</span> <span class="kn">import</span> <span class="n">Console</span><span class="p">,</span> <span class="n">get_console</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.context_diff</span> <span class="kn">import</span> <span class="n">ContextDiff</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.dialect</span> <span class="kn">import</span> <span class="n">format_model_expressions</span><span class="p">,</span> <span class="n">pandas_to_sql</span><span class="p">,</span> <span class="n">parse</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.engine_adapter</span> <span class="kn">import</span> <span class="n">EngineAdapter</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.environment</span> <span class="kn">import</span> <span class="n">Environment</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.hooks</span> <span class="kn">import</span> <span class="n">hook</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.loader</span> <span class="kn">import</span> <span class="n">Loader</span><span class="p">,</span> <span class="n">SqlMeshLoader</span><span class="p">,</span> <span class="n">update_model_schemas</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.macros</span> <span class="kn">import</span> <span class="n">ExecutableOrMacro</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.model</span> <span class="kn">import</span> <span class="n">Model</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.plan</span> <span class="kn">import</span> <span class="n">Plan</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.scheduler</span> <span class="kn">import</span> <span class="n">Scheduler</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.snapshot</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="n">Snapshot</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">SnapshotEvaluator</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="n">SnapshotFingerprint</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="n">to_table_mapping</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.state_sync</span> <span class="kn">import</span> <span class="n">StateReader</span><span class="p">,</span> <span class="n">StateSync</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.test</span> <span class="kn">import</span> <span class="n">run_all_model_tests</span><span class="p">,</span> <span class="n">run_model_tests</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="kn">from</span> <span class="nn">sqlmesh.core.user</span> <span class="kn">import</span> <span class="n">User</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils</span> <span class="kn">import</span> <span class="n">UniqueKeyDict</span><span class="p">,</span> <span class="n">sys_path</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.dag</span> <span class="kn">import</span> <span class="n">DAG</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.date</span> <span class="kn">import</span> <span class="n">TimeLike</span><span class="p">,</span> <span class="n">yesterday_ds</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="kn">from</span> <span class="nn">sqlmesh.utils.errors</span> <span class="kn">import</span> <span class="n">ConfigError</span><span class="p">,</span> <span class="n">MissingDependencyError</span><span class="p">,</span> <span class="n">PlanError</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="kn">import</span> <span class="nn">graphviz</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="kn">import</span> <span class="nn">pyspark</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="kn">from</span> <span class="nn">sqlmesh.core.engine_adapter._typing</span> <span class="kn">import</span> <span class="n">DF</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">ModelOrSnapshot</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="k">class</span> <span class="nc">BaseContext</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The base context which defines methods to execute a model.&quot;&quot;&quot;</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>    <span class="nd">@property</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a mapping of model names to tables.&quot;&quot;&quot;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="nd">@property</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="nd">@property</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="k">def</span> <span class="nf">spark</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SparkSession</span><span class="p">]:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the spark session if it exists.&quot;&quot;&quot;</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">spark</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the physical table name for a given model.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        Args:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            model_name: The model name.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">        Returns:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">            The physical table name.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_tables</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="nf">fetchdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a dataframe given a sql string or sqlglot expression.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">        Args:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">        Returns:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="sd">            The default dataframe is Pandas, but for Spark a PySpark dataframe is returned.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">fetch_pyspark_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a PySpark dataframe given a sql string or sqlglot expression.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        Returns:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="sd">            A PySpark dataframe.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetch_pyspark_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a><span class="k">class</span> <span class="nc">ExecutionContext</span><span class="p">(</span><span class="n">BaseContext</span><span class="p">):</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The minimal context needed to execute a model.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a><span class="sd">    Args:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">        engine_adapter: The engine adapter to execute queries against.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">        snapshots: All upstream snapshots (by model name) to use for expansion and mapping of physical locations.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">        is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">            tables / table clones should be used where applicable.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">EngineAdapter</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">],</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="p">):</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshots</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_dev</span> <span class="o">=</span> <span class="n">is_dev</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__model_tables</span> <span class="o">=</span> <span class="n">to_table_mapping</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">is_dev</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>    <span class="nd">@property</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>    <span class="nd">@property</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a mapping of model names to tables.&quot;&quot;&quot;</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model_tables</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a><span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">BaseContext</span><span class="p">):</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Encapsulates a SQLMesh environment supplying convenient functions to perform various tasks.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">    Args:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">        engine_adapter: The default engine adapter to use.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        notification_targets: The notification target to use. Defaults to what is defined in config.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="sd">        dialect: Default dialect of the sql in models.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        physical_schema: The schema used to store physical materialized tables.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a><span class="sd">        snapshot_ttl: Duration before unpromoted snapshots are removed.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        path: The directory containing SQLMesh files.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">        config: A Config object or the name of a Config object in config.py.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        connection: The name of the connection. If not specified the first connection as it appears</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">            in configuration will be used.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        test_connection: The name of the connection to use for tests. If not specified the first</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">            connection as it appears in configuration will be used.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        concurrent_tasks: The maximum number of tasks that can use the connection concurrently.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a><span class="sd">        load: Whether or not to automatically load all models and macros (default True).</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a><span class="sd">        console: The rich instance used for printing out CLI command results.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="sd">        users: A list of users to make known to SQLMesh.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">EngineAdapter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">notification_targets</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">NotificationTarget</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="n">dialect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">physical_schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>        <span class="n">snapshot_ttl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="n">config</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="n">connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="n">test_connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="n">concurrent_tasks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">loader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Loader</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">users</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="p">):</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not a directory&quot;</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_config</span><span class="p">(</span><span class="n">config</span> <span class="ow">or</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">physical_schema</span> <span class="o">=</span> <span class="n">physical_schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physical_schema</span> <span class="ow">or</span> <span class="s2">&quot;sqlmesh&quot;</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="o">=</span> <span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_SNAPSHOT_TTL</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">()</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Audit</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;audits&quot;</span><span class="p">)</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExecutableOrMacro</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;macros&quot;</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hook</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="n">connection_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span> <span class="o">=</span> <span class="n">concurrent_tasks</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="n">test_connection_config</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_connection</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">test_connection</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">test_connection</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span> <span class="o">=</span> <span class="n">test_connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_defaults</span><span class="o">.</span><span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span><span class="o">.</span><span class="n">dialect</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">SnapshotEvaluator</span><span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="p">,</span> <span class="n">ddl_concurrent_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">+</span> <span class="p">(</span><span class="n">notification_targets</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_provided_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">users</span> <span class="o">+</span> <span class="p">(</span><span class="n">users</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="p">(</span><span class="n">loader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">loader</span> <span class="ow">or</span> <span class="n">SqlMeshLoader</span><span class="p">)()</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="nd">@property</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">def</span> <span class="nf">upsert_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update or insert a model.</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">        The context&#39;s models dictionary will be updated to include these changes.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        Args:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">            model: Model name or instance to update.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">            kwargs: The kwargs to update the model with.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">        Returns:</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">            A new instance of the updated or inserted model.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_path</span>  <span class="c1"># type: ignore</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="c1"># model.copy() can&#39;t be used here due to a cached state that can be a part of a model instance.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}))</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">model</span><span class="p">})</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_model_to_dag</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>        <span class="n">update_model_schemas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scheduler</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the built-in scheduler.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        Args:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">            environment: The target environment to source model snapshots from, or None</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a><span class="sd">                if snapshots should be sourced from the currently loaded local state.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="sd">        Returns:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">            The built-in scheduler instance.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="n">stored_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>            <span class="k">if</span> <span class="n">stored_environment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment &#39;</span><span class="si">{</span><span class="n">environment</span><span class="si">}</span><span class="s2">&#39; was not found.&quot;</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">stored_environment</span><span class="o">.</span><span class="n">snapshots</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;No models were found&quot;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">Scheduler</span><span class="p">(</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="p">,</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>    <span class="nd">@property</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>    <span class="k">def</span> <span class="nf">state_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSync</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provided_state_sync</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_state_sync</span><span class="p">(</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>                <span class="bp">self</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>                    <span class="s2">&quot;The operation is not supported when using a read-only state sync&quot;</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>                <span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="o">.</span><span class="n">init_schema</span><span class="p">()</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>    <span class="nd">@property</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    <span class="k">def</span> <span class="nf">state_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateReader</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="k">except</span> <span class="n">ConfigError</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_state_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                    <span class="s2">&quot;Invalid configuration: neither State Sync nor Reader has been configured&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>                <span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>    <span class="nd">@property</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>    <span class="k">def</span> <span class="nf">sqlmesh_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the SQLMesh home directory.&quot;&quot;&quot;</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.sqlmesh&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="nd">@property</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">models_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where the models are defined&quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;models&quot;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="nd">@property</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="k">def</span> <span class="nf">macro_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where macros are defined&quot;&quot;&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;macros&quot;</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>    <span class="nd">@property</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">hook_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where hooks are defined&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;hooks&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="nd">@property</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>    <span class="k">def</span> <span class="nf">test_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>    <span class="nd">@property</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>    <span class="k">def</span> <span class="nf">audits_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;audits&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>    <span class="nd">@property</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>    <span class="k">def</span> <span class="nf">ignore_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">IGNORE_PATTERNS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ignore_patterns</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh all models that have been updated.&quot;&quot;&quot;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">reload_needed</span><span class="p">():</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all files in the context&#39;s path.&quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="k">with</span> <span class="n">sys_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">hooks</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">macros</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">models</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">audits</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dag</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="n">skip_janitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the entire dag through the scheduler.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        Args:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">            environment: The target environment to source model snapshots from. Default: prod.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">            skip_janitor: Whether to skip the jantitor task.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_janitor</span><span class="p">:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_run_janitor</span><span class="p">()</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a model with the given name or None if a model with such name doesn&#39;t exist.&quot;&quot;&quot;</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>    <span class="nd">@property</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered models in this context.&quot;&quot;&quot;</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="nd">@property</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    <span class="k">def</span> <span class="nf">macros</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExecutableOrMacro</span><span class="p">]:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered macros in this context.&quot;&quot;&quot;</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_macros</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>    <span class="nd">@property</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="k">def</span> <span class="nf">hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hook</span><span class="p">]:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered hooks in this context.&quot;&quot;&quot;</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>    <span class="nd">@property</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="k">def</span> <span class="nf">snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns snapshots based on models registered in this context.</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a><span class="sd">        If one of the snapshots has been previosly stored in the persisted state, the stored</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a><span class="sd">        instance will be returned.</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">local_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="n">stored_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">local_snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">stored_snapshots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">local_snapshots</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>    <span class="nd">@property</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="k">def</span> <span class="nf">local_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]:</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns snapshots based on models registered in this context without reconciling them</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="sd">        with the persisted state.</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>        <span class="n">local_snapshots</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="n">fingerprint_cache</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SnapshotFingerprint</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">Snapshot</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="n">model</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>                <span class="n">physical_schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_schema</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>                <span class="n">models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>                <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshot_ttl</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>                <span class="n">audits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_audits</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>                <span class="n">cache</span><span class="o">=</span><span class="n">fingerprint_cache</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">local_snapshots</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="n">local_snapshots</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="n">expand</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Renders a model&#39;s query, expanding macros with provided kwargs, and optionally expanding referenced models.</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        Args:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a><span class="sd">            expand: Whether or not to use expand materialized models, defaults to False.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a><span class="sd">                If True, all referenced models are expanded as raw queries.</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="sd">                If a list, only referenced models are expanded as raw queries.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">        Returns:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">            The rendered expression.</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">yesterday_ds</span><span class="p">()</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">model</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="n">expand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">upstream</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">expand</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">expand</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">is_seed</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">pandas_to_sql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">columns_to_types</span><span class="p">))</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">render_query</span><span class="p">(</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>            <span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">,</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>        <span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DF</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a model or snapshot (running its query against a DB/Engine).</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">        This method is used to test or iterate on models without side effects.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">        Args:</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="sd">            start: The start of the interval to evaluate.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">            end: The end of the interval to evaluate.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">            limit: A limit applied to the model.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_MAX_LIMIT</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error evaluating </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="k">return</span> <span class="n">df</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format all models in a given directory.&quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_sql</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="k">continue</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="n">expressions</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">default_dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_model_expressions</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>        <span class="n">create_from</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="n">restate_models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="n">no_gaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="n">skip_backfill</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="n">forward_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="n">no_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>        <span class="n">auto_apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="n">no_auto_categorization</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Plan</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interactively create a migration plan.</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a><span class="sd">        This method compares the current context with an environment. It then presents</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a><span class="sd">        the differences and asks whether to backfill each modified model.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a><span class="sd">        Args:</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a><span class="sd">            environment: The environment to diff and plan against.</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="sd">            start: The start date of the backfill if there is one.</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">            end: The end date of the backfill if there is one.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a><span class="sd">            create_from: The environment to create the target environment from if it</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">                doesn&#39;t exist. If not specified, the &quot;prod&quot; environment will be used.</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">            skip_tests: Unit tests are run by default so this will skip them if enabled</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">            restate_models: A list of of either internal or external models that need to be restated</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">                for the given plan interval. If the target environment is a production environment,</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">                ALL snapshots that depended on these upstream tables will have their intervals deleted</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="sd">                (even ones not in this current environment). Only the snapshots in this environment will</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="sd">                be backfilled whereas others need to be recovered on a future plan application. For development</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">                environments only snapshots that are part of this plan will be affected.</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">            no_gaps:  Whether to ensure that new snapshots for models that are already a</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">                part of the target environment have no data gaps when compared against previous</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="sd">                snapshots for same models.</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a><span class="sd">            skip_backfill: Whether to skip the backfill step. Default: False.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a><span class="sd">            forward_only: Whether the purpose of the plan is to make forward only changes.</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a><span class="sd">            no_prompts: Whether to disable interactive prompts for the backfill time range. Please note that</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a><span class="sd">                if this flag is set to true and there are uncategorized changes the plan creation will</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a><span class="sd">                fail. Default: False.</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="sd">            auto_apply: Whether to automatically apply the new plan after creation. Default: False.</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a><span class="sd">            no_auto_categorization: Indicates whether to disable automatic categorization of model</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a><span class="sd">                changes (breaking / non-breaking). If not provided, then the corresponding configuration</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a><span class="sd">                option determines the behavior.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="sd">        Returns:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a><span class="sd">            The populated Plan object.</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="k">if</span> <span class="n">skip_backfill</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_gaps</span> <span class="ow">and</span> <span class="n">environment</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">:</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                <span class="s2">&quot;When targeting the production enviornment either the backfill should not be skipped or the lack of data gaps should be enforced (--no-gaps flag).&quot;</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_run_plan_tests</span><span class="p">(</span><span class="n">skip_tests</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>            <span class="n">context_diff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span> <span class="n">create_from</span><span class="o">=</span><span class="n">create_from</span><span class="p">),</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="n">dag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>            <span class="n">state_reader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>            <span class="n">apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>            <span class="n">restate_models</span><span class="o">=</span><span class="n">restate_models</span><span class="p">,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">no_gaps</span><span class="o">=</span><span class="n">no_gaps</span><span class="p">,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>            <span class="n">skip_backfill</span><span class="o">=</span><span class="n">skip_backfill</span><span class="p">,</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">environment</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>            <span class="n">forward_only</span><span class="o">=</span><span class="n">forward_only</span><span class="p">,</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>            <span class="n">environment_ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">environment_ttl</span><span class="p">,</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>            <span class="n">categorizer_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auto_categorize_changes</span><span class="p">,</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>            <span class="n">auto_categorization_enabled</span><span class="o">=</span><span class="ow">not</span> <span class="n">no_auto_categorization</span><span class="p">,</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_prompts</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">auto_apply</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>        <span class="k">elif</span> <span class="n">auto_apply</span><span class="p">:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        <span class="k">return</span> <span class="n">plan</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies a plan by pushing snapshots and backfilling data.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">        Given a plan, it pushes snapshots into the state sync and then uses the scheduler</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="sd">        to backfill all models.</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="sd">        Args:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a><span class="sd">            plan: The plan to apply.</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">context_diff</span><span class="o">.</span><span class="n">has_changes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">requires_backfill</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="k">return</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">plan</span><span class="o">.</span><span class="n">uncategorized</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>            <span class="k">raise</span> <span class="n">PlanError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t apply a plan with uncategorized changes.&quot;</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_plan_evaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a diff of the current context with a given environment.</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a><span class="sd">        Args:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a><span class="sd">            environment: The environment to diff against.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a><span class="sd">            detailed: Show the actual SQL differences if True.</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_model_difference_summary</span><span class="p">(</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">),</span> <span class="n">detailed</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="p">)</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>    <span class="k">def</span> <span class="nf">get_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;svg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a graphviz dag.</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a><span class="sd">        To display within Databricks:</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a><span class="sd">        displayHTML(context.get_dag().pipe(encoding=&#39;utf-8&#39;))</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a><span class="sd">        Args:</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a><span class="sd">            format: The desired format to use for representing the graph</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="kn">from</span> <span class="nn">sqlmesh</span> <span class="kn">import</span> <span class="n">runtime_env</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>            <span class="kn">import</span> <span class="nn">graphviz</span>  <span class="c1"># type: ignore</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>            <span class="k">if</span> <span class="n">runtime_env</span><span class="o">.</span><span class="n">is_databricks</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>                <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>                    <span class="s2">&quot;Rendering a dag requires graphviz. Run `pip install graphviz` and then `sudo apt-get install -y python3-dev graphviz libgraphviz-dev pkg-config`&quot;</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                <span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>                <span class="s2">&quot;Rendering a dag requires a manual install of graphviz. Run `pip install graphviz` and then install graphviz library: https://graphviz.org/download/.&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">node_attr</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;box&quot;</span><span class="p">},</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">upstream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>            <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upstream</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>                <span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="k">return</span> <span class="n">graph</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>    <span class="k">def</span> <span class="nf">render_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the dag using graphviz.</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a><span class="sd">        Args:</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a><span class="sd">            path: filename to save the dag to</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a><span class="sd">            format: The desired format to use when rending the dag</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dag</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>            <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>        <span class="k">except</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">ExecutableNotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>                <span class="s2">&quot;Graphviz is pip-installed but the system install is missing. Instructions: https://graphviz.org/download/&quot;</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="n">match_patterns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>        <span class="n">tests</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover and run model tests&quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>            <span class="k">if</span> <span class="n">tests</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_model_tests</span><span class="p">(</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>                    <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                <span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_all_model_tests</span><span class="p">(</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_directory_path</span><span class="p">,</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>                <span class="p">)</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>    <span class="k">def</span> <span class="nf">audit</span><span class="p">(</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>        <span class="n">models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Audit models.</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">        Args:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">            start: The start of the interval to audit.</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">            end: The end of the interval to audit.</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a><span class="sd">            models: The models to audit. All models will be audited if not specified.</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span> <span class="k">if</span> <span class="n">models</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>        <span class="n">num_audits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">audits</span><span class="p">)</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_audits</span><span class="si">}</span><span class="s2"> audit(s).&quot;</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>            <span class="k">for</span> <span class="n">audit_result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>                <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>                <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>                <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>                <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>            <span class="p">):</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>                <span class="k">if</span> <span class="n">audit_result</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audit_result</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> FAIL.&quot;</span><span class="p">)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PASS.&quot;</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> audit error(s).&quot;</span><span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failure in audit </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">_path</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>            <span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> results, expected 0.&quot;</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Releases all resources allocated by this context.&quot;&quot;&quot;</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>    <span class="k">def</span> <span class="nf">_run_plan_tests</span><span class="p">(</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_tests</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>            <span class="n">test_output_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">test_output_io</span><span class="p">):</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>            <span class="n">test_output</span> <span class="o">=</span> <span class="n">test_output_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_test_results</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">test_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>                <span class="k">raise</span> <span class="n">PlanError</span><span class="p">(</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>                    <span class="s2">&quot;Cannot generate plan due to failing test(s). Fix test(s) and run again&quot;</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>                <span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">test_output</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>    <span class="nd">@property</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping of model name to physical table name.</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="sd">        If a snapshot has not been versioned yet, its view name will be returned.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">table_name</span><span class="p">()</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>            <span class="k">else</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">qualified_view_name</span><span class="o">.</span><span class="n">for_environment</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>        <span class="p">}</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>    <span class="k">def</span> <span class="nf">_context_diff</span><span class="p">(</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Environment</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>        <span class="n">create_from</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextDiff</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>        <span class="k">return</span> <span class="n">ContextDiff</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>            <span class="n">environment</span><span class="p">,</span> <span class="n">snapshots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">create_from</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>        <span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>    <span class="k">def</span> <span class="nf">_load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Config</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Config</span><span class="p">:</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">Config</span><span class="p">):</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>            <span class="k">return</span> <span class="n">config</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>        <span class="n">lookup_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sqlmesh_path</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">,</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sqlmesh_path</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.py&quot;</span><span class="p">,</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">,</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>        <span class="p">]</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>        <span class="k">return</span> <span class="n">load_config_from_paths</span><span class="p">(</span><span class="o">*</span><span class="n">lookup_paths</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>    <span class="k">def</span> <span class="nf">_add_model_to_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">depends_on</span><span class="p">)</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>    <span class="k">def</span> <span class="nf">_run_janitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>        <span class="n">expired_environments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">delete_expired_environments</span><span class="p">()</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>        <span class="k">for</span> <span class="n">expired_environment</span> <span class="ow">in</span> <span class="n">expired_environments</span><span class="p">:</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">expired_environment</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">expired_environment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>        <span class="n">expired_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">delete_expired_snapshots</span><span class="p">()</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">expired_snapshots</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="BaseContext">
                            <input id="BaseContext-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BaseContext</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="BaseContext-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseContext"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseContext-85"><a href="#BaseContext-85"><span class="linenos"> 85</span></a><span class="k">class</span> <span class="nc">BaseContext</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="BaseContext-86"><a href="#BaseContext-86"><span class="linenos"> 86</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The base context which defines methods to execute a model.&quot;&quot;&quot;</span>
</span><span id="BaseContext-87"><a href="#BaseContext-87"><span class="linenos"> 87</span></a>
</span><span id="BaseContext-88"><a href="#BaseContext-88"><span class="linenos"> 88</span></a>    <span class="nd">@property</span>
</span><span id="BaseContext-89"><a href="#BaseContext-89"><span class="linenos"> 89</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="BaseContext-90"><a href="#BaseContext-90"><span class="linenos"> 90</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="BaseContext-91"><a href="#BaseContext-91"><span class="linenos"> 91</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a mapping of model names to tables.&quot;&quot;&quot;</span>
</span><span id="BaseContext-92"><a href="#BaseContext-92"><span class="linenos"> 92</span></a>
</span><span id="BaseContext-93"><a href="#BaseContext-93"><span class="linenos"> 93</span></a>    <span class="nd">@property</span>
</span><span id="BaseContext-94"><a href="#BaseContext-94"><span class="linenos"> 94</span></a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
</span><span id="BaseContext-95"><a href="#BaseContext-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="BaseContext-96"><a href="#BaseContext-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="BaseContext-97"><a href="#BaseContext-97"><span class="linenos"> 97</span></a>
</span><span id="BaseContext-98"><a href="#BaseContext-98"><span class="linenos"> 98</span></a>    <span class="nd">@property</span>
</span><span id="BaseContext-99"><a href="#BaseContext-99"><span class="linenos"> 99</span></a>    <span class="k">def</span> <span class="nf">spark</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">SparkSession</span><span class="p">]:</span>
</span><span id="BaseContext-100"><a href="#BaseContext-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the spark session if it exists.&quot;&quot;&quot;</span>
</span><span id="BaseContext-101"><a href="#BaseContext-101"><span class="linenos">101</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">spark</span>
</span><span id="BaseContext-102"><a href="#BaseContext-102"><span class="linenos">102</span></a>
</span><span id="BaseContext-103"><a href="#BaseContext-103"><span class="linenos">103</span></a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="BaseContext-104"><a href="#BaseContext-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the physical table name for a given model.</span>
</span><span id="BaseContext-105"><a href="#BaseContext-105"><span class="linenos">105</span></a>
</span><span id="BaseContext-106"><a href="#BaseContext-106"><span class="linenos">106</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext-107"><a href="#BaseContext-107"><span class="linenos">107</span></a><span class="sd">            model_name: The model name.</span>
</span><span id="BaseContext-108"><a href="#BaseContext-108"><span class="linenos">108</span></a>
</span><span id="BaseContext-109"><a href="#BaseContext-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext-110"><a href="#BaseContext-110"><span class="linenos">110</span></a><span class="sd">            The physical table name.</span>
</span><span id="BaseContext-111"><a href="#BaseContext-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext-112"><a href="#BaseContext-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_tables</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
</span><span id="BaseContext-113"><a href="#BaseContext-113"><span class="linenos">113</span></a>
</span><span id="BaseContext-114"><a href="#BaseContext-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="nf">fetchdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="BaseContext-115"><a href="#BaseContext-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a dataframe given a sql string or sqlglot expression.</span>
</span><span id="BaseContext-116"><a href="#BaseContext-116"><span class="linenos">116</span></a>
</span><span id="BaseContext-117"><a href="#BaseContext-117"><span class="linenos">117</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext-118"><a href="#BaseContext-118"><span class="linenos">118</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="BaseContext-119"><a href="#BaseContext-119"><span class="linenos">119</span></a>
</span><span id="BaseContext-120"><a href="#BaseContext-120"><span class="linenos">120</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext-121"><a href="#BaseContext-121"><span class="linenos">121</span></a><span class="sd">            The default dataframe is Pandas, but for Spark a PySpark dataframe is returned.</span>
</span><span id="BaseContext-122"><a href="#BaseContext-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext-123"><a href="#BaseContext-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="BaseContext-124"><a href="#BaseContext-124"><span class="linenos">124</span></a>
</span><span id="BaseContext-125"><a href="#BaseContext-125"><span class="linenos">125</span></a>    <span class="k">def</span> <span class="nf">fetch_pyspark_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="BaseContext-126"><a href="#BaseContext-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a PySpark dataframe given a sql string or sqlglot expression.</span>
</span><span id="BaseContext-127"><a href="#BaseContext-127"><span class="linenos">127</span></a>
</span><span id="BaseContext-128"><a href="#BaseContext-128"><span class="linenos">128</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext-129"><a href="#BaseContext-129"><span class="linenos">129</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="BaseContext-130"><a href="#BaseContext-130"><span class="linenos">130</span></a>
</span><span id="BaseContext-131"><a href="#BaseContext-131"><span class="linenos">131</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext-132"><a href="#BaseContext-132"><span class="linenos">132</span></a><span class="sd">            A PySpark dataframe.</span>
</span><span id="BaseContext-133"><a href="#BaseContext-133"><span class="linenos">133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext-134"><a href="#BaseContext-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetch_pyspark_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The base context which defines methods to execute a model.</p>
</div>


                            <div id="BaseContext.engine_adapter" class="classattr">
                                <div class="attr variable">
            <span class="name">engine_adapter</span><span class="annotation">: <a href="engine_adapter/base.html#EngineAdapter">sqlmesh.core.engine_adapter.base.EngineAdapter</a></span>

        
    </div>
    <a class="headerlink" href="#BaseContext.engine_adapter"></a>
    
            <div class="docstring"><p>Returns an engine adapter.</p>
</div>


                            </div>
                            <div id="BaseContext.spark" class="classattr">
                                <div class="attr variable">
            <span class="name">spark</span><span class="annotation">: Optional[pyspark.sql.session.SparkSession]</span>

        
    </div>
    <a class="headerlink" href="#BaseContext.spark"></a>
    
            <div class="docstring"><p>Returns the spark session if it exists.</p>
</div>


                            </div>
                            <div id="BaseContext.table" class="classattr">
                                        <input id="BaseContext.table-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">table</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="BaseContext.table-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseContext.table"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseContext.table-103"><a href="#BaseContext.table-103"><span class="linenos">103</span></a>    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="BaseContext.table-104"><a href="#BaseContext.table-104"><span class="linenos">104</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the physical table name for a given model.</span>
</span><span id="BaseContext.table-105"><a href="#BaseContext.table-105"><span class="linenos">105</span></a>
</span><span id="BaseContext.table-106"><a href="#BaseContext.table-106"><span class="linenos">106</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext.table-107"><a href="#BaseContext.table-107"><span class="linenos">107</span></a><span class="sd">            model_name: The model name.</span>
</span><span id="BaseContext.table-108"><a href="#BaseContext.table-108"><span class="linenos">108</span></a>
</span><span id="BaseContext.table-109"><a href="#BaseContext.table-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext.table-110"><a href="#BaseContext.table-110"><span class="linenos">110</span></a><span class="sd">            The physical table name.</span>
</span><span id="BaseContext.table-111"><a href="#BaseContext.table-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext.table-112"><a href="#BaseContext.table-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_tables</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Gets the physical table name for a given model.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>model_name:</strong>  The model name.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The physical table name.</p>
</blockquote>
</div>


                            </div>
                            <div id="BaseContext.fetchdf" class="classattr">
                                        <input id="BaseContext.fetchdf-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fetchdf</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">sqlglot</span><span class="o">.</span><span class="n">expressions</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="BaseContext.fetchdf-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseContext.fetchdf"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseContext.fetchdf-114"><a href="#BaseContext.fetchdf-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="nf">fetchdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="BaseContext.fetchdf-115"><a href="#BaseContext.fetchdf-115"><span class="linenos">115</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a dataframe given a sql string or sqlglot expression.</span>
</span><span id="BaseContext.fetchdf-116"><a href="#BaseContext.fetchdf-116"><span class="linenos">116</span></a>
</span><span id="BaseContext.fetchdf-117"><a href="#BaseContext.fetchdf-117"><span class="linenos">117</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext.fetchdf-118"><a href="#BaseContext.fetchdf-118"><span class="linenos">118</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="BaseContext.fetchdf-119"><a href="#BaseContext.fetchdf-119"><span class="linenos">119</span></a>
</span><span id="BaseContext.fetchdf-120"><a href="#BaseContext.fetchdf-120"><span class="linenos">120</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext.fetchdf-121"><a href="#BaseContext.fetchdf-121"><span class="linenos">121</span></a><span class="sd">            The default dataframe is Pandas, but for Spark a PySpark dataframe is returned.</span>
</span><span id="BaseContext.fetchdf-122"><a href="#BaseContext.fetchdf-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext.fetchdf-123"><a href="#BaseContext.fetchdf-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetchdf</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Fetches a dataframe given a sql string or sqlglot expression.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>query:</strong>  SQL string or sqlglot expression.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The default dataframe is Pandas, but for Spark a PySpark dataframe is returned.</p>
</blockquote>
</div>


                            </div>
                            <div id="BaseContext.fetch_pyspark_df" class="classattr">
                                        <input id="BaseContext.fetch_pyspark_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fetch_pyspark_df</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">sqlglot</span><span class="o">.</span><span class="n">expressions</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="BaseContext.fetch_pyspark_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseContext.fetch_pyspark_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseContext.fetch_pyspark_df-125"><a href="#BaseContext.fetch_pyspark_df-125"><span class="linenos">125</span></a>    <span class="k">def</span> <span class="nf">fetch_pyspark_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="BaseContext.fetch_pyspark_df-126"><a href="#BaseContext.fetch_pyspark_df-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetches a PySpark dataframe given a sql string or sqlglot expression.</span>
</span><span id="BaseContext.fetch_pyspark_df-127"><a href="#BaseContext.fetch_pyspark_df-127"><span class="linenos">127</span></a>
</span><span id="BaseContext.fetch_pyspark_df-128"><a href="#BaseContext.fetch_pyspark_df-128"><span class="linenos">128</span></a><span class="sd">        Args:</span>
</span><span id="BaseContext.fetch_pyspark_df-129"><a href="#BaseContext.fetch_pyspark_df-129"><span class="linenos">129</span></a><span class="sd">            query: SQL string or sqlglot expression.</span>
</span><span id="BaseContext.fetch_pyspark_df-130"><a href="#BaseContext.fetch_pyspark_df-130"><span class="linenos">130</span></a>
</span><span id="BaseContext.fetch_pyspark_df-131"><a href="#BaseContext.fetch_pyspark_df-131"><span class="linenos">131</span></a><span class="sd">        Returns:</span>
</span><span id="BaseContext.fetch_pyspark_df-132"><a href="#BaseContext.fetch_pyspark_df-132"><span class="linenos">132</span></a><span class="sd">            A PySpark dataframe.</span>
</span><span id="BaseContext.fetch_pyspark_df-133"><a href="#BaseContext.fetch_pyspark_df-133"><span class="linenos">133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseContext.fetch_pyspark_df-134"><a href="#BaseContext.fetch_pyspark_df-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="o">.</span><span class="n">fetch_pyspark_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Fetches a PySpark dataframe given a sql string or sqlglot expression.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>query:</strong>  SQL string or sqlglot expression.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>A PySpark dataframe.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="ExecutionContext">
                            <input id="ExecutionContext-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ExecutionContext</span><wbr>(<span class="base"><a href="#BaseContext">BaseContext</a></span>):

                <label class="view-source-button" for="ExecutionContext-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExecutionContext"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExecutionContext-137"><a href="#ExecutionContext-137"><span class="linenos">137</span></a><span class="k">class</span> <span class="nc">ExecutionContext</span><span class="p">(</span><span class="n">BaseContext</span><span class="p">):</span>
</span><span id="ExecutionContext-138"><a href="#ExecutionContext-138"><span class="linenos">138</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The minimal context needed to execute a model.</span>
</span><span id="ExecutionContext-139"><a href="#ExecutionContext-139"><span class="linenos">139</span></a>
</span><span id="ExecutionContext-140"><a href="#ExecutionContext-140"><span class="linenos">140</span></a><span class="sd">    Args:</span>
</span><span id="ExecutionContext-141"><a href="#ExecutionContext-141"><span class="linenos">141</span></a><span class="sd">        engine_adapter: The engine adapter to execute queries against.</span>
</span><span id="ExecutionContext-142"><a href="#ExecutionContext-142"><span class="linenos">142</span></a><span class="sd">        snapshots: All upstream snapshots (by model name) to use for expansion and mapping of physical locations.</span>
</span><span id="ExecutionContext-143"><a href="#ExecutionContext-143"><span class="linenos">143</span></a><span class="sd">        is_dev: Indicates whether the evaluation happens in the development mode and temporary</span>
</span><span id="ExecutionContext-144"><a href="#ExecutionContext-144"><span class="linenos">144</span></a><span class="sd">            tables / table clones should be used where applicable.</span>
</span><span id="ExecutionContext-145"><a href="#ExecutionContext-145"><span class="linenos">145</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ExecutionContext-146"><a href="#ExecutionContext-146"><span class="linenos">146</span></a>
</span><span id="ExecutionContext-147"><a href="#ExecutionContext-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ExecutionContext-148"><a href="#ExecutionContext-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExecutionContext-149"><a href="#ExecutionContext-149"><span class="linenos">149</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">EngineAdapter</span><span class="p">,</span>
</span><span id="ExecutionContext-150"><a href="#ExecutionContext-150"><span class="linenos">150</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">],</span>
</span><span id="ExecutionContext-151"><a href="#ExecutionContext-151"><span class="linenos">151</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="ExecutionContext-152"><a href="#ExecutionContext-152"><span class="linenos">152</span></a>    <span class="p">):</span>
</span><span id="ExecutionContext-153"><a href="#ExecutionContext-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshots</span>
</span><span id="ExecutionContext-154"><a href="#ExecutionContext-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_dev</span> <span class="o">=</span> <span class="n">is_dev</span>
</span><span id="ExecutionContext-155"><a href="#ExecutionContext-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span>
</span><span id="ExecutionContext-156"><a href="#ExecutionContext-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__model_tables</span> <span class="o">=</span> <span class="n">to_table_mapping</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">is_dev</span><span class="p">)</span>
</span><span id="ExecutionContext-157"><a href="#ExecutionContext-157"><span class="linenos">157</span></a>
</span><span id="ExecutionContext-158"><a href="#ExecutionContext-158"><span class="linenos">158</span></a>    <span class="nd">@property</span>
</span><span id="ExecutionContext-159"><a href="#ExecutionContext-159"><span class="linenos">159</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="ExecutionContext-160"><a href="#ExecutionContext-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="ExecutionContext-161"><a href="#ExecutionContext-161"><span class="linenos">161</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span>
</span><span id="ExecutionContext-162"><a href="#ExecutionContext-162"><span class="linenos">162</span></a>
</span><span id="ExecutionContext-163"><a href="#ExecutionContext-163"><span class="linenos">163</span></a>    <span class="nd">@property</span>
</span><span id="ExecutionContext-164"><a href="#ExecutionContext-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="ExecutionContext-165"><a href="#ExecutionContext-165"><span class="linenos">165</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a mapping of model names to tables.&quot;&quot;&quot;</span>
</span><span id="ExecutionContext-166"><a href="#ExecutionContext-166"><span class="linenos">166</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model_tables</span>
</span></pre></div>


            <div class="docstring"><p>The minimal context needed to execute a model.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>engine_adapter:</strong>  The engine adapter to execute queries against.</li>
<li><strong>snapshots:</strong>  All upstream snapshots (by model name) to use for expansion and mapping of physical locations.</li>
<li><strong>is_dev:</strong>  Indicates whether the evaluation happens in the development mode and temporary
tables / table clones should be used where applicable.</li>
</ul>
</div>


                            <div id="ExecutionContext.__init__" class="classattr">
                                        <input id="ExecutionContext.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ExecutionContext</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">engine_adapter</span><span class="p">:</span> <span class="n"><a href="engine_adapter/base.html#EngineAdapter">sqlmesh.core.engine_adapter.base.EngineAdapter</a></span>,</span><span class="param">	<span class="n">snapshots</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span></span>)</span>

                <label class="view-source-button" for="ExecutionContext.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExecutionContext.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExecutionContext.__init__-147"><a href="#ExecutionContext.__init__-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ExecutionContext.__init__-148"><a href="#ExecutionContext.__init__-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ExecutionContext.__init__-149"><a href="#ExecutionContext.__init__-149"><span class="linenos">149</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">EngineAdapter</span><span class="p">,</span>
</span><span id="ExecutionContext.__init__-150"><a href="#ExecutionContext.__init__-150"><span class="linenos">150</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">],</span>
</span><span id="ExecutionContext.__init__-151"><a href="#ExecutionContext.__init__-151"><span class="linenos">151</span></a>        <span class="n">is_dev</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="ExecutionContext.__init__-152"><a href="#ExecutionContext.__init__-152"><span class="linenos">152</span></a>    <span class="p">):</span>
</span><span id="ExecutionContext.__init__-153"><a href="#ExecutionContext.__init__-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshots</span>
</span><span id="ExecutionContext.__init__-154"><a href="#ExecutionContext.__init__-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_dev</span> <span class="o">=</span> <span class="n">is_dev</span>
</span><span id="ExecutionContext.__init__-155"><a href="#ExecutionContext.__init__-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span>
</span><span id="ExecutionContext.__init__-156"><a href="#ExecutionContext.__init__-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__model_tables</span> <span class="o">=</span> <span class="n">to_table_mapping</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">is_dev</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ExecutionContext.engine_adapter" class="classattr">
                                <div class="attr variable">
            <span class="name">engine_adapter</span><span class="annotation">: <a href="engine_adapter/base.html#EngineAdapter">sqlmesh.core.engine_adapter.base.EngineAdapter</a></span>

        
    </div>
    <a class="headerlink" href="#ExecutionContext.engine_adapter"></a>
    
            <div class="docstring"><p>Returns an engine adapter.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseContext">BaseContext</a></dt>
                                <dd id="ExecutionContext.spark" class="variable"><a href="#BaseContext.spark">spark</a></dd>
                <dd id="ExecutionContext.table" class="function"><a href="#BaseContext.table">table</a></dd>
                <dd id="ExecutionContext.fetchdf" class="function"><a href="#BaseContext.fetchdf">fetchdf</a></dd>
                <dd id="ExecutionContext.fetch_pyspark_df" class="function"><a href="#BaseContext.fetch_pyspark_df">fetch_pyspark_df</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Context">
                            <input id="Context-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Context</span><wbr>(<span class="base"><a href="#BaseContext">BaseContext</a></span>):

                <label class="view-source-button" for="Context-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context-169"><a href="#Context-169"><span class="linenos">169</span></a><span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="n">BaseContext</span><span class="p">):</span>
</span><span id="Context-170"><a href="#Context-170"><span class="linenos">170</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Encapsulates a SQLMesh environment supplying convenient functions to perform various tasks.</span>
</span><span id="Context-171"><a href="#Context-171"><span class="linenos">171</span></a>
</span><span id="Context-172"><a href="#Context-172"><span class="linenos">172</span></a><span class="sd">    Args:</span>
</span><span id="Context-173"><a href="#Context-173"><span class="linenos">173</span></a><span class="sd">        engine_adapter: The default engine adapter to use.</span>
</span><span id="Context-174"><a href="#Context-174"><span class="linenos">174</span></a><span class="sd">        notification_targets: The notification target to use. Defaults to what is defined in config.</span>
</span><span id="Context-175"><a href="#Context-175"><span class="linenos">175</span></a><span class="sd">        dialect: Default dialect of the sql in models.</span>
</span><span id="Context-176"><a href="#Context-176"><span class="linenos">176</span></a><span class="sd">        physical_schema: The schema used to store physical materialized tables.</span>
</span><span id="Context-177"><a href="#Context-177"><span class="linenos">177</span></a><span class="sd">        snapshot_ttl: Duration before unpromoted snapshots are removed.</span>
</span><span id="Context-178"><a href="#Context-178"><span class="linenos">178</span></a><span class="sd">        path: The directory containing SQLMesh files.</span>
</span><span id="Context-179"><a href="#Context-179"><span class="linenos">179</span></a><span class="sd">        config: A Config object or the name of a Config object in config.py.</span>
</span><span id="Context-180"><a href="#Context-180"><span class="linenos">180</span></a><span class="sd">        connection: The name of the connection. If not specified the first connection as it appears</span>
</span><span id="Context-181"><a href="#Context-181"><span class="linenos">181</span></a><span class="sd">            in configuration will be used.</span>
</span><span id="Context-182"><a href="#Context-182"><span class="linenos">182</span></a><span class="sd">        test_connection: The name of the connection to use for tests. If not specified the first</span>
</span><span id="Context-183"><a href="#Context-183"><span class="linenos">183</span></a><span class="sd">            connection as it appears in configuration will be used.</span>
</span><span id="Context-184"><a href="#Context-184"><span class="linenos">184</span></a><span class="sd">        concurrent_tasks: The maximum number of tasks that can use the connection concurrently.</span>
</span><span id="Context-185"><a href="#Context-185"><span class="linenos">185</span></a><span class="sd">        load: Whether or not to automatically load all models and macros (default True).</span>
</span><span id="Context-186"><a href="#Context-186"><span class="linenos">186</span></a><span class="sd">        console: The rich instance used for printing out CLI command results.</span>
</span><span id="Context-187"><a href="#Context-187"><span class="linenos">187</span></a><span class="sd">        users: A list of users to make known to SQLMesh.</span>
</span><span id="Context-188"><a href="#Context-188"><span class="linenos">188</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Context-189"><a href="#Context-189"><span class="linenos">189</span></a>
</span><span id="Context-190"><a href="#Context-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Context-191"><a href="#Context-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-192"><a href="#Context-192"><span class="linenos">192</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">EngineAdapter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-193"><a href="#Context-193"><span class="linenos">193</span></a>        <span class="n">notification_targets</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">NotificationTarget</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-194"><a href="#Context-194"><span class="linenos">194</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-195"><a href="#Context-195"><span class="linenos">195</span></a>        <span class="n">dialect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context-196"><a href="#Context-196"><span class="linenos">196</span></a>        <span class="n">physical_schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context-197"><a href="#Context-197"><span class="linenos">197</span></a>        <span class="n">snapshot_ttl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context-198"><a href="#Context-198"><span class="linenos">198</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context-199"><a href="#Context-199"><span class="linenos">199</span></a>        <span class="n">config</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-200"><a href="#Context-200"><span class="linenos">200</span></a>        <span class="n">connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-201"><a href="#Context-201"><span class="linenos">201</span></a>        <span class="n">test_connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-202"><a href="#Context-202"><span class="linenos">202</span></a>        <span class="n">concurrent_tasks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-203"><a href="#Context-203"><span class="linenos">203</span></a>        <span class="n">loader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Loader</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-204"><a href="#Context-204"><span class="linenos">204</span></a>        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Context-205"><a href="#Context-205"><span class="linenos">205</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-206"><a href="#Context-206"><span class="linenos">206</span></a>        <span class="n">users</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-207"><a href="#Context-207"><span class="linenos">207</span></a>    <span class="p">):</span>
</span><span id="Context-208"><a href="#Context-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span><span id="Context-209"><a href="#Context-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
</span><span id="Context-210"><a href="#Context-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="Context-211"><a href="#Context-211"><span class="linenos">211</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not a directory&quot;</span><span class="p">)</span>
</span><span id="Context-212"><a href="#Context-212"><span class="linenos">212</span></a>
</span><span id="Context-213"><a href="#Context-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_config</span><span class="p">(</span><span class="n">config</span> <span class="ow">or</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
</span><span id="Context-214"><a href="#Context-214"><span class="linenos">214</span></a>
</span><span id="Context-215"><a href="#Context-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">physical_schema</span> <span class="o">=</span> <span class="n">physical_schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physical_schema</span> <span class="ow">or</span> <span class="s2">&quot;sqlmesh&quot;</span>
</span><span id="Context-216"><a href="#Context-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="o">=</span> <span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_SNAPSHOT_TTL</span>
</span><span id="Context-217"><a href="#Context-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">()</span>
</span><span id="Context-218"><a href="#Context-218"><span class="linenos">218</span></a>
</span><span id="Context-219"><a href="#Context-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
</span><span id="Context-220"><a href="#Context-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Audit</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;audits&quot;</span><span class="p">)</span>
</span><span id="Context-221"><a href="#Context-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExecutableOrMacro</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;macros&quot;</span><span class="p">)</span>
</span><span id="Context-222"><a href="#Context-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hook</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
</span><span id="Context-223"><a href="#Context-223"><span class="linenos">223</span></a>
</span><span id="Context-224"><a href="#Context-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span id="Context-225"><a href="#Context-225"><span class="linenos">225</span></a>        <span class="n">connection_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</span><span id="Context-226"><a href="#Context-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span> <span class="o">=</span> <span class="n">concurrent_tasks</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="Context-227"><a href="#Context-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="Context-228"><a href="#Context-228"><span class="linenos">228</span></a>
</span><span id="Context-229"><a href="#Context-229"><span class="linenos">229</span></a>        <span class="n">test_connection_config</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Context-230"><a href="#Context-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_connection</span>
</span><span id="Context-231"><a href="#Context-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">test_connection</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="Context-232"><a href="#Context-232"><span class="linenos">232</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">test_connection</span><span class="p">)</span>
</span><span id="Context-233"><a href="#Context-233"><span class="linenos">233</span></a>        <span class="p">)</span>
</span><span id="Context-234"><a href="#Context-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span> <span class="o">=</span> <span class="n">test_connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="Context-235"><a href="#Context-235"><span class="linenos">235</span></a>
</span><span id="Context-236"><a href="#Context-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_defaults</span><span class="o">.</span><span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span><span class="o">.</span><span class="n">dialect</span>
</span><span id="Context-237"><a href="#Context-237"><span class="linenos">237</span></a>
</span><span id="Context-238"><a href="#Context-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">SnapshotEvaluator</span><span class="p">(</span>
</span><span id="Context-239"><a href="#Context-239"><span class="linenos">239</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="p">,</span> <span class="n">ddl_concurrent_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="Context-240"><a href="#Context-240"><span class="linenos">240</span></a>        <span class="p">)</span>
</span><span id="Context-241"><a href="#Context-241"><span class="linenos">241</span></a>
</span><span id="Context-242"><a href="#Context-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">+</span> <span class="p">(</span><span class="n">notification_targets</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Context-243"><a href="#Context-243"><span class="linenos">243</span></a>
</span><span id="Context-244"><a href="#Context-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_provided_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="Context-245"><a href="#Context-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Context-246"><a href="#Context-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Context-247"><a href="#Context-247"><span class="linenos">247</span></a>
</span><span id="Context-248"><a href="#Context-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">users</span> <span class="o">+</span> <span class="p">(</span><span class="n">users</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Context-249"><a href="#Context-249"><span class="linenos">249</span></a>
</span><span id="Context-250"><a href="#Context-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="p">(</span><span class="n">loader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">loader</span> <span class="ow">or</span> <span class="n">SqlMeshLoader</span><span class="p">)()</span>
</span><span id="Context-251"><a href="#Context-251"><span class="linenos">251</span></a>
</span><span id="Context-252"><a href="#Context-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span id="Context-253"><a href="#Context-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="Context-254"><a href="#Context-254"><span class="linenos">254</span></a>
</span><span id="Context-255"><a href="#Context-255"><span class="linenos">255</span></a>    <span class="nd">@property</span>
</span><span id="Context-256"><a href="#Context-256"><span class="linenos">256</span></a>    <span class="k">def</span> <span class="nf">engine_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EngineAdapter</span><span class="p">:</span>
</span><span id="Context-257"><a href="#Context-257"><span class="linenos">257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an engine adapter.&quot;&quot;&quot;</span>
</span><span id="Context-258"><a href="#Context-258"><span class="linenos">258</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span>
</span><span id="Context-259"><a href="#Context-259"><span class="linenos">259</span></a>
</span><span id="Context-260"><a href="#Context-260"><span class="linenos">260</span></a>    <span class="k">def</span> <span class="nf">upsert_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
</span><span id="Context-261"><a href="#Context-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update or insert a model.</span>
</span><span id="Context-262"><a href="#Context-262"><span class="linenos">262</span></a>
</span><span id="Context-263"><a href="#Context-263"><span class="linenos">263</span></a><span class="sd">        The context&#39;s models dictionary will be updated to include these changes.</span>
</span><span id="Context-264"><a href="#Context-264"><span class="linenos">264</span></a>
</span><span id="Context-265"><a href="#Context-265"><span class="linenos">265</span></a><span class="sd">        Args:</span>
</span><span id="Context-266"><a href="#Context-266"><span class="linenos">266</span></a><span class="sd">            model: Model name or instance to update.</span>
</span><span id="Context-267"><a href="#Context-267"><span class="linenos">267</span></a><span class="sd">            kwargs: The kwargs to update the model with.</span>
</span><span id="Context-268"><a href="#Context-268"><span class="linenos">268</span></a>
</span><span id="Context-269"><a href="#Context-269"><span class="linenos">269</span></a><span class="sd">        Returns:</span>
</span><span id="Context-270"><a href="#Context-270"><span class="linenos">270</span></a><span class="sd">            A new instance of the updated or inserted model.</span>
</span><span id="Context-271"><a href="#Context-271"><span class="linenos">271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-272"><a href="#Context-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context-273"><a href="#Context-273"><span class="linenos">273</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
</span><span id="Context-274"><a href="#Context-274"><span class="linenos">274</span></a>
</span><span id="Context-275"><a href="#Context-275"><span class="linenos">275</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_path</span>  <span class="c1"># type: ignore</span>
</span><span id="Context-276"><a href="#Context-276"><span class="linenos">276</span></a>        <span class="c1"># model.copy() can&#39;t be used here due to a cached state that can be a part of a model instance.</span>
</span><span id="Context-277"><a href="#Context-277"><span class="linenos">277</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}))</span>
</span><span id="Context-278"><a href="#Context-278"><span class="linenos">278</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Context-279"><a href="#Context-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">model</span><span class="p">})</span>
</span><span id="Context-280"><a href="#Context-280"><span class="linenos">280</span></a>
</span><span id="Context-281"><a href="#Context-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_model_to_dag</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Context-282"><a href="#Context-282"><span class="linenos">282</span></a>        <span class="n">update_model_schemas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>
</span><span id="Context-283"><a href="#Context-283"><span class="linenos">283</span></a>
</span><span id="Context-284"><a href="#Context-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">model</span>
</span><span id="Context-285"><a href="#Context-285"><span class="linenos">285</span></a>
</span><span id="Context-286"><a href="#Context-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scheduler</span><span class="p">:</span>
</span><span id="Context-287"><a href="#Context-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the built-in scheduler.</span>
</span><span id="Context-288"><a href="#Context-288"><span class="linenos">288</span></a>
</span><span id="Context-289"><a href="#Context-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="Context-290"><a href="#Context-290"><span class="linenos">290</span></a><span class="sd">            environment: The target environment to source model snapshots from, or None</span>
</span><span id="Context-291"><a href="#Context-291"><span class="linenos">291</span></a><span class="sd">                if snapshots should be sourced from the currently loaded local state.</span>
</span><span id="Context-292"><a href="#Context-292"><span class="linenos">292</span></a>
</span><span id="Context-293"><a href="#Context-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="Context-294"><a href="#Context-294"><span class="linenos">294</span></a><span class="sd">            The built-in scheduler instance.</span>
</span><span id="Context-295"><a href="#Context-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-296"><a href="#Context-296"><span class="linenos">296</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]</span>
</span><span id="Context-297"><a href="#Context-297"><span class="linenos">297</span></a>        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-298"><a href="#Context-298"><span class="linenos">298</span></a>            <span class="n">stored_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context-299"><a href="#Context-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="n">stored_environment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-300"><a href="#Context-300"><span class="linenos">300</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment &#39;</span><span class="si">{</span><span class="n">environment</span><span class="si">}</span><span class="s2">&#39; was not found.&quot;</span><span class="p">)</span>
</span><span id="Context-301"><a href="#Context-301"><span class="linenos">301</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">stored_environment</span><span class="o">.</span><span class="n">snapshots</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context-302"><a href="#Context-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context-303"><a href="#Context-303"><span class="linenos">303</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context-304"><a href="#Context-304"><span class="linenos">304</span></a>
</span><span id="Context-305"><a href="#Context-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="Context-306"><a href="#Context-306"><span class="linenos">306</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;No models were found&quot;</span><span class="p">)</span>
</span><span id="Context-307"><a href="#Context-307"><span class="linenos">307</span></a>
</span><span id="Context-308"><a href="#Context-308"><span class="linenos">308</span></a>        <span class="k">return</span> <span class="n">Scheduler</span><span class="p">(</span>
</span><span id="Context-309"><a href="#Context-309"><span class="linenos">309</span></a>            <span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context-310"><a href="#Context-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="p">,</span>
</span><span id="Context-311"><a href="#Context-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="p">,</span>
</span><span id="Context-312"><a href="#Context-312"><span class="linenos">312</span></a>            <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="p">,</span>
</span><span id="Context-313"><a href="#Context-313"><span class="linenos">313</span></a>            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
</span><span id="Context-314"><a href="#Context-314"><span class="linenos">314</span></a>        <span class="p">)</span>
</span><span id="Context-315"><a href="#Context-315"><span class="linenos">315</span></a>
</span><span id="Context-316"><a href="#Context-316"><span class="linenos">316</span></a>    <span class="nd">@property</span>
</span><span id="Context-317"><a href="#Context-317"><span class="linenos">317</span></a>    <span class="k">def</span> <span class="nf">state_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSync</span><span class="p">:</span>
</span><span id="Context-318"><a href="#Context-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span>
</span><span id="Context-319"><a href="#Context-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provided_state_sync</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_state_sync</span><span class="p">(</span>
</span><span id="Context-320"><a href="#Context-320"><span class="linenos">320</span></a>                <span class="bp">self</span>
</span><span id="Context-321"><a href="#Context-321"><span class="linenos">321</span></a>            <span class="p">)</span>
</span><span id="Context-322"><a href="#Context-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span>
</span><span id="Context-323"><a href="#Context-323"><span class="linenos">323</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="Context-324"><a href="#Context-324"><span class="linenos">324</span></a>                    <span class="s2">&quot;The operation is not supported when using a read-only state sync&quot;</span>
</span><span id="Context-325"><a href="#Context-325"><span class="linenos">325</span></a>                <span class="p">)</span>
</span><span id="Context-326"><a href="#Context-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="o">.</span><span class="n">init_schema</span><span class="p">()</span>
</span><span id="Context-327"><a href="#Context-327"><span class="linenos">327</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span>
</span><span id="Context-328"><a href="#Context-328"><span class="linenos">328</span></a>
</span><span id="Context-329"><a href="#Context-329"><span class="linenos">329</span></a>    <span class="nd">@property</span>
</span><span id="Context-330"><a href="#Context-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">state_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateReader</span><span class="p">:</span>
</span><span id="Context-331"><a href="#Context-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span>
</span><span id="Context-332"><a href="#Context-332"><span class="linenos">332</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Context-333"><a href="#Context-333"><span class="linenos">333</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span>
</span><span id="Context-334"><a href="#Context-334"><span class="linenos">334</span></a>            <span class="k">except</span> <span class="n">ConfigError</span><span class="p">:</span>
</span><span id="Context-335"><a href="#Context-335"><span class="linenos">335</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_state_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Context-336"><a href="#Context-336"><span class="linenos">336</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span>
</span><span id="Context-337"><a href="#Context-337"><span class="linenos">337</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="Context-338"><a href="#Context-338"><span class="linenos">338</span></a>                    <span class="s2">&quot;Invalid configuration: neither State Sync nor Reader has been configured&quot;</span>
</span><span id="Context-339"><a href="#Context-339"><span class="linenos">339</span></a>                <span class="p">)</span>
</span><span id="Context-340"><a href="#Context-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span>
</span><span id="Context-341"><a href="#Context-341"><span class="linenos">341</span></a>
</span><span id="Context-342"><a href="#Context-342"><span class="linenos">342</span></a>    <span class="nd">@property</span>
</span><span id="Context-343"><a href="#Context-343"><span class="linenos">343</span></a>    <span class="k">def</span> <span class="nf">sqlmesh_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-344"><a href="#Context-344"><span class="linenos">344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the SQLMesh home directory.&quot;&quot;&quot;</span>
</span><span id="Context-345"><a href="#Context-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.sqlmesh&quot;</span>
</span><span id="Context-346"><a href="#Context-346"><span class="linenos">346</span></a>
</span><span id="Context-347"><a href="#Context-347"><span class="linenos">347</span></a>    <span class="nd">@property</span>
</span><span id="Context-348"><a href="#Context-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">models_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-349"><a href="#Context-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where the models are defined&quot;&quot;&quot;</span>
</span><span id="Context-350"><a href="#Context-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;models&quot;</span>
</span><span id="Context-351"><a href="#Context-351"><span class="linenos">351</span></a>
</span><span id="Context-352"><a href="#Context-352"><span class="linenos">352</span></a>    <span class="nd">@property</span>
</span><span id="Context-353"><a href="#Context-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">macro_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-354"><a href="#Context-354"><span class="linenos">354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where macros are defined&quot;&quot;&quot;</span>
</span><span id="Context-355"><a href="#Context-355"><span class="linenos">355</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;macros&quot;</span>
</span><span id="Context-356"><a href="#Context-356"><span class="linenos">356</span></a>
</span><span id="Context-357"><a href="#Context-357"><span class="linenos">357</span></a>    <span class="nd">@property</span>
</span><span id="Context-358"><a href="#Context-358"><span class="linenos">358</span></a>    <span class="k">def</span> <span class="nf">hook_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-359"><a href="#Context-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to the directory where hooks are defined&quot;&quot;&quot;</span>
</span><span id="Context-360"><a href="#Context-360"><span class="linenos">360</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;hooks&quot;</span>
</span><span id="Context-361"><a href="#Context-361"><span class="linenos">361</span></a>
</span><span id="Context-362"><a href="#Context-362"><span class="linenos">362</span></a>    <span class="nd">@property</span>
</span><span id="Context-363"><a href="#Context-363"><span class="linenos">363</span></a>    <span class="k">def</span> <span class="nf">test_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-364"><a href="#Context-364"><span class="linenos">364</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span>
</span><span id="Context-365"><a href="#Context-365"><span class="linenos">365</span></a>
</span><span id="Context-366"><a href="#Context-366"><span class="linenos">366</span></a>    <span class="nd">@property</span>
</span><span id="Context-367"><a href="#Context-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">audits_directory_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
</span><span id="Context-368"><a href="#Context-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;audits&quot;</span>
</span><span id="Context-369"><a href="#Context-369"><span class="linenos">369</span></a>
</span><span id="Context-370"><a href="#Context-370"><span class="linenos">370</span></a>    <span class="nd">@property</span>
</span><span id="Context-371"><a href="#Context-371"><span class="linenos">371</span></a>    <span class="k">def</span> <span class="nf">ignore_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Context-372"><a href="#Context-372"><span class="linenos">372</span></a>        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">IGNORE_PATTERNS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ignore_patterns</span>
</span><span id="Context-373"><a href="#Context-373"><span class="linenos">373</span></a>
</span><span id="Context-374"><a href="#Context-374"><span class="linenos">374</span></a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-375"><a href="#Context-375"><span class="linenos">375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh all models that have been updated.&quot;&quot;&quot;</span>
</span><span id="Context-376"><a href="#Context-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">reload_needed</span><span class="p">():</span>
</span><span id="Context-377"><a href="#Context-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="Context-378"><a href="#Context-378"><span class="linenos">378</span></a>
</span><span id="Context-379"><a href="#Context-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
</span><span id="Context-380"><a href="#Context-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all files in the context&#39;s path.&quot;&quot;&quot;</span>
</span><span id="Context-381"><a href="#Context-381"><span class="linenos">381</span></a>        <span class="k">with</span> <span class="n">sys_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
</span><span id="Context-382"><a href="#Context-382"><span class="linenos">382</span></a>            <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Context-383"><a href="#Context-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">hooks</span>
</span><span id="Context-384"><a href="#Context-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">macros</span>
</span><span id="Context-385"><a href="#Context-385"><span class="linenos">385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">models</span>
</span><span id="Context-386"><a href="#Context-386"><span class="linenos">386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">audits</span>
</span><span id="Context-387"><a href="#Context-387"><span class="linenos">387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dag</span>
</span><span id="Context-388"><a href="#Context-388"><span class="linenos">388</span></a>
</span><span id="Context-389"><a href="#Context-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Context-390"><a href="#Context-390"><span class="linenos">390</span></a>
</span><span id="Context-391"><a href="#Context-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="Context-392"><a href="#Context-392"><span class="linenos">392</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-393"><a href="#Context-393"><span class="linenos">393</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-394"><a href="#Context-394"><span class="linenos">394</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context-395"><a href="#Context-395"><span class="linenos">395</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-396"><a href="#Context-396"><span class="linenos">396</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-397"><a href="#Context-397"><span class="linenos">397</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-398"><a href="#Context-398"><span class="linenos">398</span></a>        <span class="n">skip_janitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-399"><a href="#Context-399"><span class="linenos">399</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-400"><a href="#Context-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the entire dag through the scheduler.</span>
</span><span id="Context-401"><a href="#Context-401"><span class="linenos">401</span></a>
</span><span id="Context-402"><a href="#Context-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="Context-403"><a href="#Context-403"><span class="linenos">403</span></a><span class="sd">            environment: The target environment to source model snapshots from. Default: prod.</span>
</span><span id="Context-404"><a href="#Context-404"><span class="linenos">404</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="Context-405"><a href="#Context-405"><span class="linenos">405</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="Context-406"><a href="#Context-406"><span class="linenos">406</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context-407"><a href="#Context-407"><span class="linenos">407</span></a><span class="sd">            skip_janitor: Whether to skip the jantitor task.</span>
</span><span id="Context-408"><a href="#Context-408"><span class="linenos">408</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-409"><a href="#Context-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">)</span>
</span><span id="Context-410"><a href="#Context-410"><span class="linenos">410</span></a>
</span><span id="Context-411"><a href="#Context-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_janitor</span><span class="p">:</span>
</span><span id="Context-412"><a href="#Context-412"><span class="linenos">412</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_run_janitor</span><span class="p">()</span>
</span><span id="Context-413"><a href="#Context-413"><span class="linenos">413</span></a>
</span><span id="Context-414"><a href="#Context-414"><span class="linenos">414</span></a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]:</span>
</span><span id="Context-415"><a href="#Context-415"><span class="linenos">415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a model with the given name or None if a model with such name doesn&#39;t exist.&quot;&quot;&quot;</span>
</span><span id="Context-416"><a href="#Context-416"><span class="linenos">416</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="Context-417"><a href="#Context-417"><span class="linenos">417</span></a>
</span><span id="Context-418"><a href="#Context-418"><span class="linenos">418</span></a>    <span class="nd">@property</span>
</span><span id="Context-419"><a href="#Context-419"><span class="linenos">419</span></a>    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]:</span>
</span><span id="Context-420"><a href="#Context-420"><span class="linenos">420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered models in this context.&quot;&quot;&quot;</span>
</span><span id="Context-421"><a href="#Context-421"><span class="linenos">421</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>
</span><span id="Context-422"><a href="#Context-422"><span class="linenos">422</span></a>
</span><span id="Context-423"><a href="#Context-423"><span class="linenos">423</span></a>    <span class="nd">@property</span>
</span><span id="Context-424"><a href="#Context-424"><span class="linenos">424</span></a>    <span class="k">def</span> <span class="nf">macros</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExecutableOrMacro</span><span class="p">]:</span>
</span><span id="Context-425"><a href="#Context-425"><span class="linenos">425</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered macros in this context.&quot;&quot;&quot;</span>
</span><span id="Context-426"><a href="#Context-426"><span class="linenos">426</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_macros</span><span class="p">)</span>
</span><span id="Context-427"><a href="#Context-427"><span class="linenos">427</span></a>
</span><span id="Context-428"><a href="#Context-428"><span class="linenos">428</span></a>    <span class="nd">@property</span>
</span><span id="Context-429"><a href="#Context-429"><span class="linenos">429</span></a>    <span class="k">def</span> <span class="nf">hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappingProxyType</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hook</span><span class="p">]:</span>
</span><span id="Context-430"><a href="#Context-430"><span class="linenos">430</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all registered hooks in this context.&quot;&quot;&quot;</span>
</span><span id="Context-431"><a href="#Context-431"><span class="linenos">431</span></a>        <span class="k">return</span> <span class="n">MappingProxyType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">)</span>
</span><span id="Context-432"><a href="#Context-432"><span class="linenos">432</span></a>
</span><span id="Context-433"><a href="#Context-433"><span class="linenos">433</span></a>    <span class="nd">@property</span>
</span><span id="Context-434"><a href="#Context-434"><span class="linenos">434</span></a>    <span class="k">def</span> <span class="nf">snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]:</span>
</span><span id="Context-435"><a href="#Context-435"><span class="linenos">435</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns snapshots based on models registered in this context.</span>
</span><span id="Context-436"><a href="#Context-436"><span class="linenos">436</span></a>
</span><span id="Context-437"><a href="#Context-437"><span class="linenos">437</span></a><span class="sd">        If one of the snapshots has been previosly stored in the persisted state, the stored</span>
</span><span id="Context-438"><a href="#Context-438"><span class="linenos">438</span></a><span class="sd">        instance will be returned.</span>
</span><span id="Context-439"><a href="#Context-439"><span class="linenos">439</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-440"><a href="#Context-440"><span class="linenos">440</span></a>        <span class="n">local_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span>
</span><span id="Context-441"><a href="#Context-441"><span class="linenos">441</span></a>
</span><span id="Context-442"><a href="#Context-442"><span class="linenos">442</span></a>        <span class="n">stored_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span>
</span><span id="Context-443"><a href="#Context-443"><span class="linenos">443</span></a>            <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">local_snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="Context-444"><a href="#Context-444"><span class="linenos">444</span></a>        <span class="p">)</span>
</span><span id="Context-445"><a href="#Context-445"><span class="linenos">445</span></a>
</span><span id="Context-446"><a href="#Context-446"><span class="linenos">446</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">stored_snapshots</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">local_snapshots</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Context-447"><a href="#Context-447"><span class="linenos">447</span></a>
</span><span id="Context-448"><a href="#Context-448"><span class="linenos">448</span></a>    <span class="nd">@property</span>
</span><span id="Context-449"><a href="#Context-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="nf">local_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]:</span>
</span><span id="Context-450"><a href="#Context-450"><span class="linenos">450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and returns snapshots based on models registered in this context without reconciling them</span>
</span><span id="Context-451"><a href="#Context-451"><span class="linenos">451</span></a><span class="sd">        with the persisted state.</span>
</span><span id="Context-452"><a href="#Context-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-453"><a href="#Context-453"><span class="linenos">453</span></a>        <span class="n">local_snapshots</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Context-454"><a href="#Context-454"><span class="linenos">454</span></a>        <span class="n">fingerprint_cache</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SnapshotFingerprint</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Context-455"><a href="#Context-455"><span class="linenos">455</span></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Context-456"><a href="#Context-456"><span class="linenos">456</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">Snapshot</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span>
</span><span id="Context-457"><a href="#Context-457"><span class="linenos">457</span></a>                <span class="n">model</span><span class="p">,</span>
</span><span id="Context-458"><a href="#Context-458"><span class="linenos">458</span></a>                <span class="n">physical_schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_schema</span><span class="p">,</span>
</span><span id="Context-459"><a href="#Context-459"><span class="linenos">459</span></a>                <span class="n">models</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">,</span>
</span><span id="Context-460"><a href="#Context-460"><span class="linenos">460</span></a>                <span class="n">ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshot_ttl</span><span class="p">,</span>
</span><span id="Context-461"><a href="#Context-461"><span class="linenos">461</span></a>                <span class="n">audits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_audits</span><span class="p">,</span>
</span><span id="Context-462"><a href="#Context-462"><span class="linenos">462</span></a>                <span class="n">cache</span><span class="o">=</span><span class="n">fingerprint_cache</span><span class="p">,</span>
</span><span id="Context-463"><a href="#Context-463"><span class="linenos">463</span></a>            <span class="p">)</span>
</span><span id="Context-464"><a href="#Context-464"><span class="linenos">464</span></a>            <span class="n">local_snapshots</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
</span><span id="Context-465"><a href="#Context-465"><span class="linenos">465</span></a>        <span class="k">return</span> <span class="n">local_snapshots</span>
</span><span id="Context-466"><a href="#Context-466"><span class="linenos">466</span></a>
</span><span id="Context-467"><a href="#Context-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
</span><span id="Context-468"><a href="#Context-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-469"><a href="#Context-469"><span class="linenos">469</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="Context-470"><a href="#Context-470"><span class="linenos">470</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context-471"><a href="#Context-471"><span class="linenos">471</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-472"><a href="#Context-472"><span class="linenos">472</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-473"><a href="#Context-473"><span class="linenos">473</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-474"><a href="#Context-474"><span class="linenos">474</span></a>        <span class="n">expand</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-475"><a href="#Context-475"><span class="linenos">475</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Context-476"><a href="#Context-476"><span class="linenos">476</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
</span><span id="Context-477"><a href="#Context-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Renders a model&#39;s query, expanding macros with provided kwargs, and optionally expanding referenced models.</span>
</span><span id="Context-478"><a href="#Context-478"><span class="linenos">478</span></a>
</span><span id="Context-479"><a href="#Context-479"><span class="linenos">479</span></a><span class="sd">        Args:</span>
</span><span id="Context-480"><a href="#Context-480"><span class="linenos">480</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="Context-481"><a href="#Context-481"><span class="linenos">481</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="Context-482"><a href="#Context-482"><span class="linenos">482</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="Context-483"><a href="#Context-483"><span class="linenos">483</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context-484"><a href="#Context-484"><span class="linenos">484</span></a><span class="sd">            expand: Whether or not to use expand materialized models, defaults to False.</span>
</span><span id="Context-485"><a href="#Context-485"><span class="linenos">485</span></a><span class="sd">                If True, all referenced models are expanded as raw queries.</span>
</span><span id="Context-486"><a href="#Context-486"><span class="linenos">486</span></a><span class="sd">                If a list, only referenced models are expanded as raw queries.</span>
</span><span id="Context-487"><a href="#Context-487"><span class="linenos">487</span></a>
</span><span id="Context-488"><a href="#Context-488"><span class="linenos">488</span></a><span class="sd">        Returns:</span>
</span><span id="Context-489"><a href="#Context-489"><span class="linenos">489</span></a><span class="sd">            The rendered expression.</span>
</span><span id="Context-490"><a href="#Context-490"><span class="linenos">490</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-491"><a href="#Context-491"><span class="linenos">491</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">yesterday_ds</span><span class="p">()</span>
</span><span id="Context-492"><a href="#Context-492"><span class="linenos">492</span></a>
</span><span id="Context-493"><a href="#Context-493"><span class="linenos">493</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context-494"><a href="#Context-494"><span class="linenos">494</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="Context-495"><a href="#Context-495"><span class="linenos">495</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="Context-496"><a href="#Context-496"><span class="linenos">496</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">model</span>
</span><span id="Context-497"><a href="#Context-497"><span class="linenos">497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context-498"><a href="#Context-498"><span class="linenos">498</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="Context-499"><a href="#Context-499"><span class="linenos">499</span></a>
</span><span id="Context-500"><a href="#Context-500"><span class="linenos">500</span></a>        <span class="n">expand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">upstream</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">expand</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">expand</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="Context-501"><a href="#Context-501"><span class="linenos">501</span></a>
</span><span id="Context-502"><a href="#Context-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">is_seed</span><span class="p">:</span>
</span><span id="Context-503"><a href="#Context-503"><span class="linenos">503</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="Context-504"><a href="#Context-504"><span class="linenos">504</span></a>            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">pandas_to_sql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">columns_to_types</span><span class="p">))</span>
</span><span id="Context-505"><a href="#Context-505"><span class="linenos">505</span></a>
</span><span id="Context-506"><a href="#Context-506"><span class="linenos">506</span></a>        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">render_query</span><span class="p">(</span>
</span><span id="Context-507"><a href="#Context-507"><span class="linenos">507</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context-508"><a href="#Context-508"><span class="linenos">508</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context-509"><a href="#Context-509"><span class="linenos">509</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="Context-510"><a href="#Context-510"><span class="linenos">510</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context-511"><a href="#Context-511"><span class="linenos">511</span></a>            <span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">,</span>
</span><span id="Context-512"><a href="#Context-512"><span class="linenos">512</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Context-513"><a href="#Context-513"><span class="linenos">513</span></a>        <span class="p">)</span>
</span><span id="Context-514"><a href="#Context-514"><span class="linenos">514</span></a>
</span><span id="Context-515"><a href="#Context-515"><span class="linenos">515</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Context-516"><a href="#Context-516"><span class="linenos">516</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-517"><a href="#Context-517"><span class="linenos">517</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="Context-518"><a href="#Context-518"><span class="linenos">518</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context-519"><a href="#Context-519"><span class="linenos">519</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context-520"><a href="#Context-520"><span class="linenos">520</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context-521"><a href="#Context-521"><span class="linenos">521</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-522"><a href="#Context-522"><span class="linenos">522</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Context-523"><a href="#Context-523"><span class="linenos">523</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DF</span><span class="p">:</span>
</span><span id="Context-524"><a href="#Context-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a model or snapshot (running its query against a DB/Engine).</span>
</span><span id="Context-525"><a href="#Context-525"><span class="linenos">525</span></a>
</span><span id="Context-526"><a href="#Context-526"><span class="linenos">526</span></a><span class="sd">        This method is used to test or iterate on models without side effects.</span>
</span><span id="Context-527"><a href="#Context-527"><span class="linenos">527</span></a>
</span><span id="Context-528"><a href="#Context-528"><span class="linenos">528</span></a><span class="sd">        Args:</span>
</span><span id="Context-529"><a href="#Context-529"><span class="linenos">529</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="Context-530"><a href="#Context-530"><span class="linenos">530</span></a><span class="sd">            start: The start of the interval to evaluate.</span>
</span><span id="Context-531"><a href="#Context-531"><span class="linenos">531</span></a><span class="sd">            end: The end of the interval to evaluate.</span>
</span><span id="Context-532"><a href="#Context-532"><span class="linenos">532</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context-533"><a href="#Context-533"><span class="linenos">533</span></a><span class="sd">            limit: A limit applied to the model.</span>
</span><span id="Context-534"><a href="#Context-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-535"><a href="#Context-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context-536"><a href="#Context-536"><span class="linenos">536</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="Context-537"><a href="#Context-537"><span class="linenos">537</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="Context-538"><a href="#Context-538"><span class="linenos">538</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="Context-539"><a href="#Context-539"><span class="linenos">539</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context-540"><a href="#Context-540"><span class="linenos">540</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="Context-541"><a href="#Context-541"><span class="linenos">541</span></a>
</span><span id="Context-542"><a href="#Context-542"><span class="linenos">542</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Context-543"><a href="#Context-543"><span class="linenos">543</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Context-544"><a href="#Context-544"><span class="linenos">544</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Context-545"><a href="#Context-545"><span class="linenos">545</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Context-546"><a href="#Context-546"><span class="linenos">546</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Context-547"><a href="#Context-547"><span class="linenos">547</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context-548"><a href="#Context-548"><span class="linenos">548</span></a>            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_MAX_LIMIT</span><span class="p">,</span>
</span><span id="Context-549"><a href="#Context-549"><span class="linenos">549</span></a>        <span class="p">)</span>
</span><span id="Context-550"><a href="#Context-550"><span class="linenos">550</span></a>
</span><span id="Context-551"><a href="#Context-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-552"><a href="#Context-552"><span class="linenos">552</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error evaluating </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Context-553"><a href="#Context-553"><span class="linenos">553</span></a>
</span><span id="Context-554"><a href="#Context-554"><span class="linenos">554</span></a>        <span class="k">return</span> <span class="n">df</span>
</span><span id="Context-555"><a href="#Context-555"><span class="linenos">555</span></a>
</span><span id="Context-556"><a href="#Context-556"><span class="linenos">556</span></a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-557"><a href="#Context-557"><span class="linenos">557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format all models in a given directory.&quot;&quot;&quot;</span>
</span><span id="Context-558"><a href="#Context-558"><span class="linenos">558</span></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Context-559"><a href="#Context-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_sql</span><span class="p">:</span>
</span><span id="Context-560"><a href="#Context-560"><span class="linenos">560</span></a>                <span class="k">continue</span>
</span><span id="Context-561"><a href="#Context-561"><span class="linenos">561</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Context-562"><a href="#Context-562"><span class="linenos">562</span></a>                <span class="n">expressions</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">default_dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
</span><span id="Context-563"><a href="#Context-563"><span class="linenos">563</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Context-564"><a href="#Context-564"><span class="linenos">564</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_model_expressions</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
</span><span id="Context-565"><a href="#Context-565"><span class="linenos">565</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</span><span id="Context-566"><a href="#Context-566"><span class="linenos">566</span></a>
</span><span id="Context-567"><a href="#Context-567"><span class="linenos">567</span></a>    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span>
</span><span id="Context-568"><a href="#Context-568"><span class="linenos">568</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-569"><a href="#Context-569"><span class="linenos">569</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-570"><a href="#Context-570"><span class="linenos">570</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context-571"><a href="#Context-571"><span class="linenos">571</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-572"><a href="#Context-572"><span class="linenos">572</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-573"><a href="#Context-573"><span class="linenos">573</span></a>        <span class="n">create_from</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-574"><a href="#Context-574"><span class="linenos">574</span></a>        <span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-575"><a href="#Context-575"><span class="linenos">575</span></a>        <span class="n">restate_models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-576"><a href="#Context-576"><span class="linenos">576</span></a>        <span class="n">no_gaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-577"><a href="#Context-577"><span class="linenos">577</span></a>        <span class="n">skip_backfill</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-578"><a href="#Context-578"><span class="linenos">578</span></a>        <span class="n">forward_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-579"><a href="#Context-579"><span class="linenos">579</span></a>        <span class="n">no_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-580"><a href="#Context-580"><span class="linenos">580</span></a>        <span class="n">auto_apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-581"><a href="#Context-581"><span class="linenos">581</span></a>        <span class="n">no_auto_categorization</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-582"><a href="#Context-582"><span class="linenos">582</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Plan</span><span class="p">:</span>
</span><span id="Context-583"><a href="#Context-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interactively create a migration plan.</span>
</span><span id="Context-584"><a href="#Context-584"><span class="linenos">584</span></a>
</span><span id="Context-585"><a href="#Context-585"><span class="linenos">585</span></a><span class="sd">        This method compares the current context with an environment. It then presents</span>
</span><span id="Context-586"><a href="#Context-586"><span class="linenos">586</span></a><span class="sd">        the differences and asks whether to backfill each modified model.</span>
</span><span id="Context-587"><a href="#Context-587"><span class="linenos">587</span></a>
</span><span id="Context-588"><a href="#Context-588"><span class="linenos">588</span></a><span class="sd">        Args:</span>
</span><span id="Context-589"><a href="#Context-589"><span class="linenos">589</span></a><span class="sd">            environment: The environment to diff and plan against.</span>
</span><span id="Context-590"><a href="#Context-590"><span class="linenos">590</span></a><span class="sd">            start: The start date of the backfill if there is one.</span>
</span><span id="Context-591"><a href="#Context-591"><span class="linenos">591</span></a><span class="sd">            end: The end date of the backfill if there is one.</span>
</span><span id="Context-592"><a href="#Context-592"><span class="linenos">592</span></a><span class="sd">            create_from: The environment to create the target environment from if it</span>
</span><span id="Context-593"><a href="#Context-593"><span class="linenos">593</span></a><span class="sd">                doesn&#39;t exist. If not specified, the &quot;prod&quot; environment will be used.</span>
</span><span id="Context-594"><a href="#Context-594"><span class="linenos">594</span></a><span class="sd">            skip_tests: Unit tests are run by default so this will skip them if enabled</span>
</span><span id="Context-595"><a href="#Context-595"><span class="linenos">595</span></a><span class="sd">            restate_models: A list of of either internal or external models that need to be restated</span>
</span><span id="Context-596"><a href="#Context-596"><span class="linenos">596</span></a><span class="sd">                for the given plan interval. If the target environment is a production environment,</span>
</span><span id="Context-597"><a href="#Context-597"><span class="linenos">597</span></a><span class="sd">                ALL snapshots that depended on these upstream tables will have their intervals deleted</span>
</span><span id="Context-598"><a href="#Context-598"><span class="linenos">598</span></a><span class="sd">                (even ones not in this current environment). Only the snapshots in this environment will</span>
</span><span id="Context-599"><a href="#Context-599"><span class="linenos">599</span></a><span class="sd">                be backfilled whereas others need to be recovered on a future plan application. For development</span>
</span><span id="Context-600"><a href="#Context-600"><span class="linenos">600</span></a><span class="sd">                environments only snapshots that are part of this plan will be affected.</span>
</span><span id="Context-601"><a href="#Context-601"><span class="linenos">601</span></a><span class="sd">            no_gaps:  Whether to ensure that new snapshots for models that are already a</span>
</span><span id="Context-602"><a href="#Context-602"><span class="linenos">602</span></a><span class="sd">                part of the target environment have no data gaps when compared against previous</span>
</span><span id="Context-603"><a href="#Context-603"><span class="linenos">603</span></a><span class="sd">                snapshots for same models.</span>
</span><span id="Context-604"><a href="#Context-604"><span class="linenos">604</span></a><span class="sd">            skip_backfill: Whether to skip the backfill step. Default: False.</span>
</span><span id="Context-605"><a href="#Context-605"><span class="linenos">605</span></a><span class="sd">            forward_only: Whether the purpose of the plan is to make forward only changes.</span>
</span><span id="Context-606"><a href="#Context-606"><span class="linenos">606</span></a><span class="sd">            no_prompts: Whether to disable interactive prompts for the backfill time range. Please note that</span>
</span><span id="Context-607"><a href="#Context-607"><span class="linenos">607</span></a><span class="sd">                if this flag is set to true and there are uncategorized changes the plan creation will</span>
</span><span id="Context-608"><a href="#Context-608"><span class="linenos">608</span></a><span class="sd">                fail. Default: False.</span>
</span><span id="Context-609"><a href="#Context-609"><span class="linenos">609</span></a><span class="sd">            auto_apply: Whether to automatically apply the new plan after creation. Default: False.</span>
</span><span id="Context-610"><a href="#Context-610"><span class="linenos">610</span></a><span class="sd">            no_auto_categorization: Indicates whether to disable automatic categorization of model</span>
</span><span id="Context-611"><a href="#Context-611"><span class="linenos">611</span></a><span class="sd">                changes (breaking / non-breaking). If not provided, then the corresponding configuration</span>
</span><span id="Context-612"><a href="#Context-612"><span class="linenos">612</span></a><span class="sd">                option determines the behavior.</span>
</span><span id="Context-613"><a href="#Context-613"><span class="linenos">613</span></a>
</span><span id="Context-614"><a href="#Context-614"><span class="linenos">614</span></a><span class="sd">        Returns:</span>
</span><span id="Context-615"><a href="#Context-615"><span class="linenos">615</span></a><span class="sd">            The populated Plan object.</span>
</span><span id="Context-616"><a href="#Context-616"><span class="linenos">616</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-617"><a href="#Context-617"><span class="linenos">617</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="Context-618"><a href="#Context-618"><span class="linenos">618</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context-619"><a href="#Context-619"><span class="linenos">619</span></a>
</span><span id="Context-620"><a href="#Context-620"><span class="linenos">620</span></a>        <span class="k">if</span> <span class="n">skip_backfill</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_gaps</span> <span class="ow">and</span> <span class="n">environment</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">:</span>
</span><span id="Context-621"><a href="#Context-621"><span class="linenos">621</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="Context-622"><a href="#Context-622"><span class="linenos">622</span></a>                <span class="s2">&quot;When targeting the production enviornment either the backfill should not be skipped or the lack of data gaps should be enforced (--no-gaps flag).&quot;</span>
</span><span id="Context-623"><a href="#Context-623"><span class="linenos">623</span></a>            <span class="p">)</span>
</span><span id="Context-624"><a href="#Context-624"><span class="linenos">624</span></a>
</span><span id="Context-625"><a href="#Context-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_run_plan_tests</span><span class="p">(</span><span class="n">skip_tests</span><span class="p">)</span>
</span><span id="Context-626"><a href="#Context-626"><span class="linenos">626</span></a>
</span><span id="Context-627"><a href="#Context-627"><span class="linenos">627</span></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span>
</span><span id="Context-628"><a href="#Context-628"><span class="linenos">628</span></a>            <span class="n">context_diff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span> <span class="n">create_from</span><span class="o">=</span><span class="n">create_from</span><span class="p">),</span>
</span><span id="Context-629"><a href="#Context-629"><span class="linenos">629</span></a>            <span class="n">dag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span>
</span><span id="Context-630"><a href="#Context-630"><span class="linenos">630</span></a>            <span class="n">state_reader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="p">,</span>
</span><span id="Context-631"><a href="#Context-631"><span class="linenos">631</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context-632"><a href="#Context-632"><span class="linenos">632</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context-633"><a href="#Context-633"><span class="linenos">633</span></a>            <span class="n">apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span>
</span><span id="Context-634"><a href="#Context-634"><span class="linenos">634</span></a>            <span class="n">restate_models</span><span class="o">=</span><span class="n">restate_models</span><span class="p">,</span>
</span><span id="Context-635"><a href="#Context-635"><span class="linenos">635</span></a>            <span class="n">no_gaps</span><span class="o">=</span><span class="n">no_gaps</span><span class="p">,</span>
</span><span id="Context-636"><a href="#Context-636"><span class="linenos">636</span></a>            <span class="n">skip_backfill</span><span class="o">=</span><span class="n">skip_backfill</span><span class="p">,</span>
</span><span id="Context-637"><a href="#Context-637"><span class="linenos">637</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">environment</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span>
</span><span id="Context-638"><a href="#Context-638"><span class="linenos">638</span></a>            <span class="n">forward_only</span><span class="o">=</span><span class="n">forward_only</span><span class="p">,</span>
</span><span id="Context-639"><a href="#Context-639"><span class="linenos">639</span></a>            <span class="n">environment_ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">environment_ttl</span><span class="p">,</span>
</span><span id="Context-640"><a href="#Context-640"><span class="linenos">640</span></a>            <span class="n">categorizer_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auto_categorize_changes</span><span class="p">,</span>
</span><span id="Context-641"><a href="#Context-641"><span class="linenos">641</span></a>            <span class="n">auto_categorization_enabled</span><span class="o">=</span><span class="ow">not</span> <span class="n">no_auto_categorization</span><span class="p">,</span>
</span><span id="Context-642"><a href="#Context-642"><span class="linenos">642</span></a>        <span class="p">)</span>
</span><span id="Context-643"><a href="#Context-643"><span class="linenos">643</span></a>
</span><span id="Context-644"><a href="#Context-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_prompts</span><span class="p">:</span>
</span><span id="Context-645"><a href="#Context-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">auto_apply</span><span class="p">)</span>
</span><span id="Context-646"><a href="#Context-646"><span class="linenos">646</span></a>        <span class="k">elif</span> <span class="n">auto_apply</span><span class="p">:</span>
</span><span id="Context-647"><a href="#Context-647"><span class="linenos">647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span id="Context-648"><a href="#Context-648"><span class="linenos">648</span></a>
</span><span id="Context-649"><a href="#Context-649"><span class="linenos">649</span></a>        <span class="k">return</span> <span class="n">plan</span>
</span><span id="Context-650"><a href="#Context-650"><span class="linenos">650</span></a>
</span><span id="Context-651"><a href="#Context-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-652"><a href="#Context-652"><span class="linenos">652</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies a plan by pushing snapshots and backfilling data.</span>
</span><span id="Context-653"><a href="#Context-653"><span class="linenos">653</span></a>
</span><span id="Context-654"><a href="#Context-654"><span class="linenos">654</span></a><span class="sd">        Given a plan, it pushes snapshots into the state sync and then uses the scheduler</span>
</span><span id="Context-655"><a href="#Context-655"><span class="linenos">655</span></a><span class="sd">        to backfill all models.</span>
</span><span id="Context-656"><a href="#Context-656"><span class="linenos">656</span></a>
</span><span id="Context-657"><a href="#Context-657"><span class="linenos">657</span></a><span class="sd">        Args:</span>
</span><span id="Context-658"><a href="#Context-658"><span class="linenos">658</span></a><span class="sd">            plan: The plan to apply.</span>
</span><span id="Context-659"><a href="#Context-659"><span class="linenos">659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-660"><a href="#Context-660"><span class="linenos">660</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">context_diff</span><span class="o">.</span><span class="n">has_changes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">requires_backfill</span><span class="p">:</span>
</span><span id="Context-661"><a href="#Context-661"><span class="linenos">661</span></a>            <span class="k">return</span>
</span><span id="Context-662"><a href="#Context-662"><span class="linenos">662</span></a>        <span class="k">if</span> <span class="n">plan</span><span class="o">.</span><span class="n">uncategorized</span><span class="p">:</span>
</span><span id="Context-663"><a href="#Context-663"><span class="linenos">663</span></a>            <span class="k">raise</span> <span class="n">PlanError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t apply a plan with uncategorized changes.&quot;</span><span class="p">)</span>
</span><span id="Context-664"><a href="#Context-664"><span class="linenos">664</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_plan_evaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span id="Context-665"><a href="#Context-665"><span class="linenos">665</span></a>
</span><span id="Context-666"><a href="#Context-666"><span class="linenos">666</span></a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-667"><a href="#Context-667"><span class="linenos">667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a diff of the current context with a given environment.</span>
</span><span id="Context-668"><a href="#Context-668"><span class="linenos">668</span></a>
</span><span id="Context-669"><a href="#Context-669"><span class="linenos">669</span></a><span class="sd">        Args:</span>
</span><span id="Context-670"><a href="#Context-670"><span class="linenos">670</span></a><span class="sd">            environment: The environment to diff against.</span>
</span><span id="Context-671"><a href="#Context-671"><span class="linenos">671</span></a><span class="sd">            detailed: Show the actual SQL differences if True.</span>
</span><span id="Context-672"><a href="#Context-672"><span class="linenos">672</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-673"><a href="#Context-673"><span class="linenos">673</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="Context-674"><a href="#Context-674"><span class="linenos">674</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context-675"><a href="#Context-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_model_difference_summary</span><span class="p">(</span>
</span><span id="Context-676"><a href="#Context-676"><span class="linenos">676</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">),</span> <span class="n">detailed</span>
</span><span id="Context-677"><a href="#Context-677"><span class="linenos">677</span></a>        <span class="p">)</span>
</span><span id="Context-678"><a href="#Context-678"><span class="linenos">678</span></a>
</span><span id="Context-679"><a href="#Context-679"><span class="linenos">679</span></a>    <span class="k">def</span> <span class="nf">get_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;svg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">:</span>
</span><span id="Context-680"><a href="#Context-680"><span class="linenos">680</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a graphviz dag.</span>
</span><span id="Context-681"><a href="#Context-681"><span class="linenos">681</span></a>
</span><span id="Context-682"><a href="#Context-682"><span class="linenos">682</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="Context-683"><a href="#Context-683"><span class="linenos">683</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="Context-684"><a href="#Context-684"><span class="linenos">684</span></a>
</span><span id="Context-685"><a href="#Context-685"><span class="linenos">685</span></a><span class="sd">        To display within Databricks:</span>
</span><span id="Context-686"><a href="#Context-686"><span class="linenos">686</span></a><span class="sd">        displayHTML(context.get_dag().pipe(encoding=&#39;utf-8&#39;))</span>
</span><span id="Context-687"><a href="#Context-687"><span class="linenos">687</span></a>
</span><span id="Context-688"><a href="#Context-688"><span class="linenos">688</span></a><span class="sd">        Args:</span>
</span><span id="Context-689"><a href="#Context-689"><span class="linenos">689</span></a><span class="sd">            format: The desired format to use for representing the graph</span>
</span><span id="Context-690"><a href="#Context-690"><span class="linenos">690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-691"><a href="#Context-691"><span class="linenos">691</span></a>        <span class="kn">from</span> <span class="nn">sqlmesh</span> <span class="kn">import</span> <span class="n">runtime_env</span>
</span><span id="Context-692"><a href="#Context-692"><span class="linenos">692</span></a>
</span><span id="Context-693"><a href="#Context-693"><span class="linenos">693</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context-694"><a href="#Context-694"><span class="linenos">694</span></a>            <span class="kn">import</span> <span class="nn">graphviz</span>  <span class="c1"># type: ignore</span>
</span><span id="Context-695"><a href="#Context-695"><span class="linenos">695</span></a>        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Context-696"><a href="#Context-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="n">runtime_env</span><span class="o">.</span><span class="n">is_databricks</span><span class="p">:</span>
</span><span id="Context-697"><a href="#Context-697"><span class="linenos">697</span></a>                <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context-698"><a href="#Context-698"><span class="linenos">698</span></a>                    <span class="s2">&quot;Rendering a dag requires graphviz. Run `pip install graphviz` and then `sudo apt-get install -y python3-dev graphviz libgraphviz-dev pkg-config`&quot;</span>
</span><span id="Context-699"><a href="#Context-699"><span class="linenos">699</span></a>                <span class="p">)</span>
</span><span id="Context-700"><a href="#Context-700"><span class="linenos">700</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context-701"><a href="#Context-701"><span class="linenos">701</span></a>                <span class="s2">&quot;Rendering a dag requires a manual install of graphviz. Run `pip install graphviz` and then install graphviz library: https://graphviz.org/download/.&quot;</span>
</span><span id="Context-702"><a href="#Context-702"><span class="linenos">702</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="Context-703"><a href="#Context-703"><span class="linenos">703</span></a>
</span><span id="Context-704"><a href="#Context-704"><span class="linenos">704</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">node_attr</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;box&quot;</span><span class="p">},</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context-705"><a href="#Context-705"><span class="linenos">705</span></a>
</span><span id="Context-706"><a href="#Context-706"><span class="linenos">706</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">upstream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Context-707"><a href="#Context-707"><span class="linenos">707</span></a>            <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="Context-708"><a href="#Context-708"><span class="linenos">708</span></a>            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upstream</span><span class="p">:</span>
</span><span id="Context-709"><a href="#Context-709"><span class="linenos">709</span></a>                <span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="Context-710"><a href="#Context-710"><span class="linenos">710</span></a>        <span class="k">return</span> <span class="n">graph</span>
</span><span id="Context-711"><a href="#Context-711"><span class="linenos">711</span></a>
</span><span id="Context-712"><a href="#Context-712"><span class="linenos">712</span></a>    <span class="k">def</span> <span class="nf">render_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Context-713"><a href="#Context-713"><span class="linenos">713</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the dag using graphviz.</span>
</span><span id="Context-714"><a href="#Context-714"><span class="linenos">714</span></a>
</span><span id="Context-715"><a href="#Context-715"><span class="linenos">715</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="Context-716"><a href="#Context-716"><span class="linenos">716</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="Context-717"><a href="#Context-717"><span class="linenos">717</span></a>
</span><span id="Context-718"><a href="#Context-718"><span class="linenos">718</span></a><span class="sd">        Args:</span>
</span><span id="Context-719"><a href="#Context-719"><span class="linenos">719</span></a><span class="sd">            path: filename to save the dag to</span>
</span><span id="Context-720"><a href="#Context-720"><span class="linenos">720</span></a><span class="sd">            format: The desired format to use when rending the dag</span>
</span><span id="Context-721"><a href="#Context-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-722"><a href="#Context-722"><span class="linenos">722</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dag</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context-723"><a href="#Context-723"><span class="linenos">723</span></a>
</span><span id="Context-724"><a href="#Context-724"><span class="linenos">724</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context-725"><a href="#Context-725"><span class="linenos">725</span></a>            <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context-726"><a href="#Context-726"><span class="linenos">726</span></a>        <span class="k">except</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">ExecutableNotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Context-727"><a href="#Context-727"><span class="linenos">727</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context-728"><a href="#Context-728"><span class="linenos">728</span></a>                <span class="s2">&quot;Graphviz is pip-installed but the system install is missing. Instructions: https://graphviz.org/download/&quot;</span>
</span><span id="Context-729"><a href="#Context-729"><span class="linenos">729</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="Context-730"><a href="#Context-730"><span class="linenos">730</span></a>
</span><span id="Context-731"><a href="#Context-731"><span class="linenos">731</span></a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
</span><span id="Context-732"><a href="#Context-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-733"><a href="#Context-733"><span class="linenos">733</span></a>        <span class="n">match_patterns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-734"><a href="#Context-734"><span class="linenos">734</span></a>        <span class="n">tests</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-735"><a href="#Context-735"><span class="linenos">735</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context-736"><a href="#Context-736"><span class="linenos">736</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span><span class="p">:</span>
</span><span id="Context-737"><a href="#Context-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover and run model tests&quot;&quot;&quot;</span>
</span><span id="Context-738"><a href="#Context-738"><span class="linenos">738</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="Context-739"><a href="#Context-739"><span class="linenos">739</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context-740"><a href="#Context-740"><span class="linenos">740</span></a>            <span class="k">if</span> <span class="n">tests</span><span class="p">:</span>
</span><span id="Context-741"><a href="#Context-741"><span class="linenos">741</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_model_tests</span><span class="p">(</span>
</span><span id="Context-742"><a href="#Context-742"><span class="linenos">742</span></a>                    <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">,</span>
</span><span id="Context-743"><a href="#Context-743"><span class="linenos">743</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="Context-744"><a href="#Context-744"><span class="linenos">744</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="Context-745"><a href="#Context-745"><span class="linenos">745</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="Context-746"><a href="#Context-746"><span class="linenos">746</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="Context-747"><a href="#Context-747"><span class="linenos">747</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="Context-748"><a href="#Context-748"><span class="linenos">748</span></a>                <span class="p">)</span>
</span><span id="Context-749"><a href="#Context-749"><span class="linenos">749</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Context-750"><a href="#Context-750"><span class="linenos">750</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_all_model_tests</span><span class="p">(</span>
</span><span id="Context-751"><a href="#Context-751"><span class="linenos">751</span></a>                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_directory_path</span><span class="p">,</span>
</span><span id="Context-752"><a href="#Context-752"><span class="linenos">752</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="Context-753"><a href="#Context-753"><span class="linenos">753</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="Context-754"><a href="#Context-754"><span class="linenos">754</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="Context-755"><a href="#Context-755"><span class="linenos">755</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="Context-756"><a href="#Context-756"><span class="linenos">756</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="Context-757"><a href="#Context-757"><span class="linenos">757</span></a>                <span class="p">)</span>
</span><span id="Context-758"><a href="#Context-758"><span class="linenos">758</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="Context-759"><a href="#Context-759"><span class="linenos">759</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Context-760"><a href="#Context-760"><span class="linenos">760</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Context-761"><a href="#Context-761"><span class="linenos">761</span></a>
</span><span id="Context-762"><a href="#Context-762"><span class="linenos">762</span></a>    <span class="k">def</span> <span class="nf">audit</span><span class="p">(</span>
</span><span id="Context-763"><a href="#Context-763"><span class="linenos">763</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-764"><a href="#Context-764"><span class="linenos">764</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context-765"><a href="#Context-765"><span class="linenos">765</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context-766"><a href="#Context-766"><span class="linenos">766</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context-767"><a href="#Context-767"><span class="linenos">767</span></a>        <span class="n">models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-768"><a href="#Context-768"><span class="linenos">768</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-769"><a href="#Context-769"><span class="linenos">769</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-770"><a href="#Context-770"><span class="linenos">770</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Audit models.</span>
</span><span id="Context-771"><a href="#Context-771"><span class="linenos">771</span></a>
</span><span id="Context-772"><a href="#Context-772"><span class="linenos">772</span></a><span class="sd">        Args:</span>
</span><span id="Context-773"><a href="#Context-773"><span class="linenos">773</span></a><span class="sd">            start: The start of the interval to audit.</span>
</span><span id="Context-774"><a href="#Context-774"><span class="linenos">774</span></a><span class="sd">            end: The end of the interval to audit.</span>
</span><span id="Context-775"><a href="#Context-775"><span class="linenos">775</span></a><span class="sd">            models: The models to audit. All models will be audited if not specified.</span>
</span><span id="Context-776"><a href="#Context-776"><span class="linenos">776</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context-777"><a href="#Context-777"><span class="linenos">777</span></a>
</span><span id="Context-778"><a href="#Context-778"><span class="linenos">778</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-779"><a href="#Context-779"><span class="linenos">779</span></a>
</span><span id="Context-780"><a href="#Context-780"><span class="linenos">780</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Context-781"><a href="#Context-781"><span class="linenos">781</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span> <span class="k">if</span> <span class="n">models</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context-782"><a href="#Context-782"><span class="linenos">782</span></a>        <span class="p">)</span>
</span><span id="Context-783"><a href="#Context-783"><span class="linenos">783</span></a>
</span><span id="Context-784"><a href="#Context-784"><span class="linenos">784</span></a>        <span class="n">num_audits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">audits</span><span class="p">)</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="Context-785"><a href="#Context-785"><span class="linenos">785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_audits</span><span class="si">}</span><span class="s2"> audit(s).&quot;</span><span class="p">)</span>
</span><span id="Context-786"><a href="#Context-786"><span class="linenos">786</span></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Context-787"><a href="#Context-787"><span class="linenos">787</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="Context-788"><a href="#Context-788"><span class="linenos">788</span></a>            <span class="k">for</span> <span class="n">audit_result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="Context-789"><a href="#Context-789"><span class="linenos">789</span></a>                <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="Context-790"><a href="#Context-790"><span class="linenos">790</span></a>                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context-791"><a href="#Context-791"><span class="linenos">791</span></a>                <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context-792"><a href="#Context-792"><span class="linenos">792</span></a>                <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context-793"><a href="#Context-793"><span class="linenos">793</span></a>                <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Context-794"><a href="#Context-794"><span class="linenos">794</span></a>            <span class="p">):</span>
</span><span id="Context-795"><a href="#Context-795"><span class="linenos">795</span></a>                <span class="k">if</span> <span class="n">audit_result</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
</span><span id="Context-796"><a href="#Context-796"><span class="linenos">796</span></a>                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audit_result</span><span class="p">)</span>
</span><span id="Context-797"><a href="#Context-797"><span class="linenos">797</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> FAIL.&quot;</span><span class="p">)</span>
</span><span id="Context-798"><a href="#Context-798"><span class="linenos">798</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Context-799"><a href="#Context-799"><span class="linenos">799</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PASS.&quot;</span><span class="p">)</span>
</span><span id="Context-800"><a href="#Context-800"><span class="linenos">800</span></a>
</span><span id="Context-801"><a href="#Context-801"><span class="linenos">801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> audit error(s).&quot;</span><span class="p">)</span>
</span><span id="Context-802"><a href="#Context-802"><span class="linenos">802</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="Context-803"><a href="#Context-803"><span class="linenos">803</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span>
</span><span id="Context-804"><a href="#Context-804"><span class="linenos">804</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failure in audit </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">_path</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="Context-805"><a href="#Context-805"><span class="linenos">805</span></a>            <span class="p">)</span>
</span><span id="Context-806"><a href="#Context-806"><span class="linenos">806</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> results, expected 0.&quot;</span><span class="p">)</span>
</span><span id="Context-807"><a href="#Context-807"><span class="linenos">807</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Context-808"><a href="#Context-808"><span class="linenos">808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span><span id="Context-809"><a href="#Context-809"><span class="linenos">809</span></a>
</span><span id="Context-810"><a href="#Context-810"><span class="linenos">810</span></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-811"><a href="#Context-811"><span class="linenos">811</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Releases all resources allocated by this context.&quot;&quot;&quot;</span>
</span><span id="Context-812"><a href="#Context-812"><span class="linenos">812</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Context-813"><a href="#Context-813"><span class="linenos">813</span></a>
</span><span id="Context-814"><a href="#Context-814"><span class="linenos">814</span></a>    <span class="k">def</span> <span class="nf">_run_plan_tests</span><span class="p">(</span>
</span><span id="Context-815"><a href="#Context-815"><span class="linenos">815</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Context-816"><a href="#Context-816"><span class="linenos">816</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Context-817"><a href="#Context-817"><span class="linenos">817</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_tests</span><span class="p">:</span>
</span><span id="Context-818"><a href="#Context-818"><span class="linenos">818</span></a>            <span class="n">test_output_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span id="Context-819"><a href="#Context-819"><span class="linenos">819</span></a>            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">test_output_io</span><span class="p">):</span>
</span><span id="Context-820"><a href="#Context-820"><span class="linenos">820</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</span><span id="Context-821"><a href="#Context-821"><span class="linenos">821</span></a>            <span class="n">test_output</span> <span class="o">=</span> <span class="n">test_output_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span id="Context-822"><a href="#Context-822"><span class="linenos">822</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_test_results</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">test_output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
</span><span id="Context-823"><a href="#Context-823"><span class="linenos">823</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
</span><span id="Context-824"><a href="#Context-824"><span class="linenos">824</span></a>                <span class="k">raise</span> <span class="n">PlanError</span><span class="p">(</span>
</span><span id="Context-825"><a href="#Context-825"><span class="linenos">825</span></a>                    <span class="s2">&quot;Cannot generate plan due to failing test(s). Fix test(s) and run again&quot;</span>
</span><span id="Context-826"><a href="#Context-826"><span class="linenos">826</span></a>                <span class="p">)</span>
</span><span id="Context-827"><a href="#Context-827"><span class="linenos">827</span></a>            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">test_output</span>
</span><span id="Context-828"><a href="#Context-828"><span class="linenos">828</span></a>        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="Context-829"><a href="#Context-829"><span class="linenos">829</span></a>
</span><span id="Context-830"><a href="#Context-830"><span class="linenos">830</span></a>    <span class="nd">@property</span>
</span><span id="Context-831"><a href="#Context-831"><span class="linenos">831</span></a>    <span class="k">def</span> <span class="nf">_model_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="Context-832"><a href="#Context-832"><span class="linenos">832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mapping of model name to physical table name.</span>
</span><span id="Context-833"><a href="#Context-833"><span class="linenos">833</span></a>
</span><span id="Context-834"><a href="#Context-834"><span class="linenos">834</span></a><span class="sd">        If a snapshot has not been versioned yet, its view name will be returned.</span>
</span><span id="Context-835"><a href="#Context-835"><span class="linenos">835</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context-836"><a href="#Context-836"><span class="linenos">836</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Context-837"><a href="#Context-837"><span class="linenos">837</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">table_name</span><span class="p">()</span>
</span><span id="Context-838"><a href="#Context-838"><span class="linenos">838</span></a>            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span>
</span><span id="Context-839"><a href="#Context-839"><span class="linenos">839</span></a>            <span class="k">else</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">qualified_view_name</span><span class="o">.</span><span class="n">for_environment</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">)</span>
</span><span id="Context-840"><a href="#Context-840"><span class="linenos">840</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Context-841"><a href="#Context-841"><span class="linenos">841</span></a>        <span class="p">}</span>
</span><span id="Context-842"><a href="#Context-842"><span class="linenos">842</span></a>
</span><span id="Context-843"><a href="#Context-843"><span class="linenos">843</span></a>    <span class="k">def</span> <span class="nf">_context_diff</span><span class="p">(</span>
</span><span id="Context-844"><a href="#Context-844"><span class="linenos">844</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context-845"><a href="#Context-845"><span class="linenos">845</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Environment</span><span class="p">,</span>
</span><span id="Context-846"><a href="#Context-846"><span class="linenos">846</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-847"><a href="#Context-847"><span class="linenos">847</span></a>        <span class="n">create_from</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context-848"><a href="#Context-848"><span class="linenos">848</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ContextDiff</span><span class="p">:</span>
</span><span id="Context-849"><a href="#Context-849"><span class="linenos">849</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context-850"><a href="#Context-850"><span class="linenos">850</span></a>        <span class="k">return</span> <span class="n">ContextDiff</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="Context-851"><a href="#Context-851"><span class="linenos">851</span></a>            <span class="n">environment</span><span class="p">,</span> <span class="n">snapshots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">create_from</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span>
</span><span id="Context-852"><a href="#Context-852"><span class="linenos">852</span></a>        <span class="p">)</span>
</span><span id="Context-853"><a href="#Context-853"><span class="linenos">853</span></a>
</span><span id="Context-854"><a href="#Context-854"><span class="linenos">854</span></a>    <span class="k">def</span> <span class="nf">_load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Config</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Config</span><span class="p">:</span>
</span><span id="Context-855"><a href="#Context-855"><span class="linenos">855</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">Config</span><span class="p">):</span>
</span><span id="Context-856"><a href="#Context-856"><span class="linenos">856</span></a>            <span class="k">return</span> <span class="n">config</span>
</span><span id="Context-857"><a href="#Context-857"><span class="linenos">857</span></a>
</span><span id="Context-858"><a href="#Context-858"><span class="linenos">858</span></a>        <span class="n">lookup_paths</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Context-859"><a href="#Context-859"><span class="linenos">859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sqlmesh_path</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">,</span>
</span><span id="Context-860"><a href="#Context-860"><span class="linenos">860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sqlmesh_path</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="Context-861"><a href="#Context-861"><span class="linenos">861</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.py&quot;</span><span class="p">,</span>
</span><span id="Context-862"><a href="#Context-862"><span class="linenos">862</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">,</span>
</span><span id="Context-863"><a href="#Context-863"><span class="linenos">863</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
</span><span id="Context-864"><a href="#Context-864"><span class="linenos">864</span></a>        <span class="p">]</span>
</span><span id="Context-865"><a href="#Context-865"><span class="linenos">865</span></a>        <span class="k">return</span> <span class="n">load_config_from_paths</span><span class="p">(</span><span class="o">*</span><span class="n">lookup_paths</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span id="Context-866"><a href="#Context-866"><span class="linenos">866</span></a>
</span><span id="Context-867"><a href="#Context-867"><span class="linenos">867</span></a>    <span class="k">def</span> <span class="nf">_add_model_to_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-868"><a href="#Context-868"><span class="linenos">868</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Context-869"><a href="#Context-869"><span class="linenos">869</span></a>
</span><span id="Context-870"><a href="#Context-870"><span class="linenos">870</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">depends_on</span><span class="p">)</span>
</span><span id="Context-871"><a href="#Context-871"><span class="linenos">871</span></a>
</span><span id="Context-872"><a href="#Context-872"><span class="linenos">872</span></a>    <span class="k">def</span> <span class="nf">_run_janitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context-873"><a href="#Context-873"><span class="linenos">873</span></a>        <span class="n">expired_environments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">delete_expired_environments</span><span class="p">()</span>
</span><span id="Context-874"><a href="#Context-874"><span class="linenos">874</span></a>        <span class="k">for</span> <span class="n">expired_environment</span> <span class="ow">in</span> <span class="n">expired_environments</span><span class="p">:</span>
</span><span id="Context-875"><a href="#Context-875"><span class="linenos">875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">demote</span><span class="p">(</span><span class="n">expired_environment</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">expired_environment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="Context-876"><a href="#Context-876"><span class="linenos">876</span></a>
</span><span id="Context-877"><a href="#Context-877"><span class="linenos">877</span></a>        <span class="n">expired_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">delete_expired_snapshots</span><span class="p">()</span>
</span><span id="Context-878"><a href="#Context-878"><span class="linenos">878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">expired_snapshots</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Encapsulates a SQLMesh environment supplying convenient functions to perform various tasks.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>engine_adapter:</strong>  The default engine adapter to use.</li>
<li><strong>notification_targets:</strong>  The notification target to use. Defaults to what is defined in config.</li>
<li><strong>dialect:</strong>  Default dialect of the sql in models.</li>
<li><strong>physical_schema:</strong>  The schema used to store physical materialized tables.</li>
<li><strong>snapshot_ttl:</strong>  Duration before unpromoted snapshots are removed.</li>
<li><strong>path:</strong>  The directory containing SQLMesh files.</li>
<li><strong>config:</strong>  A Config object or the name of a Config object in config.py.</li>
<li><strong>connection:</strong>  The name of the connection. If not specified the first connection as it appears
in configuration will be used.</li>
<li><strong>test_connection:</strong>  The name of the connection to use for tests. If not specified the first
connection as it appears in configuration will be used.</li>
<li><strong>concurrent_tasks:</strong>  The maximum number of tasks that can use the connection concurrently.</li>
<li><strong>load:</strong>  Whether or not to automatically load all models and macros (default True).</li>
<li><strong>console:</strong>  The rich instance used for printing out CLI command results.</li>
<li><strong>users:</strong>  A list of users to make known to SQLMesh.</li>
</ul>
</div>


                            <div id="Context.__init__" class="classattr">
                                        <input id="Context.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Context</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">engine_adapter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="engine_adapter/base.html#EngineAdapter">sqlmesh.core.engine_adapter.base.EngineAdapter</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">notification_targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="notification_target.html#ConsoleNotificationTarget">sqlmesh.core.notification_target.ConsoleNotificationTarget</a></span><span class="p">,</span> <span class="n"><a href="../integrations/github/notification_target.html#GithubNotificationTarget">sqlmesh.integrations.github.notification_target.GithubNotificationTarget</a></span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">PydanticUndefined</span><span class="p">,</span> <span class="n">discriminator</span><span class="o">=</span><span class="s1">&#39;type_&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{})]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">state_sync</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="state_sync/base.html#StateSync">sqlmesh.core.state_sync.base.StateSync</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dialect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">physical_schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">snapshot_ttl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="config/root.html#Config">sqlmesh.core.config.root.Config</a></span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">test_connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">concurrent_tasks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">loader</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n"><a href="loader.html#Loader">sqlmesh.core.loader.Loader</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">console</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n"><a href="console.html#Console">sqlmesh.core.console.Console</a></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">users</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n"><a href="user.html#User">sqlmesh.core.user.User</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Context.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.__init__-190"><a href="#Context.__init__-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Context.__init__-191"><a href="#Context.__init__-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.__init__-192"><a href="#Context.__init__-192"><span class="linenos">192</span></a>        <span class="n">engine_adapter</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">EngineAdapter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-193"><a href="#Context.__init__-193"><span class="linenos">193</span></a>        <span class="n">notification_targets</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">NotificationTarget</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-194"><a href="#Context.__init__-194"><span class="linenos">194</span></a>        <span class="n">state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-195"><a href="#Context.__init__-195"><span class="linenos">195</span></a>        <span class="n">dialect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context.__init__-196"><a href="#Context.__init__-196"><span class="linenos">196</span></a>        <span class="n">physical_schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context.__init__-197"><a href="#Context.__init__-197"><span class="linenos">197</span></a>        <span class="n">snapshot_ttl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context.__init__-198"><a href="#Context.__init__-198"><span class="linenos">198</span></a>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Context.__init__-199"><a href="#Context.__init__-199"><span class="linenos">199</span></a>        <span class="n">config</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">Config</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-200"><a href="#Context.__init__-200"><span class="linenos">200</span></a>        <span class="n">connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-201"><a href="#Context.__init__-201"><span class="linenos">201</span></a>        <span class="n">test_connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-202"><a href="#Context.__init__-202"><span class="linenos">202</span></a>        <span class="n">concurrent_tasks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-203"><a href="#Context.__init__-203"><span class="linenos">203</span></a>        <span class="n">loader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="n">Loader</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-204"><a href="#Context.__init__-204"><span class="linenos">204</span></a>        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Context.__init__-205"><a href="#Context.__init__-205"><span class="linenos">205</span></a>        <span class="n">console</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Console</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-206"><a href="#Context.__init__-206"><span class="linenos">206</span></a>        <span class="n">users</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">User</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.__init__-207"><a href="#Context.__init__-207"><span class="linenos">207</span></a>    <span class="p">):</span>
</span><span id="Context.__init__-208"><a href="#Context.__init__-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">console</span> <span class="ow">or</span> <span class="n">get_console</span><span class="p">()</span>
</span><span id="Context.__init__-209"><a href="#Context.__init__-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
</span><span id="Context.__init__-210"><a href="#Context.__init__-210"><span class="linenos">210</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
</span><span id="Context.__init__-211"><a href="#Context.__init__-211"><span class="linenos">211</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not a directory&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-212"><a href="#Context.__init__-212"><span class="linenos">212</span></a>
</span><span id="Context.__init__-213"><a href="#Context.__init__-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_config</span><span class="p">(</span><span class="n">config</span> <span class="ow">or</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-214"><a href="#Context.__init__-214"><span class="linenos">214</span></a>
</span><span id="Context.__init__-215"><a href="#Context.__init__-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">physical_schema</span> <span class="o">=</span> <span class="n">physical_schema</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">physical_schema</span> <span class="ow">or</span> <span class="s2">&quot;sqlmesh&quot;</span>
</span><span id="Context.__init__-216"><a href="#Context.__init__-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="o">=</span> <span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">snapshot_ttl</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_SNAPSHOT_TTL</span>
</span><span id="Context.__init__-217"><a href="#Context.__init__-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">:</span> <span class="n">DAG</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">()</span>
</span><span id="Context.__init__-218"><a href="#Context.__init__-218"><span class="linenos">218</span></a>
</span><span id="Context.__init__-219"><a href="#Context.__init__-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-220"><a href="#Context.__init__-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Audit</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;audits&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-221"><a href="#Context.__init__-221"><span class="linenos">221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExecutableOrMacro</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;macros&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-222"><a href="#Context.__init__-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">:</span> <span class="n">UniqueKeyDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">hook</span><span class="p">]</span> <span class="o">=</span> <span class="n">UniqueKeyDict</span><span class="p">(</span><span class="s2">&quot;hooks&quot;</span><span class="p">)</span>
</span><span id="Context.__init__-223"><a href="#Context.__init__-223"><span class="linenos">223</span></a>
</span><span id="Context.__init__-224"><a href="#Context.__init__-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</span><span id="Context.__init__-225"><a href="#Context.__init__-225"><span class="linenos">225</span></a>        <span class="n">connection_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</span><span id="Context.__init__-226"><a href="#Context.__init__-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span> <span class="o">=</span> <span class="n">concurrent_tasks</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="Context.__init__-227"><a href="#Context.__init__-227"><span class="linenos">227</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span> <span class="o">=</span> <span class="n">engine_adapter</span> <span class="ow">or</span> <span class="n">connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="Context.__init__-228"><a href="#Context.__init__-228"><span class="linenos">228</span></a>
</span><span id="Context.__init__-229"><a href="#Context.__init__-229"><span class="linenos">229</span></a>        <span class="n">test_connection_config</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Context.__init__-230"><a href="#Context.__init__-230"><span class="linenos">230</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">test_connection</span>
</span><span id="Context.__init__-231"><a href="#Context.__init__-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">test_connection</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="Context.__init__-232"><a href="#Context.__init__-232"><span class="linenos">232</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">test_connection</span><span class="p">)</span>
</span><span id="Context.__init__-233"><a href="#Context.__init__-233"><span class="linenos">233</span></a>        <span class="p">)</span>
</span><span id="Context.__init__-234"><a href="#Context.__init__-234"><span class="linenos">234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span> <span class="o">=</span> <span class="n">test_connection_config</span><span class="o">.</span><span class="n">create_engine_adapter</span><span class="p">()</span>
</span><span id="Context.__init__-235"><a href="#Context.__init__-235"><span class="linenos">235</span></a>
</span><span id="Context.__init__-236"><a href="#Context.__init__-236"><span class="linenos">236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_defaults</span><span class="o">.</span><span class="n">dialect</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_adapter</span><span class="o">.</span><span class="n">dialect</span>
</span><span id="Context.__init__-237"><a href="#Context.__init__-237"><span class="linenos">237</span></a>
</span><span id="Context.__init__-238"><a href="#Context.__init__-238"><span class="linenos">238</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span> <span class="o">=</span> <span class="n">SnapshotEvaluator</span><span class="p">(</span>
</span><span id="Context.__init__-239"><a href="#Context.__init__-239"><span class="linenos">239</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">engine_adapter</span><span class="p">,</span> <span class="n">ddl_concurrent_tasks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span>
</span><span id="Context.__init__-240"><a href="#Context.__init__-240"><span class="linenos">240</span></a>        <span class="p">)</span>
</span><span id="Context.__init__-241"><a href="#Context.__init__-241"><span class="linenos">241</span></a>
</span><span id="Context.__init__-242"><a href="#Context.__init__-242"><span class="linenos">242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">notification_targets</span> <span class="o">+</span> <span class="p">(</span><span class="n">notification_targets</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Context.__init__-243"><a href="#Context.__init__-243"><span class="linenos">243</span></a>
</span><span id="Context.__init__-244"><a href="#Context.__init__-244"><span class="linenos">244</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_provided_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_sync</span>
</span><span id="Context.__init__-245"><a href="#Context.__init__-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_sync</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateSync</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Context.__init__-246"><a href="#Context.__init__-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_reader</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">StateReader</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Context.__init__-247"><a href="#Context.__init__-247"><span class="linenos">247</span></a>
</span><span id="Context.__init__-248"><a href="#Context.__init__-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">users</span> <span class="o">+</span> <span class="p">(</span><span class="n">users</span> <span class="ow">or</span> <span class="p">[])</span>
</span><span id="Context.__init__-249"><a href="#Context.__init__-249"><span class="linenos">249</span></a>
</span><span id="Context.__init__-250"><a href="#Context.__init__-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="p">(</span><span class="n">loader</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">loader</span> <span class="ow">or</span> <span class="n">SqlMeshLoader</span><span class="p">)()</span>
</span><span id="Context.__init__-251"><a href="#Context.__init__-251"><span class="linenos">251</span></a>
</span><span id="Context.__init__-252"><a href="#Context.__init__-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span id="Context.__init__-253"><a href="#Context.__init__-253"><span class="linenos">253</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Context.engine_adapter" class="classattr">
                                <div class="attr variable">
            <span class="name">engine_adapter</span><span class="annotation">: <a href="engine_adapter/base.html#EngineAdapter">sqlmesh.core.engine_adapter.base.EngineAdapter</a></span>

        
    </div>
    <a class="headerlink" href="#Context.engine_adapter"></a>
    
            <div class="docstring"><p>Returns an engine adapter.</p>
</div>


                            </div>
                            <div id="Context.upsert_model" class="classattr">
                                        <input id="Context.upsert_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">upsert_model</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="model/definition.html#SqlModel">sqlmesh.core.model.definition.SqlModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#SeedModel">sqlmesh.core.model.definition.SeedModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#PythonModel">sqlmesh.core.model.definition.PythonModel</a></span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">PydanticUndefined</span><span class="p">,</span> <span class="n">discriminator</span><span class="o">=</span><span class="s1">&#39;source_type&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{})]]</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="model/definition.html#SqlModel">sqlmesh.core.model.definition.SqlModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#SeedModel">sqlmesh.core.model.definition.SeedModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#PythonModel">sqlmesh.core.model.definition.PythonModel</a></span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">PydanticUndefined</span><span class="p">,</span> <span class="n">discriminator</span><span class="o">=</span><span class="s1">&#39;source_type&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{})]</span>:</span></span>

                <label class="view-source-button" for="Context.upsert_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.upsert_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.upsert_model-260"><a href="#Context.upsert_model-260"><span class="linenos">260</span></a>    <span class="k">def</span> <span class="nf">upsert_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
</span><span id="Context.upsert_model-261"><a href="#Context.upsert_model-261"><span class="linenos">261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update or insert a model.</span>
</span><span id="Context.upsert_model-262"><a href="#Context.upsert_model-262"><span class="linenos">262</span></a>
</span><span id="Context.upsert_model-263"><a href="#Context.upsert_model-263"><span class="linenos">263</span></a><span class="sd">        The context&#39;s models dictionary will be updated to include these changes.</span>
</span><span id="Context.upsert_model-264"><a href="#Context.upsert_model-264"><span class="linenos">264</span></a>
</span><span id="Context.upsert_model-265"><a href="#Context.upsert_model-265"><span class="linenos">265</span></a><span class="sd">        Args:</span>
</span><span id="Context.upsert_model-266"><a href="#Context.upsert_model-266"><span class="linenos">266</span></a><span class="sd">            model: Model name or instance to update.</span>
</span><span id="Context.upsert_model-267"><a href="#Context.upsert_model-267"><span class="linenos">267</span></a><span class="sd">            kwargs: The kwargs to update the model with.</span>
</span><span id="Context.upsert_model-268"><a href="#Context.upsert_model-268"><span class="linenos">268</span></a>
</span><span id="Context.upsert_model-269"><a href="#Context.upsert_model-269"><span class="linenos">269</span></a><span class="sd">        Returns:</span>
</span><span id="Context.upsert_model-270"><a href="#Context.upsert_model-270"><span class="linenos">270</span></a><span class="sd">            A new instance of the updated or inserted model.</span>
</span><span id="Context.upsert_model-271"><a href="#Context.upsert_model-271"><span class="linenos">271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.upsert_model-272"><a href="#Context.upsert_model-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context.upsert_model-273"><a href="#Context.upsert_model-273"><span class="linenos">273</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
</span><span id="Context.upsert_model-274"><a href="#Context.upsert_model-274"><span class="linenos">274</span></a>
</span><span id="Context.upsert_model-275"><a href="#Context.upsert_model-275"><span class="linenos">275</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_path</span>  <span class="c1"># type: ignore</span>
</span><span id="Context.upsert_model-276"><a href="#Context.upsert_model-276"><span class="linenos">276</span></a>        <span class="c1"># model.copy() can&#39;t be used here due to a cached state that can be a part of a model instance.</span>
</span><span id="Context.upsert_model-277"><a href="#Context.upsert_model-277"><span class="linenos">277</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)(</span><span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}))</span>
</span><span id="Context.upsert_model-278"><a href="#Context.upsert_model-278"><span class="linenos">278</span></a>        <span class="n">model</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="Context.upsert_model-279"><a href="#Context.upsert_model-279"><span class="linenos">279</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">model</span><span class="p">})</span>
</span><span id="Context.upsert_model-280"><a href="#Context.upsert_model-280"><span class="linenos">280</span></a>
</span><span id="Context.upsert_model-281"><a href="#Context.upsert_model-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_model_to_dag</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Context.upsert_model-282"><a href="#Context.upsert_model-282"><span class="linenos">282</span></a>        <span class="n">update_model_schemas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">)</span>
</span><span id="Context.upsert_model-283"><a href="#Context.upsert_model-283"><span class="linenos">283</span></a>
</span><span id="Context.upsert_model-284"><a href="#Context.upsert_model-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">model</span>
</span></pre></div>


            <div class="docstring"><p>Update or insert a model.</p>

<p>The context's models dictionary will be updated to include these changes.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>model:</strong>  Model name or instance to update.</li>
<li><strong>kwargs:</strong>  The kwargs to update the model with.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>A new instance of the updated or inserted model.</p>
</blockquote>
</div>


                            </div>
                            <div id="Context.scheduler" class="classattr">
                                        <input id="Context.scheduler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">scheduler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="scheduler.html#Scheduler">sqlmesh.core.scheduler.Scheduler</a></span>:</span></span>

                <label class="view-source-button" for="Context.scheduler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.scheduler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.scheduler-286"><a href="#Context.scheduler-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scheduler</span><span class="p">:</span>
</span><span id="Context.scheduler-287"><a href="#Context.scheduler-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the built-in scheduler.</span>
</span><span id="Context.scheduler-288"><a href="#Context.scheduler-288"><span class="linenos">288</span></a>
</span><span id="Context.scheduler-289"><a href="#Context.scheduler-289"><span class="linenos">289</span></a><span class="sd">        Args:</span>
</span><span id="Context.scheduler-290"><a href="#Context.scheduler-290"><span class="linenos">290</span></a><span class="sd">            environment: The target environment to source model snapshots from, or None</span>
</span><span id="Context.scheduler-291"><a href="#Context.scheduler-291"><span class="linenos">291</span></a><span class="sd">                if snapshots should be sourced from the currently loaded local state.</span>
</span><span id="Context.scheduler-292"><a href="#Context.scheduler-292"><span class="linenos">292</span></a>
</span><span id="Context.scheduler-293"><a href="#Context.scheduler-293"><span class="linenos">293</span></a><span class="sd">        Returns:</span>
</span><span id="Context.scheduler-294"><a href="#Context.scheduler-294"><span class="linenos">294</span></a><span class="sd">            The built-in scheduler instance.</span>
</span><span id="Context.scheduler-295"><a href="#Context.scheduler-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.scheduler-296"><a href="#Context.scheduler-296"><span class="linenos">296</span></a>        <span class="n">snapshots</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Snapshot</span><span class="p">]</span>
</span><span id="Context.scheduler-297"><a href="#Context.scheduler-297"><span class="linenos">297</span></a>        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.scheduler-298"><a href="#Context.scheduler-298"><span class="linenos">298</span></a>            <span class="n">stored_environment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_environment</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context.scheduler-299"><a href="#Context.scheduler-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="n">stored_environment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.scheduler-300"><a href="#Context.scheduler-300"><span class="linenos">300</span></a>                <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Environment &#39;</span><span class="si">{</span><span class="n">environment</span><span class="si">}</span><span class="s2">&#39; was not found.&quot;</span><span class="p">)</span>
</span><span id="Context.scheduler-301"><a href="#Context.scheduler-301"><span class="linenos">301</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">stored_environment</span><span class="o">.</span><span class="n">snapshots</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context.scheduler-302"><a href="#Context.scheduler-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context.scheduler-303"><a href="#Context.scheduler-303"><span class="linenos">303</span></a>            <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context.scheduler-304"><a href="#Context.scheduler-304"><span class="linenos">304</span></a>
</span><span id="Context.scheduler-305"><a href="#Context.scheduler-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="Context.scheduler-306"><a href="#Context.scheduler-306"><span class="linenos">306</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span><span class="s2">&quot;No models were found&quot;</span><span class="p">)</span>
</span><span id="Context.scheduler-307"><a href="#Context.scheduler-307"><span class="linenos">307</span></a>
</span><span id="Context.scheduler-308"><a href="#Context.scheduler-308"><span class="linenos">308</span></a>        <span class="k">return</span> <span class="n">Scheduler</span><span class="p">(</span>
</span><span id="Context.scheduler-309"><a href="#Context.scheduler-309"><span class="linenos">309</span></a>            <span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context.scheduler-310"><a href="#Context.scheduler-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="p">,</span>
</span><span id="Context.scheduler-311"><a href="#Context.scheduler-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_sync</span><span class="p">,</span>
</span><span id="Context.scheduler-312"><a href="#Context.scheduler-312"><span class="linenos">312</span></a>            <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrent_tasks</span><span class="p">,</span>
</span><span id="Context.scheduler-313"><a href="#Context.scheduler-313"><span class="linenos">313</span></a>            <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
</span><span id="Context.scheduler-314"><a href="#Context.scheduler-314"><span class="linenos">314</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns the built-in scheduler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>environment:</strong>  The target environment to source model snapshots from, or None
if snapshots should be sourced from the currently loaded local state.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The built-in scheduler instance.</p>
</blockquote>
</div>


                            </div>
                            <div id="Context.sqlmesh_path" class="classattr">
                                <div class="attr variable">
            <span class="name">sqlmesh_path</span><span class="annotation">: pathlib.Path</span>

        
    </div>
    <a class="headerlink" href="#Context.sqlmesh_path"></a>
    
            <div class="docstring"><p>Path to the SQLMesh home directory.</p>
</div>


                            </div>
                            <div id="Context.models_directory_path" class="classattr">
                                <div class="attr variable">
            <span class="name">models_directory_path</span><span class="annotation">: pathlib.Path</span>

        
    </div>
    <a class="headerlink" href="#Context.models_directory_path"></a>
    
            <div class="docstring"><p>Path to the directory where the models are defined</p>
</div>


                            </div>
                            <div id="Context.macro_directory_path" class="classattr">
                                <div class="attr variable">
            <span class="name">macro_directory_path</span><span class="annotation">: pathlib.Path</span>

        
    </div>
    <a class="headerlink" href="#Context.macro_directory_path"></a>
    
            <div class="docstring"><p>Path to the directory where macros are defined</p>
</div>


                            </div>
                            <div id="Context.hook_directory_path" class="classattr">
                                <div class="attr variable">
            <span class="name">hook_directory_path</span><span class="annotation">: pathlib.Path</span>

        
    </div>
    <a class="headerlink" href="#Context.hook_directory_path"></a>
    
            <div class="docstring"><p>Path to the directory where hooks are defined</p>
</div>


                            </div>
                            <div id="Context.refresh" class="classattr">
                                        <input id="Context.refresh-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">refresh</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.refresh-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.refresh"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.refresh-374"><a href="#Context.refresh-374"><span class="linenos">374</span></a>    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.refresh-375"><a href="#Context.refresh-375"><span class="linenos">375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refresh all models that have been updated.&quot;&quot;&quot;</span>
</span><span id="Context.refresh-376"><a href="#Context.refresh-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">reload_needed</span><span class="p">():</span>
</span><span id="Context.refresh-377"><a href="#Context.refresh-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Refresh all models that have been updated.</p>
</div>


                            </div>
                            <div id="Context.load" class="classattr">
                                        <input id="Context.load-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#Context">sqlmesh.core.context.Context</a></span>:</span></span>

                <label class="view-source-button" for="Context.load-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.load"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.load-379"><a href="#Context.load-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Context</span><span class="p">:</span>
</span><span id="Context.load-380"><a href="#Context.load-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load all files in the context&#39;s path.&quot;&quot;&quot;</span>
</span><span id="Context.load-381"><a href="#Context.load-381"><span class="linenos">381</span></a>        <span class="k">with</span> <span class="n">sys_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
</span><span id="Context.load-382"><a href="#Context.load-382"><span class="linenos">382</span></a>            <span class="n">project</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Context.load-383"><a href="#Context.load-383"><span class="linenos">383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">hooks</span>
</span><span id="Context.load-384"><a href="#Context.load-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_macros</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">macros</span>
</span><span id="Context.load-385"><a href="#Context.load-385"><span class="linenos">385</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_models</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">models</span>
</span><span id="Context.load-386"><a href="#Context.load-386"><span class="linenos">386</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_audits</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">audits</span>
</span><span id="Context.load-387"><a href="#Context.load-387"><span class="linenos">387</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">dag</span>
</span><span id="Context.load-388"><a href="#Context.load-388"><span class="linenos">388</span></a>
</span><span id="Context.load-389"><a href="#Context.load-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Load all files in the context's path.</p>
</div>


                            </div>
                            <div id="Context.run" class="classattr">
                                        <input id="Context.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">skip_janitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.run-391"><a href="#Context.run-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
</span><span id="Context.run-392"><a href="#Context.run-392"><span class="linenos">392</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.run-393"><a href="#Context.run-393"><span class="linenos">393</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.run-394"><a href="#Context.run-394"><span class="linenos">394</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context.run-395"><a href="#Context.run-395"><span class="linenos">395</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.run-396"><a href="#Context.run-396"><span class="linenos">396</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.run-397"><a href="#Context.run-397"><span class="linenos">397</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.run-398"><a href="#Context.run-398"><span class="linenos">398</span></a>        <span class="n">skip_janitor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.run-399"><a href="#Context.run-399"><span class="linenos">399</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.run-400"><a href="#Context.run-400"><span class="linenos">400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the entire dag through the scheduler.</span>
</span><span id="Context.run-401"><a href="#Context.run-401"><span class="linenos">401</span></a>
</span><span id="Context.run-402"><a href="#Context.run-402"><span class="linenos">402</span></a><span class="sd">        Args:</span>
</span><span id="Context.run-403"><a href="#Context.run-403"><span class="linenos">403</span></a><span class="sd">            environment: The target environment to source model snapshots from. Default: prod.</span>
</span><span id="Context.run-404"><a href="#Context.run-404"><span class="linenos">404</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="Context.run-405"><a href="#Context.run-405"><span class="linenos">405</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="Context.run-406"><a href="#Context.run-406"><span class="linenos">406</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context.run-407"><a href="#Context.run-407"><span class="linenos">407</span></a><span class="sd">            skip_janitor: Whether to skip the jantitor task.</span>
</span><span id="Context.run-408"><a href="#Context.run-408"><span class="linenos">408</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.run-409"><a href="#Context.run-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">(</span><span class="n">environment</span><span class="o">=</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="p">)</span>
</span><span id="Context.run-410"><a href="#Context.run-410"><span class="linenos">410</span></a>
</span><span id="Context.run-411"><a href="#Context.run-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_janitor</span><span class="p">:</span>
</span><span id="Context.run-412"><a href="#Context.run-412"><span class="linenos">412</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_run_janitor</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Run the entire dag through the scheduler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>environment:</strong>  The target environment to source model snapshots from. Default: prod.</li>
<li><strong>start:</strong>  The start of the interval to render.</li>
<li><strong>end:</strong>  The end of the interval to render.</li>
<li><strong>latest:</strong>  The latest time used for non incremental datasets.</li>
<li><strong>skip_janitor:</strong>  Whether to skip the jantitor task.</li>
</ul>
</div>


                            </div>
                            <div id="Context.get_model" class="classattr">
                                        <input id="Context.get_model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_model</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="model/definition.html#SqlModel">sqlmesh.core.model.definition.SqlModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#SeedModel">sqlmesh.core.model.definition.SeedModel</a></span><span class="p">,</span> <span class="n"><a href="model/definition.html#PythonModel">sqlmesh.core.model.definition.PythonModel</a></span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">PydanticUndefined</span><span class="p">,</span> <span class="n">discriminator</span><span class="o">=</span><span class="s1">&#39;source_type&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{})]]</span>:</span></span>

                <label class="view-source-button" for="Context.get_model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.get_model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.get_model-414"><a href="#Context.get_model-414"><span class="linenos">414</span></a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Model</span><span class="p">]:</span>
</span><span id="Context.get_model-415"><a href="#Context.get_model-415"><span class="linenos">415</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a model with the given name or None if a model with such name doesn&#39;t exist.&quot;&quot;&quot;</span>
</span><span id="Context.get_model-416"><a href="#Context.get_model-416"><span class="linenos">416</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns a model with the given name or None if a model with such name doesn't exist.</p>
</div>


                            </div>
                            <div id="Context.models" class="classattr">
                                <div class="attr variable">
            <span class="name">models</span><span class="annotation">: mappingproxy[str, typing.Annotated[typing.Union[<a href="model/definition.html#SqlModel">sqlmesh.core.model.definition.SqlModel</a>, <a href="model/definition.html#SeedModel">sqlmesh.core.model.definition.SeedModel</a>, <a href="model/definition.html#PythonModel">sqlmesh.core.model.definition.PythonModel</a>], FieldInfo(default=PydanticUndefined, discriminator=&#39;source_type&#39;, extra={})]]</span>

        
    </div>
    <a class="headerlink" href="#Context.models"></a>
    
            <div class="docstring"><p>Returns all registered models in this context.</p>
</div>


                            </div>
                            <div id="Context.macros" class="classattr">
                                <div class="attr variable">
            <span class="name">macros</span><span class="annotation">: mappingproxy[str, typing.Union[<a href="../utils/metaprogramming.html#Executable">sqlmesh.utils.metaprogramming.Executable</a>, <a href="macros.html#macro">sqlmesh.core.macros.macro</a>]]</span>

        
    </div>
    <a class="headerlink" href="#Context.macros"></a>
    
            <div class="docstring"><p>Returns all registered macros in this context.</p>
</div>


                            </div>
                            <div id="Context.hooks" class="classattr">
                                <div class="attr variable">
            <span class="name">hooks</span><span class="annotation">: mappingproxy[str, <a href="hooks.html#hook">sqlmesh.core.hooks.hook</a>]</span>

        
    </div>
    <a class="headerlink" href="#Context.hooks"></a>
    
            <div class="docstring"><p>Returns all registered hooks in this context.</p>
</div>


                            </div>
                            <div id="Context.snapshots" class="classattr">
                                <div class="attr variable">
            <span class="name">snapshots</span><span class="annotation">: Dict[str, <a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a>]</span>

        
    </div>
    <a class="headerlink" href="#Context.snapshots"></a>
    
            <div class="docstring"><p>Generates and returns snapshots based on models registered in this context.</p>

<p>If one of the snapshots has been previosly stored in the persisted state, the stored
instance will be returned.</p>
</div>


                            </div>
                            <div id="Context.local_snapshots" class="classattr">
                                <div class="attr variable">
            <span class="name">local_snapshots</span><span class="annotation">: Dict[str, <a href="snapshot/definition.html#Snapshot">sqlmesh.core.snapshot.definition.Snapshot</a>]</span>

        
    </div>
    <a class="headerlink" href="#Context.local_snapshots"></a>
    
            <div class="docstring"><p>Generates and returns snapshots based on models registered in this context without reconciling them
with the persisted state.</p>
</div>


                            </div>
                            <div id="Context.render" class="classattr">
                                        <input id="Context.render-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">render</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">model_or_snapshot</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">MagicMock</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;5983644704&#39;</span><span class="o">&gt;</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">expand</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="n">sqlglot</span><span class="o">.</span><span class="n">expressions</span><span class="o">.</span><span class="n">Expression</span>:</span></span>

                <label class="view-source-button" for="Context.render-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.render"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.render-467"><a href="#Context.render-467"><span class="linenos">467</span></a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span>
</span><span id="Context.render-468"><a href="#Context.render-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.render-469"><a href="#Context.render-469"><span class="linenos">469</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="Context.render-470"><a href="#Context.render-470"><span class="linenos">470</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context.render-471"><a href="#Context.render-471"><span class="linenos">471</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.render-472"><a href="#Context.render-472"><span class="linenos">472</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.render-473"><a href="#Context.render-473"><span class="linenos">473</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.render-474"><a href="#Context.render-474"><span class="linenos">474</span></a>        <span class="n">expand</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.render-475"><a href="#Context.render-475"><span class="linenos">475</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Context.render-476"><a href="#Context.render-476"><span class="linenos">476</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
</span><span id="Context.render-477"><a href="#Context.render-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Renders a model&#39;s query, expanding macros with provided kwargs, and optionally expanding referenced models.</span>
</span><span id="Context.render-478"><a href="#Context.render-478"><span class="linenos">478</span></a>
</span><span id="Context.render-479"><a href="#Context.render-479"><span class="linenos">479</span></a><span class="sd">        Args:</span>
</span><span id="Context.render-480"><a href="#Context.render-480"><span class="linenos">480</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="Context.render-481"><a href="#Context.render-481"><span class="linenos">481</span></a><span class="sd">            start: The start of the interval to render.</span>
</span><span id="Context.render-482"><a href="#Context.render-482"><span class="linenos">482</span></a><span class="sd">            end: The end of the interval to render.</span>
</span><span id="Context.render-483"><a href="#Context.render-483"><span class="linenos">483</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context.render-484"><a href="#Context.render-484"><span class="linenos">484</span></a><span class="sd">            expand: Whether or not to use expand materialized models, defaults to False.</span>
</span><span id="Context.render-485"><a href="#Context.render-485"><span class="linenos">485</span></a><span class="sd">                If True, all referenced models are expanded as raw queries.</span>
</span><span id="Context.render-486"><a href="#Context.render-486"><span class="linenos">486</span></a><span class="sd">                If a list, only referenced models are expanded as raw queries.</span>
</span><span id="Context.render-487"><a href="#Context.render-487"><span class="linenos">487</span></a>
</span><span id="Context.render-488"><a href="#Context.render-488"><span class="linenos">488</span></a><span class="sd">        Returns:</span>
</span><span id="Context.render-489"><a href="#Context.render-489"><span class="linenos">489</span></a><span class="sd">            The rendered expression.</span>
</span><span id="Context.render-490"><a href="#Context.render-490"><span class="linenos">490</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.render-491"><a href="#Context.render-491"><span class="linenos">491</span></a>        <span class="n">latest</span> <span class="o">=</span> <span class="n">latest</span> <span class="ow">or</span> <span class="n">yesterday_ds</span><span class="p">()</span>
</span><span id="Context.render-492"><a href="#Context.render-492"><span class="linenos">492</span></a>
</span><span id="Context.render-493"><a href="#Context.render-493"><span class="linenos">493</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context.render-494"><a href="#Context.render-494"><span class="linenos">494</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="Context.render-495"><a href="#Context.render-495"><span class="linenos">495</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="Context.render-496"><a href="#Context.render-496"><span class="linenos">496</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">model</span>
</span><span id="Context.render-497"><a href="#Context.render-497"><span class="linenos">497</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context.render-498"><a href="#Context.render-498"><span class="linenos">498</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="Context.render-499"><a href="#Context.render-499"><span class="linenos">499</span></a>
</span><span id="Context.render-500"><a href="#Context.render-500"><span class="linenos">500</span></a>        <span class="n">expand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">upstream</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">expand</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">expand</span> <span class="ow">or</span> <span class="p">[]</span>
</span><span id="Context.render-501"><a href="#Context.render-501"><span class="linenos">501</span></a>
</span><span id="Context.render-502"><a href="#Context.render-502"><span class="linenos">502</span></a>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">is_seed</span><span class="p">:</span>
</span><span id="Context.render-503"><a href="#Context.render-503"><span class="linenos">503</span></a>            <span class="n">df</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="Context.render-504"><a href="#Context.render-504"><span class="linenos">504</span></a>            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">pandas_to_sql</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">columns_to_types</span><span class="p">))</span>
</span><span id="Context.render-505"><a href="#Context.render-505"><span class="linenos">505</span></a>
</span><span id="Context.render-506"><a href="#Context.render-506"><span class="linenos">506</span></a>        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">render_query</span><span class="p">(</span>
</span><span id="Context.render-507"><a href="#Context.render-507"><span class="linenos">507</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context.render-508"><a href="#Context.render-508"><span class="linenos">508</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context.render-509"><a href="#Context.render-509"><span class="linenos">509</span></a>            <span class="n">latest</span><span class="o">=</span><span class="n">latest</span><span class="p">,</span>
</span><span id="Context.render-510"><a href="#Context.render-510"><span class="linenos">510</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context.render-511"><a href="#Context.render-511"><span class="linenos">511</span></a>            <span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">,</span>
</span><span id="Context.render-512"><a href="#Context.render-512"><span class="linenos">512</span></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="Context.render-513"><a href="#Context.render-513"><span class="linenos">513</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Renders a model's query, expanding macros with provided kwargs, and optionally expanding referenced models.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>model_or_snapshot:</strong>  The model, model name, or snapshot to render.</li>
<li><strong>start:</strong>  The start of the interval to render.</li>
<li><strong>end:</strong>  The end of the interval to render.</li>
<li><strong>latest:</strong>  The latest time used for non incremental datasets.</li>
<li><strong>expand:</strong>  Whether or not to use expand materialized models, defaults to False.
If True, all referenced models are expanded as raw queries.
If a list, only referenced models are expanded as raw queries.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The rendered expression.</p>
</blockquote>
</div>


                            </div>
                            <div id="Context.evaluate" class="classattr">
                                        <input id="Context.evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">model_or_snapshot</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">MagicMock</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;5983717744&#39;</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">) -> <span class="o">&lt;</span><span class="n">MagicMock</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;5983709952&#39;</span><span class="o">&gt;</span>:</span></span>

                <label class="view-source-button" for="Context.evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.evaluate-515"><a href="#Context.evaluate-515"><span class="linenos">515</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
</span><span id="Context.evaluate-516"><a href="#Context.evaluate-516"><span class="linenos">516</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.evaluate-517"><a href="#Context.evaluate-517"><span class="linenos">517</span></a>        <span class="n">model_or_snapshot</span><span class="p">:</span> <span class="n">ModelOrSnapshot</span><span class="p">,</span>
</span><span id="Context.evaluate-518"><a href="#Context.evaluate-518"><span class="linenos">518</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context.evaluate-519"><a href="#Context.evaluate-519"><span class="linenos">519</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context.evaluate-520"><a href="#Context.evaluate-520"><span class="linenos">520</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context.evaluate-521"><a href="#Context.evaluate-521"><span class="linenos">521</span></a>        <span class="n">limit</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.evaluate-522"><a href="#Context.evaluate-522"><span class="linenos">522</span></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
</span><span id="Context.evaluate-523"><a href="#Context.evaluate-523"><span class="linenos">523</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DF</span><span class="p">:</span>
</span><span id="Context.evaluate-524"><a href="#Context.evaluate-524"><span class="linenos">524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a model or snapshot (running its query against a DB/Engine).</span>
</span><span id="Context.evaluate-525"><a href="#Context.evaluate-525"><span class="linenos">525</span></a>
</span><span id="Context.evaluate-526"><a href="#Context.evaluate-526"><span class="linenos">526</span></a><span class="sd">        This method is used to test or iterate on models without side effects.</span>
</span><span id="Context.evaluate-527"><a href="#Context.evaluate-527"><span class="linenos">527</span></a>
</span><span id="Context.evaluate-528"><a href="#Context.evaluate-528"><span class="linenos">528</span></a><span class="sd">        Args:</span>
</span><span id="Context.evaluate-529"><a href="#Context.evaluate-529"><span class="linenos">529</span></a><span class="sd">            model_or_snapshot: The model, model name, or snapshot to render.</span>
</span><span id="Context.evaluate-530"><a href="#Context.evaluate-530"><span class="linenos">530</span></a><span class="sd">            start: The start of the interval to evaluate.</span>
</span><span id="Context.evaluate-531"><a href="#Context.evaluate-531"><span class="linenos">531</span></a><span class="sd">            end: The end of the interval to evaluate.</span>
</span><span id="Context.evaluate-532"><a href="#Context.evaluate-532"><span class="linenos">532</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context.evaluate-533"><a href="#Context.evaluate-533"><span class="linenos">533</span></a><span class="sd">            limit: A limit applied to the model.</span>
</span><span id="Context.evaluate-534"><a href="#Context.evaluate-534"><span class="linenos">534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.evaluate-535"><a href="#Context.evaluate-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Context.evaluate-536"><a href="#Context.evaluate-536"><span class="linenos">536</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="p">]</span>
</span><span id="Context.evaluate-537"><a href="#Context.evaluate-537"><span class="linenos">537</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_or_snapshot</span><span class="p">,</span> <span class="n">Snapshot</span><span class="p">):</span>
</span><span id="Context.evaluate-538"><a href="#Context.evaluate-538"><span class="linenos">538</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">model_or_snapshot</span>
</span><span id="Context.evaluate-539"><a href="#Context.evaluate-539"><span class="linenos">539</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Context.evaluate-540"><a href="#Context.evaluate-540"><span class="linenos">540</span></a>            <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model_or_snapshot</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</span><span id="Context.evaluate-541"><a href="#Context.evaluate-541"><span class="linenos">541</span></a>
</span><span id="Context.evaluate-542"><a href="#Context.evaluate-542"><span class="linenos">542</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
</span><span id="Context.evaluate-543"><a href="#Context.evaluate-543"><span class="linenos">543</span></a>            <span class="n">snapshot</span><span class="p">,</span>
</span><span id="Context.evaluate-544"><a href="#Context.evaluate-544"><span class="linenos">544</span></a>            <span class="n">start</span><span class="p">,</span>
</span><span id="Context.evaluate-545"><a href="#Context.evaluate-545"><span class="linenos">545</span></a>            <span class="n">end</span><span class="p">,</span>
</span><span id="Context.evaluate-546"><a href="#Context.evaluate-546"><span class="linenos">546</span></a>            <span class="n">latest</span><span class="p">,</span>
</span><span id="Context.evaluate-547"><a href="#Context.evaluate-547"><span class="linenos">547</span></a>            <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context.evaluate-548"><a href="#Context.evaluate-548"><span class="linenos">548</span></a>            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_MAX_LIMIT</span><span class="p">,</span>
</span><span id="Context.evaluate-549"><a href="#Context.evaluate-549"><span class="linenos">549</span></a>        <span class="p">)</span>
</span><span id="Context.evaluate-550"><a href="#Context.evaluate-550"><span class="linenos">550</span></a>
</span><span id="Context.evaluate-551"><a href="#Context.evaluate-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.evaluate-552"><a href="#Context.evaluate-552"><span class="linenos">552</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error evaluating </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Context.evaluate-553"><a href="#Context.evaluate-553"><span class="linenos">553</span></a>
</span><span id="Context.evaluate-554"><a href="#Context.evaluate-554"><span class="linenos">554</span></a>        <span class="k">return</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate a model or snapshot (running its query against a DB/Engine).</p>

<p>This method is used to test or iterate on models without side effects.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>model_or_snapshot:</strong>  The model, model name, or snapshot to render.</li>
<li><strong>start:</strong>  The start of the interval to evaluate.</li>
<li><strong>end:</strong>  The end of the interval to evaluate.</li>
<li><strong>latest:</strong>  The latest time used for non incremental datasets.</li>
<li><strong>limit:</strong>  A limit applied to the model.</li>
</ul>
</div>


                            </div>
                            <div id="Context.format" class="classattr">
                                        <input id="Context.format-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">format</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.format-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.format"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.format-556"><a href="#Context.format-556"><span class="linenos">556</span></a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.format-557"><a href="#Context.format-557"><span class="linenos">557</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Format all models in a given directory.&quot;&quot;&quot;</span>
</span><span id="Context.format-558"><a href="#Context.format-558"><span class="linenos">558</span></a>        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Context.format-559"><a href="#Context.format-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">is_sql</span><span class="p">:</span>
</span><span id="Context.format-560"><a href="#Context.format-560"><span class="linenos">560</span></a>                <span class="k">continue</span>
</span><span id="Context.format-561"><a href="#Context.format-561"><span class="linenos">561</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="s2">&quot;r+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Context.format-562"><a href="#Context.format-562"><span class="linenos">562</span></a>                <span class="n">expressions</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">default_dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">)</span>
</span><span id="Context.format-563"><a href="#Context.format-563"><span class="linenos">563</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Context.format-564"><a href="#Context.format-564"><span class="linenos">564</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format_model_expressions</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
</span><span id="Context.format-565"><a href="#Context.format-565"><span class="linenos">565</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Format all models in a given directory.</p>
</div>


                            </div>
                            <div id="Context.plan" class="classattr">
                                        <input id="Context.plan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plan</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">create_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">restate_models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">no_gaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">skip_backfill</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">forward_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">no_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">auto_apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">no_auto_categorization</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="plan/definition.html#Plan">sqlmesh.core.plan.definition.Plan</a></span>:</span></span>

                <label class="view-source-button" for="Context.plan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.plan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.plan-567"><a href="#Context.plan-567"><span class="linenos">567</span></a>    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span>
</span><span id="Context.plan-568"><a href="#Context.plan-568"><span class="linenos">568</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.plan-569"><a href="#Context.plan-569"><span class="linenos">569</span></a>        <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-570"><a href="#Context.plan-570"><span class="linenos">570</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context.plan-571"><a href="#Context.plan-571"><span class="linenos">571</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-572"><a href="#Context.plan-572"><span class="linenos">572</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-573"><a href="#Context.plan-573"><span class="linenos">573</span></a>        <span class="n">create_from</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-574"><a href="#Context.plan-574"><span class="linenos">574</span></a>        <span class="n">skip_tests</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-575"><a href="#Context.plan-575"><span class="linenos">575</span></a>        <span class="n">restate_models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-576"><a href="#Context.plan-576"><span class="linenos">576</span></a>        <span class="n">no_gaps</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-577"><a href="#Context.plan-577"><span class="linenos">577</span></a>        <span class="n">skip_backfill</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-578"><a href="#Context.plan-578"><span class="linenos">578</span></a>        <span class="n">forward_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-579"><a href="#Context.plan-579"><span class="linenos">579</span></a>        <span class="n">no_prompts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-580"><a href="#Context.plan-580"><span class="linenos">580</span></a>        <span class="n">auto_apply</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.plan-581"><a href="#Context.plan-581"><span class="linenos">581</span></a>        <span class="n">no_auto_categorization</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.plan-582"><a href="#Context.plan-582"><span class="linenos">582</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Plan</span><span class="p">:</span>
</span><span id="Context.plan-583"><a href="#Context.plan-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Interactively create a migration plan.</span>
</span><span id="Context.plan-584"><a href="#Context.plan-584"><span class="linenos">584</span></a>
</span><span id="Context.plan-585"><a href="#Context.plan-585"><span class="linenos">585</span></a><span class="sd">        This method compares the current context with an environment. It then presents</span>
</span><span id="Context.plan-586"><a href="#Context.plan-586"><span class="linenos">586</span></a><span class="sd">        the differences and asks whether to backfill each modified model.</span>
</span><span id="Context.plan-587"><a href="#Context.plan-587"><span class="linenos">587</span></a>
</span><span id="Context.plan-588"><a href="#Context.plan-588"><span class="linenos">588</span></a><span class="sd">        Args:</span>
</span><span id="Context.plan-589"><a href="#Context.plan-589"><span class="linenos">589</span></a><span class="sd">            environment: The environment to diff and plan against.</span>
</span><span id="Context.plan-590"><a href="#Context.plan-590"><span class="linenos">590</span></a><span class="sd">            start: The start date of the backfill if there is one.</span>
</span><span id="Context.plan-591"><a href="#Context.plan-591"><span class="linenos">591</span></a><span class="sd">            end: The end date of the backfill if there is one.</span>
</span><span id="Context.plan-592"><a href="#Context.plan-592"><span class="linenos">592</span></a><span class="sd">            create_from: The environment to create the target environment from if it</span>
</span><span id="Context.plan-593"><a href="#Context.plan-593"><span class="linenos">593</span></a><span class="sd">                doesn&#39;t exist. If not specified, the &quot;prod&quot; environment will be used.</span>
</span><span id="Context.plan-594"><a href="#Context.plan-594"><span class="linenos">594</span></a><span class="sd">            skip_tests: Unit tests are run by default so this will skip them if enabled</span>
</span><span id="Context.plan-595"><a href="#Context.plan-595"><span class="linenos">595</span></a><span class="sd">            restate_models: A list of of either internal or external models that need to be restated</span>
</span><span id="Context.plan-596"><a href="#Context.plan-596"><span class="linenos">596</span></a><span class="sd">                for the given plan interval. If the target environment is a production environment,</span>
</span><span id="Context.plan-597"><a href="#Context.plan-597"><span class="linenos">597</span></a><span class="sd">                ALL snapshots that depended on these upstream tables will have their intervals deleted</span>
</span><span id="Context.plan-598"><a href="#Context.plan-598"><span class="linenos">598</span></a><span class="sd">                (even ones not in this current environment). Only the snapshots in this environment will</span>
</span><span id="Context.plan-599"><a href="#Context.plan-599"><span class="linenos">599</span></a><span class="sd">                be backfilled whereas others need to be recovered on a future plan application. For development</span>
</span><span id="Context.plan-600"><a href="#Context.plan-600"><span class="linenos">600</span></a><span class="sd">                environments only snapshots that are part of this plan will be affected.</span>
</span><span id="Context.plan-601"><a href="#Context.plan-601"><span class="linenos">601</span></a><span class="sd">            no_gaps:  Whether to ensure that new snapshots for models that are already a</span>
</span><span id="Context.plan-602"><a href="#Context.plan-602"><span class="linenos">602</span></a><span class="sd">                part of the target environment have no data gaps when compared against previous</span>
</span><span id="Context.plan-603"><a href="#Context.plan-603"><span class="linenos">603</span></a><span class="sd">                snapshots for same models.</span>
</span><span id="Context.plan-604"><a href="#Context.plan-604"><span class="linenos">604</span></a><span class="sd">            skip_backfill: Whether to skip the backfill step. Default: False.</span>
</span><span id="Context.plan-605"><a href="#Context.plan-605"><span class="linenos">605</span></a><span class="sd">            forward_only: Whether the purpose of the plan is to make forward only changes.</span>
</span><span id="Context.plan-606"><a href="#Context.plan-606"><span class="linenos">606</span></a><span class="sd">            no_prompts: Whether to disable interactive prompts for the backfill time range. Please note that</span>
</span><span id="Context.plan-607"><a href="#Context.plan-607"><span class="linenos">607</span></a><span class="sd">                if this flag is set to true and there are uncategorized changes the plan creation will</span>
</span><span id="Context.plan-608"><a href="#Context.plan-608"><span class="linenos">608</span></a><span class="sd">                fail. Default: False.</span>
</span><span id="Context.plan-609"><a href="#Context.plan-609"><span class="linenos">609</span></a><span class="sd">            auto_apply: Whether to automatically apply the new plan after creation. Default: False.</span>
</span><span id="Context.plan-610"><a href="#Context.plan-610"><span class="linenos">610</span></a><span class="sd">            no_auto_categorization: Indicates whether to disable automatic categorization of model</span>
</span><span id="Context.plan-611"><a href="#Context.plan-611"><span class="linenos">611</span></a><span class="sd">                changes (breaking / non-breaking). If not provided, then the corresponding configuration</span>
</span><span id="Context.plan-612"><a href="#Context.plan-612"><span class="linenos">612</span></a><span class="sd">                option determines the behavior.</span>
</span><span id="Context.plan-613"><a href="#Context.plan-613"><span class="linenos">613</span></a>
</span><span id="Context.plan-614"><a href="#Context.plan-614"><span class="linenos">614</span></a><span class="sd">        Returns:</span>
</span><span id="Context.plan-615"><a href="#Context.plan-615"><span class="linenos">615</span></a><span class="sd">            The populated Plan object.</span>
</span><span id="Context.plan-616"><a href="#Context.plan-616"><span class="linenos">616</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.plan-617"><a href="#Context.plan-617"><span class="linenos">617</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="Context.plan-618"><a href="#Context.plan-618"><span class="linenos">618</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context.plan-619"><a href="#Context.plan-619"><span class="linenos">619</span></a>
</span><span id="Context.plan-620"><a href="#Context.plan-620"><span class="linenos">620</span></a>        <span class="k">if</span> <span class="n">skip_backfill</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_gaps</span> <span class="ow">and</span> <span class="n">environment</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">:</span>
</span><span id="Context.plan-621"><a href="#Context.plan-621"><span class="linenos">621</span></a>            <span class="k">raise</span> <span class="n">ConfigError</span><span class="p">(</span>
</span><span id="Context.plan-622"><a href="#Context.plan-622"><span class="linenos">622</span></a>                <span class="s2">&quot;When targeting the production enviornment either the backfill should not be skipped or the lack of data gaps should be enforced (--no-gaps flag).&quot;</span>
</span><span id="Context.plan-623"><a href="#Context.plan-623"><span class="linenos">623</span></a>            <span class="p">)</span>
</span><span id="Context.plan-624"><a href="#Context.plan-624"><span class="linenos">624</span></a>
</span><span id="Context.plan-625"><a href="#Context.plan-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_run_plan_tests</span><span class="p">(</span><span class="n">skip_tests</span><span class="p">)</span>
</span><span id="Context.plan-626"><a href="#Context.plan-626"><span class="linenos">626</span></a>
</span><span id="Context.plan-627"><a href="#Context.plan-627"><span class="linenos">627</span></a>        <span class="n">plan</span> <span class="o">=</span> <span class="n">Plan</span><span class="p">(</span>
</span><span id="Context.plan-628"><a href="#Context.plan-628"><span class="linenos">628</span></a>            <span class="n">context_diff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span> <span class="n">create_from</span><span class="o">=</span><span class="n">create_from</span><span class="p">),</span>
</span><span id="Context.plan-629"><a href="#Context.plan-629"><span class="linenos">629</span></a>            <span class="n">dag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="p">,</span>
</span><span id="Context.plan-630"><a href="#Context.plan-630"><span class="linenos">630</span></a>            <span class="n">state_reader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_reader</span><span class="p">,</span>
</span><span id="Context.plan-631"><a href="#Context.plan-631"><span class="linenos">631</span></a>            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context.plan-632"><a href="#Context.plan-632"><span class="linenos">632</span></a>            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context.plan-633"><a href="#Context.plan-633"><span class="linenos">633</span></a>            <span class="n">apply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span>
</span><span id="Context.plan-634"><a href="#Context.plan-634"><span class="linenos">634</span></a>            <span class="n">restate_models</span><span class="o">=</span><span class="n">restate_models</span><span class="p">,</span>
</span><span id="Context.plan-635"><a href="#Context.plan-635"><span class="linenos">635</span></a>            <span class="n">no_gaps</span><span class="o">=</span><span class="n">no_gaps</span><span class="p">,</span>
</span><span id="Context.plan-636"><a href="#Context.plan-636"><span class="linenos">636</span></a>            <span class="n">skip_backfill</span><span class="o">=</span><span class="n">skip_backfill</span><span class="p">,</span>
</span><span id="Context.plan-637"><a href="#Context.plan-637"><span class="linenos">637</span></a>            <span class="n">is_dev</span><span class="o">=</span><span class="n">environment</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">,</span>
</span><span id="Context.plan-638"><a href="#Context.plan-638"><span class="linenos">638</span></a>            <span class="n">forward_only</span><span class="o">=</span><span class="n">forward_only</span><span class="p">,</span>
</span><span id="Context.plan-639"><a href="#Context.plan-639"><span class="linenos">639</span></a>            <span class="n">environment_ttl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">environment_ttl</span><span class="p">,</span>
</span><span id="Context.plan-640"><a href="#Context.plan-640"><span class="linenos">640</span></a>            <span class="n">categorizer_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">auto_categorize_changes</span><span class="p">,</span>
</span><span id="Context.plan-641"><a href="#Context.plan-641"><span class="linenos">641</span></a>            <span class="n">auto_categorization_enabled</span><span class="o">=</span><span class="ow">not</span> <span class="n">no_auto_categorization</span><span class="p">,</span>
</span><span id="Context.plan-642"><a href="#Context.plan-642"><span class="linenos">642</span></a>        <span class="p">)</span>
</span><span id="Context.plan-643"><a href="#Context.plan-643"><span class="linenos">643</span></a>
</span><span id="Context.plan-644"><a href="#Context.plan-644"><span class="linenos">644</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_prompts</span><span class="p">:</span>
</span><span id="Context.plan-645"><a href="#Context.plan-645"><span class="linenos">645</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">auto_apply</span><span class="p">)</span>
</span><span id="Context.plan-646"><a href="#Context.plan-646"><span class="linenos">646</span></a>        <span class="k">elif</span> <span class="n">auto_apply</span><span class="p">:</span>
</span><span id="Context.plan-647"><a href="#Context.plan-647"><span class="linenos">647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span id="Context.plan-648"><a href="#Context.plan-648"><span class="linenos">648</span></a>
</span><span id="Context.plan-649"><a href="#Context.plan-649"><span class="linenos">649</span></a>        <span class="k">return</span> <span class="n">plan</span>
</span></pre></div>


            <div class="docstring"><p>Interactively create a migration plan.</p>

<p>This method compares the current context with an environment. It then presents
the differences and asks whether to backfill each modified model.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>environment:</strong>  The environment to diff and plan against.</li>
<li><strong>start:</strong>  The start date of the backfill if there is one.</li>
<li><strong>end:</strong>  The end date of the backfill if there is one.</li>
<li><strong>create_from:</strong>  The environment to create the target environment from if it
doesn't exist. If not specified, the "prod" environment will be used.</li>
<li><strong>skip_tests:</strong>  Unit tests are run by default so this will skip them if enabled</li>
<li><strong>restate_models:</strong>  A list of of either internal or external models that need to be restated
for the given plan interval. If the target environment is a production environment,
ALL snapshots that depended on these upstream tables will have their intervals deleted
(even ones not in this current environment). Only the snapshots in this environment will
be backfilled whereas others need to be recovered on a future plan application. For development
environments only snapshots that are part of this plan will be affected.</li>
<li><strong>no_gaps:</strong>   Whether to ensure that new snapshots for models that are already a
part of the target environment have no data gaps when compared against previous
snapshots for same models.</li>
<li><strong>skip_backfill:</strong>  Whether to skip the backfill step. Default: False.</li>
<li><strong>forward_only:</strong>  Whether the purpose of the plan is to make forward only changes.</li>
<li><strong>no_prompts:</strong>  Whether to disable interactive prompts for the backfill time range. Please note that
if this flag is set to true and there are uncategorized changes the plan creation will
fail. Default: False.</li>
<li><strong>auto_apply:</strong>  Whether to automatically apply the new plan after creation. Default: False.</li>
<li><strong>no_auto_categorization:</strong>  Indicates whether to disable automatic categorization of model
changes (breaking / non-breaking). If not provided, then the corresponding configuration
option determines the behavior.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The populated Plan object.</p>
</blockquote>
</div>


                            </div>
                            <div id="Context.apply" class="classattr">
                                        <input id="Context.apply-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">apply</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">plan</span><span class="p">:</span> <span class="n"><a href="plan/definition.html#Plan">sqlmesh.core.plan.definition.Plan</a></span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.apply-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.apply"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.apply-651"><a href="#Context.apply-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="n">Plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.apply-652"><a href="#Context.apply-652"><span class="linenos">652</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies a plan by pushing snapshots and backfilling data.</span>
</span><span id="Context.apply-653"><a href="#Context.apply-653"><span class="linenos">653</span></a>
</span><span id="Context.apply-654"><a href="#Context.apply-654"><span class="linenos">654</span></a><span class="sd">        Given a plan, it pushes snapshots into the state sync and then uses the scheduler</span>
</span><span id="Context.apply-655"><a href="#Context.apply-655"><span class="linenos">655</span></a><span class="sd">        to backfill all models.</span>
</span><span id="Context.apply-656"><a href="#Context.apply-656"><span class="linenos">656</span></a>
</span><span id="Context.apply-657"><a href="#Context.apply-657"><span class="linenos">657</span></a><span class="sd">        Args:</span>
</span><span id="Context.apply-658"><a href="#Context.apply-658"><span class="linenos">658</span></a><span class="sd">            plan: The plan to apply.</span>
</span><span id="Context.apply-659"><a href="#Context.apply-659"><span class="linenos">659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.apply-660"><a href="#Context.apply-660"><span class="linenos">660</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">context_diff</span><span class="o">.</span><span class="n">has_changes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plan</span><span class="o">.</span><span class="n">requires_backfill</span><span class="p">:</span>
</span><span id="Context.apply-661"><a href="#Context.apply-661"><span class="linenos">661</span></a>            <span class="k">return</span>
</span><span id="Context.apply-662"><a href="#Context.apply-662"><span class="linenos">662</span></a>        <span class="k">if</span> <span class="n">plan</span><span class="o">.</span><span class="n">uncategorized</span><span class="p">:</span>
</span><span id="Context.apply-663"><a href="#Context.apply-663"><span class="linenos">663</span></a>            <span class="k">raise</span> <span class="n">PlanError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t apply a plan with uncategorized changes.&quot;</span><span class="p">)</span>
</span><span id="Context.apply-664"><a href="#Context.apply-664"><span class="linenos">664</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">create_plan_evaluator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Applies a plan by pushing snapshots and backfilling data.</p>

<p>Given a plan, it pushes snapshots into the state sync and then uses the scheduler
to backfill all models.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>plan:</strong>  The plan to apply.</li>
</ul>
</div>


                            </div>
                            <div id="Context.diff" class="classattr">
                                        <input id="Context.diff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">diff</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">environment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.diff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.diff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.diff-666"><a href="#Context.diff-666"><span class="linenos">666</span></a>    <span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detailed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.diff-667"><a href="#Context.diff-667"><span class="linenos">667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Show a diff of the current context with a given environment.</span>
</span><span id="Context.diff-668"><a href="#Context.diff-668"><span class="linenos">668</span></a>
</span><span id="Context.diff-669"><a href="#Context.diff-669"><span class="linenos">669</span></a><span class="sd">        Args:</span>
</span><span id="Context.diff-670"><a href="#Context.diff-670"><span class="linenos">670</span></a><span class="sd">            environment: The environment to diff against.</span>
</span><span id="Context.diff-671"><a href="#Context.diff-671"><span class="linenos">671</span></a><span class="sd">            detailed: Show the actual SQL differences if True.</span>
</span><span id="Context.diff-672"><a href="#Context.diff-672"><span class="linenos">672</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.diff-673"><a href="#Context.diff-673"><span class="linenos">673</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span>
</span><span id="Context.diff-674"><a href="#Context.diff-674"><span class="linenos">674</span></a>        <span class="n">environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
</span><span id="Context.diff-675"><a href="#Context.diff-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_model_difference_summary</span><span class="p">(</span>
</span><span id="Context.diff-676"><a href="#Context.diff-676"><span class="linenos">676</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_context_diff</span><span class="p">(</span><span class="n">environment</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">PROD</span><span class="p">),</span> <span class="n">detailed</span>
</span><span id="Context.diff-677"><a href="#Context.diff-677"><span class="linenos">677</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Show a diff of the current context with a given environment.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>environment:</strong>  The environment to diff against.</li>
<li><strong>detailed:</strong>  Show the actual SQL differences if True.</li>
</ul>
</div>


                            </div>
                            <div id="Context.get_dag" class="classattr">
                                        <input id="Context.get_dag-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_dag</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;svg&#39;</span></span><span class="return-annotation">) -> <span class="n">graphviz</span><span class="o">.</span><span class="n">graphs</span><span class="o">.</span><span class="n">Digraph</span>:</span></span>

                <label class="view-source-button" for="Context.get_dag-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.get_dag"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.get_dag-679"><a href="#Context.get_dag-679"><span class="linenos">679</span></a>    <span class="k">def</span> <span class="nf">get_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;svg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">:</span>
</span><span id="Context.get_dag-680"><a href="#Context.get_dag-680"><span class="linenos">680</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets a graphviz dag.</span>
</span><span id="Context.get_dag-681"><a href="#Context.get_dag-681"><span class="linenos">681</span></a>
</span><span id="Context.get_dag-682"><a href="#Context.get_dag-682"><span class="linenos">682</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="Context.get_dag-683"><a href="#Context.get_dag-683"><span class="linenos">683</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="Context.get_dag-684"><a href="#Context.get_dag-684"><span class="linenos">684</span></a>
</span><span id="Context.get_dag-685"><a href="#Context.get_dag-685"><span class="linenos">685</span></a><span class="sd">        To display within Databricks:</span>
</span><span id="Context.get_dag-686"><a href="#Context.get_dag-686"><span class="linenos">686</span></a><span class="sd">        displayHTML(context.get_dag().pipe(encoding=&#39;utf-8&#39;))</span>
</span><span id="Context.get_dag-687"><a href="#Context.get_dag-687"><span class="linenos">687</span></a>
</span><span id="Context.get_dag-688"><a href="#Context.get_dag-688"><span class="linenos">688</span></a><span class="sd">        Args:</span>
</span><span id="Context.get_dag-689"><a href="#Context.get_dag-689"><span class="linenos">689</span></a><span class="sd">            format: The desired format to use for representing the graph</span>
</span><span id="Context.get_dag-690"><a href="#Context.get_dag-690"><span class="linenos">690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.get_dag-691"><a href="#Context.get_dag-691"><span class="linenos">691</span></a>        <span class="kn">from</span> <span class="nn">sqlmesh</span> <span class="kn">import</span> <span class="n">runtime_env</span>
</span><span id="Context.get_dag-692"><a href="#Context.get_dag-692"><span class="linenos">692</span></a>
</span><span id="Context.get_dag-693"><a href="#Context.get_dag-693"><span class="linenos">693</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context.get_dag-694"><a href="#Context.get_dag-694"><span class="linenos">694</span></a>            <span class="kn">import</span> <span class="nn">graphviz</span>  <span class="c1"># type: ignore</span>
</span><span id="Context.get_dag-695"><a href="#Context.get_dag-695"><span class="linenos">695</span></a>        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Context.get_dag-696"><a href="#Context.get_dag-696"><span class="linenos">696</span></a>            <span class="k">if</span> <span class="n">runtime_env</span><span class="o">.</span><span class="n">is_databricks</span><span class="p">:</span>
</span><span id="Context.get_dag-697"><a href="#Context.get_dag-697"><span class="linenos">697</span></a>                <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context.get_dag-698"><a href="#Context.get_dag-698"><span class="linenos">698</span></a>                    <span class="s2">&quot;Rendering a dag requires graphviz. Run `pip install graphviz` and then `sudo apt-get install -y python3-dev graphviz libgraphviz-dev pkg-config`&quot;</span>
</span><span id="Context.get_dag-699"><a href="#Context.get_dag-699"><span class="linenos">699</span></a>                <span class="p">)</span>
</span><span id="Context.get_dag-700"><a href="#Context.get_dag-700"><span class="linenos">700</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context.get_dag-701"><a href="#Context.get_dag-701"><span class="linenos">701</span></a>                <span class="s2">&quot;Rendering a dag requires a manual install of graphviz. Run `pip install graphviz` and then install graphviz library: https://graphviz.org/download/.&quot;</span>
</span><span id="Context.get_dag-702"><a href="#Context.get_dag-702"><span class="linenos">702</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span><span id="Context.get_dag-703"><a href="#Context.get_dag-703"><span class="linenos">703</span></a>
</span><span id="Context.get_dag-704"><a href="#Context.get_dag-704"><span class="linenos">704</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">node_attr</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;box&quot;</span><span class="p">},</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context.get_dag-705"><a href="#Context.get_dag-705"><span class="linenos">705</span></a>
</span><span id="Context.get_dag-706"><a href="#Context.get_dag-706"><span class="linenos">706</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">upstream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Context.get_dag-707"><a href="#Context.get_dag-707"><span class="linenos">707</span></a>            <span class="n">graph</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="Context.get_dag-708"><a href="#Context.get_dag-708"><span class="linenos">708</span></a>            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upstream</span><span class="p">:</span>
</span><span id="Context.get_dag-709"><a href="#Context.get_dag-709"><span class="linenos">709</span></a>                <span class="n">graph</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="Context.get_dag-710"><a href="#Context.get_dag-710"><span class="linenos">710</span></a>        <span class="k">return</span> <span class="n">graph</span>
</span></pre></div>


            <div class="docstring"><p>Gets a graphviz dag.</p>

<p>This method requires installing the graphviz base library through your package manager
and the python graphviz library.</p>

<p>To display within Databricks:
displayHTML(context.get_dag().pipe(encoding='utf-8'))</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>format:</strong>  The desired format to use for representing the graph</li>
</ul>
</div>


                            </div>
                            <div id="Context.render_dag" class="classattr">
                                        <input id="Context.render_dag-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">render_dag</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;jpeg&#39;</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Context.render_dag-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.render_dag"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.render_dag-712"><a href="#Context.render_dag-712"><span class="linenos">712</span></a>    <span class="k">def</span> <span class="nf">render_dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Context.render_dag-713"><a href="#Context.render_dag-713"><span class="linenos">713</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Render the dag using graphviz.</span>
</span><span id="Context.render_dag-714"><a href="#Context.render_dag-714"><span class="linenos">714</span></a>
</span><span id="Context.render_dag-715"><a href="#Context.render_dag-715"><span class="linenos">715</span></a><span class="sd">        This method requires installing the graphviz base library through your package manager</span>
</span><span id="Context.render_dag-716"><a href="#Context.render_dag-716"><span class="linenos">716</span></a><span class="sd">        and the python graphviz library.</span>
</span><span id="Context.render_dag-717"><a href="#Context.render_dag-717"><span class="linenos">717</span></a>
</span><span id="Context.render_dag-718"><a href="#Context.render_dag-718"><span class="linenos">718</span></a><span class="sd">        Args:</span>
</span><span id="Context.render_dag-719"><a href="#Context.render_dag-719"><span class="linenos">719</span></a><span class="sd">            path: filename to save the dag to</span>
</span><span id="Context.render_dag-720"><a href="#Context.render_dag-720"><span class="linenos">720</span></a><span class="sd">            format: The desired format to use when rending the dag</span>
</span><span id="Context.render_dag-721"><a href="#Context.render_dag-721"><span class="linenos">721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.render_dag-722"><a href="#Context.render_dag-722"><span class="linenos">722</span></a>        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dag</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context.render_dag-723"><a href="#Context.render_dag-723"><span class="linenos">723</span></a>
</span><span id="Context.render_dag-724"><a href="#Context.render_dag-724"><span class="linenos">724</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context.render_dag-725"><a href="#Context.render_dag-725"><span class="linenos">725</span></a>            <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
</span><span id="Context.render_dag-726"><a href="#Context.render_dag-726"><span class="linenos">726</span></a>        <span class="k">except</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">execute</span><span class="o">.</span><span class="n">ExecutableNotFound</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Context.render_dag-727"><a href="#Context.render_dag-727"><span class="linenos">727</span></a>            <span class="k">raise</span> <span class="n">MissingDependencyError</span><span class="p">(</span>
</span><span id="Context.render_dag-728"><a href="#Context.render_dag-728"><span class="linenos">728</span></a>                <span class="s2">&quot;Graphviz is pip-installed but the system install is missing. Instructions: https://graphviz.org/download/&quot;</span>
</span><span id="Context.render_dag-729"><a href="#Context.render_dag-729"><span class="linenos">729</span></a>            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</span></pre></div>


            <div class="docstring"><p>Render the dag using graphviz.</p>

<p>This method requires installing the graphviz base library through your package manager
and the python graphviz library.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>path:</strong>  filename to save the dag to</li>
<li><strong>format:</strong>  The desired format to use when rending the dag</li>
</ul>
</div>


                            </div>
                            <div id="Context.test" class="classattr">
                                        <input id="Context.test-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">match_patterns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">tests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span>:</span></span>

                <label class="view-source-button" for="Context.test-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.test"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.test-731"><a href="#Context.test-731"><span class="linenos">731</span></a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span>
</span><span id="Context.test-732"><a href="#Context.test-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.test-733"><a href="#Context.test-733"><span class="linenos">733</span></a>        <span class="n">match_patterns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.test-734"><a href="#Context.test-734"><span class="linenos">734</span></a>        <span class="n">tests</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.test-735"><a href="#Context.test-735"><span class="linenos">735</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Context.test-736"><a href="#Context.test-736"><span class="linenos">736</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unittest</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">TestResult</span><span class="p">:</span>
</span><span id="Context.test-737"><a href="#Context.test-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover and run model tests&quot;&quot;&quot;</span>
</span><span id="Context.test-738"><a href="#Context.test-738"><span class="linenos">738</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="Context.test-739"><a href="#Context.test-739"><span class="linenos">739</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Context.test-740"><a href="#Context.test-740"><span class="linenos">740</span></a>            <span class="k">if</span> <span class="n">tests</span><span class="p">:</span>
</span><span id="Context.test-741"><a href="#Context.test-741"><span class="linenos">741</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_model_tests</span><span class="p">(</span>
</span><span id="Context.test-742"><a href="#Context.test-742"><span class="linenos">742</span></a>                    <span class="n">tests</span><span class="o">=</span><span class="n">tests</span><span class="p">,</span>
</span><span id="Context.test-743"><a href="#Context.test-743"><span class="linenos">743</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="Context.test-744"><a href="#Context.test-744"><span class="linenos">744</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="Context.test-745"><a href="#Context.test-745"><span class="linenos">745</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="Context.test-746"><a href="#Context.test-746"><span class="linenos">746</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="Context.test-747"><a href="#Context.test-747"><span class="linenos">747</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="Context.test-748"><a href="#Context.test-748"><span class="linenos">748</span></a>                <span class="p">)</span>
</span><span id="Context.test-749"><a href="#Context.test-749"><span class="linenos">749</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Context.test-750"><a href="#Context.test-750"><span class="linenos">750</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">run_all_model_tests</span><span class="p">(</span>
</span><span id="Context.test-751"><a href="#Context.test-751"><span class="linenos">751</span></a>                    <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_directory_path</span><span class="p">,</span>
</span><span id="Context.test-752"><a href="#Context.test-752"><span class="linenos">752</span></a>                    <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_snapshots</span><span class="p">,</span>
</span><span id="Context.test-753"><a href="#Context.test-753"><span class="linenos">753</span></a>                    <span class="n">engine_adapter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="p">,</span>
</span><span id="Context.test-754"><a href="#Context.test-754"><span class="linenos">754</span></a>                    <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
</span><span id="Context.test-755"><a href="#Context.test-755"><span class="linenos">755</span></a>                    <span class="n">patterns</span><span class="o">=</span><span class="n">match_patterns</span><span class="p">,</span>
</span><span id="Context.test-756"><a href="#Context.test-756"><span class="linenos">756</span></a>                    <span class="n">ignore_patterns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">,</span>
</span><span id="Context.test-757"><a href="#Context.test-757"><span class="linenos">757</span></a>                <span class="p">)</span>
</span><span id="Context.test-758"><a href="#Context.test-758"><span class="linenos">758</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="Context.test-759"><a href="#Context.test-759"><span class="linenos">759</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_test_engine_adapter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Context.test-760"><a href="#Context.test-760"><span class="linenos">760</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Discover and run model tests</p>
</div>


                            </div>
                            <div id="Context.audit" class="classattr">
                                        <input id="Context.audit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">audit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">models</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">latest</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.audit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.audit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.audit-762"><a href="#Context.audit-762"><span class="linenos">762</span></a>    <span class="k">def</span> <span class="nf">audit</span><span class="p">(</span>
</span><span id="Context.audit-763"><a href="#Context.audit-763"><span class="linenos">763</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Context.audit-764"><a href="#Context.audit-764"><span class="linenos">764</span></a>        <span class="n">start</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context.audit-765"><a href="#Context.audit-765"><span class="linenos">765</span></a>        <span class="n">end</span><span class="p">:</span> <span class="n">TimeLike</span><span class="p">,</span>
</span><span id="Context.audit-766"><a href="#Context.audit-766"><span class="linenos">766</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Context.audit-767"><a href="#Context.audit-767"><span class="linenos">767</span></a>        <span class="n">models</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.audit-768"><a href="#Context.audit-768"><span class="linenos">768</span></a>        <span class="n">latest</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">TimeLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Context.audit-769"><a href="#Context.audit-769"><span class="linenos">769</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.audit-770"><a href="#Context.audit-770"><span class="linenos">770</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Audit models.</span>
</span><span id="Context.audit-771"><a href="#Context.audit-771"><span class="linenos">771</span></a>
</span><span id="Context.audit-772"><a href="#Context.audit-772"><span class="linenos">772</span></a><span class="sd">        Args:</span>
</span><span id="Context.audit-773"><a href="#Context.audit-773"><span class="linenos">773</span></a><span class="sd">            start: The start of the interval to audit.</span>
</span><span id="Context.audit-774"><a href="#Context.audit-774"><span class="linenos">774</span></a><span class="sd">            end: The end of the interval to audit.</span>
</span><span id="Context.audit-775"><a href="#Context.audit-775"><span class="linenos">775</span></a><span class="sd">            models: The models to audit. All models will be audited if not specified.</span>
</span><span id="Context.audit-776"><a href="#Context.audit-776"><span class="linenos">776</span></a><span class="sd">            latest: The latest time used for non incremental datasets.</span>
</span><span id="Context.audit-777"><a href="#Context.audit-777"><span class="linenos">777</span></a>
</span><span id="Context.audit-778"><a href="#Context.audit-778"><span class="linenos">778</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Context.audit-779"><a href="#Context.audit-779"><span class="linenos">779</span></a>
</span><span id="Context.audit-780"><a href="#Context.audit-780"><span class="linenos">780</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Context.audit-781"><a href="#Context.audit-781"><span class="linenos">781</span></a>            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span> <span class="k">if</span> <span class="n">models</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Context.audit-782"><a href="#Context.audit-782"><span class="linenos">782</span></a>        <span class="p">)</span>
</span><span id="Context.audit-783"><a href="#Context.audit-783"><span class="linenos">783</span></a>
</span><span id="Context.audit-784"><a href="#Context.audit-784"><span class="linenos">784</span></a>        <span class="n">num_audits</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">audits</span><span class="p">)</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">)</span>
</span><span id="Context.audit-785"><a href="#Context.audit-785"><span class="linenos">785</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">num_audits</span><span class="si">}</span><span class="s2"> audit(s).&quot;</span><span class="p">)</span>
</span><span id="Context.audit-786"><a href="#Context.audit-786"><span class="linenos">786</span></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Context.audit-787"><a href="#Context.audit-787"><span class="linenos">787</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="Context.audit-788"><a href="#Context.audit-788"><span class="linenos">788</span></a>            <span class="k">for</span> <span class="n">audit_result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
</span><span id="Context.audit-789"><a href="#Context.audit-789"><span class="linenos">789</span></a>                <span class="n">snapshot</span><span class="o">=</span><span class="n">snapshot</span><span class="p">,</span>
</span><span id="Context.audit-790"><a href="#Context.audit-790"><span class="linenos">790</span></a>                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
</span><span id="Context.audit-791"><a href="#Context.audit-791"><span class="linenos">791</span></a>                <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
</span><span id="Context.audit-792"><a href="#Context.audit-792"><span class="linenos">792</span></a>                <span class="n">snapshots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshots</span><span class="p">,</span>
</span><span id="Context.audit-793"><a href="#Context.audit-793"><span class="linenos">793</span></a>                <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Context.audit-794"><a href="#Context.audit-794"><span class="linenos">794</span></a>            <span class="p">):</span>
</span><span id="Context.audit-795"><a href="#Context.audit-795"><span class="linenos">795</span></a>                <span class="k">if</span> <span class="n">audit_result</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
</span><span id="Context.audit-796"><a href="#Context.audit-796"><span class="linenos">796</span></a>                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audit_result</span><span class="p">)</span>
</span><span id="Context.audit-797"><a href="#Context.audit-797"><span class="linenos">797</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> FAIL.&quot;</span><span class="p">)</span>
</span><span id="Context.audit-798"><a href="#Context.audit-798"><span class="linenos">798</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Context.audit-799"><a href="#Context.audit-799"><span class="linenos">799</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">audit_result</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> PASS.&quot;</span><span class="p">)</span>
</span><span id="Context.audit-800"><a href="#Context.audit-800"><span class="linenos">800</span></a>
</span><span id="Context.audit-801"><a href="#Context.audit-801"><span class="linenos">801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> audit error(s).&quot;</span><span class="p">)</span>
</span><span id="Context.audit-802"><a href="#Context.audit-802"><span class="linenos">802</span></a>        <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
</span><span id="Context.audit-803"><a href="#Context.audit-803"><span class="linenos">803</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span>
</span><span id="Context.audit-804"><a href="#Context.audit-804"><span class="linenos">804</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failure in audit </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">audit</span><span class="o">.</span><span class="n">_path</span><span class="si">}</span><span class="s2">).&quot;</span>
</span><span id="Context.audit-805"><a href="#Context.audit-805"><span class="linenos">805</span></a>            <span class="p">)</span>
</span><span id="Context.audit-806"><a href="#Context.audit-806"><span class="linenos">806</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> results, expected 0.&quot;</span><span class="p">)</span>
</span><span id="Context.audit-807"><a href="#Context.audit-807"><span class="linenos">807</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">show_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Context.audit-808"><a href="#Context.audit-808"><span class="linenos">808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log_status_update</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Audit models.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>start:</strong>  The start of the interval to audit.</li>
<li><strong>end:</strong>  The end of the interval to audit.</li>
<li><strong>models:</strong>  The models to audit. All models will be audited if not specified.</li>
<li><strong>latest:</strong>  The latest time used for non incremental datasets.</li>
</ul>
</div>


                            </div>
                            <div id="Context.close" class="classattr">
                                        <input id="Context.close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">close</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="Context.close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Context.close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Context.close-810"><a href="#Context.close-810"><span class="linenos">810</span></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Context.close-811"><a href="#Context.close-811"><span class="linenos">811</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Releases all resources allocated by this context.&quot;&quot;&quot;</span>
</span><span id="Context.close-812"><a href="#Context.close-812"><span class="linenos">812</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_evaluator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Releases all resources allocated by this context.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseContext">BaseContext</a></dt>
                                <dd id="Context.spark" class="variable"><a href="#BaseContext.spark">spark</a></dd>
                <dd id="Context.table" class="function"><a href="#BaseContext.table">table</a></dd>
                <dd id="Context.fetchdf" class="function"><a href="#BaseContext.fetchdf">fetchdf</a></dd>
                <dd id="Context.fetch_pyspark_df" class="function"><a href="#BaseContext.fetch_pyspark_df">fetch_pyspark_df</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>